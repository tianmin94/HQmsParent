<#include "../include/header.html">

<style>
	.labelA {width: 135px;text-align: right;}
	.texthidde {white-space:nowrap;width:12em;overflow:hidden;text-overflow:ellipsis;}
</style>
<style>
	div[role=tooltip].k-tooltip{
		padding: 2px;
		background: #5c9acf;
	}
	.k-tooltip-content{
		padding: 4px;
		text-align: left;
		background: #fff;
		color: #666;
	}
	.k-callout {
		border-bottom-color: #5c9acf;
	}
</style>
<script src="${base.contextPath}/common/code?YES_NO=SYS.YES_NO" type="text/javascript"></script>
<script src="${base.contextPath}/common/code?NPI_METERING_COUNT=NPI_METERING_COUNT"></script>
<script src="${base.contextPath}/common/code?NPI_ROUTE_LINE=NPI_ROUTE_LINE"></script>
<script src="${base.contextPath}/common/code?NPI_ROUTE_EQUIP_STATUS=NPI_ROUTE_EQUIP_STATUS"></script>

<script type="text/javascript">
	function otherVali(){
		if(viewModel.model.inOutMake == undefined){
			kendo.ui.showWarningDialog({
				message: "内制/外制未选择！"
			});
			return false;
		}
		if(viewModel.model.lineType == undefined){
			kendo.ui.showWarningDialog({
				message: "主线/辅线未选择！"
			});
			return false;
		}
		if(viewModel.model.autoFlag == undefined){
			kendo.ui.showWarningDialog({
				message: "自动/手动未选择！"
			});
			return false;
		}
		return true;
	}
	
	var BaseUrl = _basePath;
	var routeNumber = '${RequestParameters.routeNumber!0}';
	var routeVersion = '${RequestParameters.routeVersion!0}';
	var sku = '${RequestParameters.sku!0}';
	var pspecData = [];
    var viewModel = Hap.createGridViewModel(null,{
    	model:{
    		'routeNumber':routeNumber,
    		'routeVersion':routeVersion,
    	},
    	closeWin:function(e) {
    		window.parent.$("#newWpWindow").data("kendoWindow").close();
    	},
		save:function(){
			var validator = $("#mainForm").data("kendoValidator");
    		if(validator.validate()&&otherVali()) {
    			//return;
    		}else{
    			return;
    		}
    		viewModel.model.__status = 'add';
    		viewModel.model.sku = sku;
    		var headData = viewModelComposeHead.model.toJSON();
    		viewModel.model.matList = $("#matGrid").data("kendoGrid").dataSource._data;
    		viewModel.model.staDetail = headData;
            /* Hap.submitForm({
                url: '${base.contextPath}/npi/technology/working/procedure/addData',
                formModel: viewModel.model,
                grid: {"matList": $("#matGrid"),"staDetail":kendo.stringify(headData)},
                success: function (data) {
                	viewModel.closeWin();
                }
            }); */
    		$.ajax({
                url: '${base.contextPath}/npi/technology/working/procedure/addData',
                type: "POST",
                contentType: "application/json",
                data : kendo.stringify(viewModel.model),
                success: function (data) {
                	if(data.success){
                		viewModel.closeWin();
                	}else{
                		kendo.ui.showErrorDialog({message:data.message});
                	}
                }
            });
    	},
    	saveAndAdd:function(){
			var validator = $("#mainForm").data("kendoValidator");
    		if(validator.validate()&&otherVali()) {
    			//return;
    		}else{
    			return;
    		}
    		viewModel.model.__status = 'add';
    		var headData = viewModelComposeHead.model.toJSON();
    		viewModel.model.matList = $("#matGrid").data("kendoGrid").dataSource._data;
    		viewModel.model.staDetail = headData;
    		$.ajax({
                url: '${base.contextPath}/npi/technology/working/procedure/addData',
                type: "POST",
                contentType: "application/json",
                data : kendo.stringify(viewModel.model),
                success: function (data) {
                	if(data.success){
                		//保存并新建操作,清除页面上所有的信息
                    	$("#matGrid").data("kendoGrid").dataSource.data([]); 
                    	$("#compGrid").data("kendoGrid").dataSource.data([]); 
                    	$("#equipGrid").data("kendoGrid").dataSource.data([]); 
    		        	var formData = viewModel.model.toJSON();
    		            for (var k in formData) {
    		                viewModel.model.set(k, null);
    		            }
    		            for (var k in headData) {
    		                viewModel.model.set(k, null);
    		            }
                	}else{
                		kendo.ui.showErrorDialog({message:data.message});
                	}
                }
            });
    	}
    });
    var viewModelComposeHead = Hap.createGridViewModel(null,{
    	model:{
    	},
    });
    var viewModelMat = Hap.createGridViewModel("#matGrid",{
        model:{},
        save:function () {
        },
        remove: function () {
                Hap.deleteGridSelection({
                    grid: $('#matGrid')
                });
        },
    });
    var viewModelComp = Hap.createGridViewModel("#compGrid",{
        model:{},
        save:function () {
        },
        remove: function () {
                Hap.deleteGridSelection({
                    grid: $('#compGrid')
                });
        },
    });
    var viewModelEquip = Hap.createGridViewModel("#equipGrid",{
        model:{},
        save:function () {
        },
        remove: function () {
                Hap.deleteGridSelection({
                    grid: $('#equipGrid')
                });
        },
    });
    
    $("#uploadFiles").kendoUpload({
		async: {
			saveUrl: "${base.contextPath}/npi/sop/route/ref/upload?${_csrf.parameterName}=${_csrf.token}",//
			autoUpload: false,
		},
		multiple:false,
		showFileList:true,
		validation: {
	        maxFileSize: 20971520
	    },
		upload: function(e){
			//e.data = upFileData;
		},
	    success: function(e){
	    	var response = e.response;
            if(response.success){
            	kendo.ui.showInfoDialog({message: "导入成功"});
            	var fileId = response.message;
            	viewModel.model.set('fileId',fileId);
            }else{
            	kendo.ui.showErrorDialog({message:"失败原因:"+response.message+"请重新上传文件"});
            }
	     },	
	});
</script>

<body>
	<div id="page-content" style="padding: 12px">
		<form id="mainForm" style="padding-bottom:10px;padding-top:0px" class="form-horizontal" method="post" enctype="application/json;charset=UTF-8">
			<div class="row">
				<div class="col-sm-4" >
					<div class="col-sm-12" style="padding-top:15px">
						<div class="form-group">
							<div class="col-sm-12">
								<label class="col-sm-4 control-label">工序编码</label>
								<div class="col-sm-8">
									<input style="width:100%" id="wpCode"  data-role="maskedtextbox" class="k-textbox"
										data-bind="value:model.wpCode"   placeholder='------------auto------------' disabled>
								</div>
							</div>
						</div>
					</div>
					<div class="col-sm-12">
						<div class="form-group">
							<div class="col-sm-12">
								<label class="col-sm-4 control-label">线段编号</label>
								<div class="col-sm-8">
									<input style="width:100%" id="lineNumber"
										data-bind="value:model.lineNumber" required>
										<script type="text/javascript">
											$("#lineNumber").kendoNumericTextBox({
												min:0,
											});
										</script>
								</div>
							</div>
						</div>
					</div>
					<div class="col-sm-12">
						<div class="form-group">
							<div class="col-sm-12">
								<label class="col-sm-4 control-label">标准工时(S)</label>
								<div class="col-sm-8">
									<input style="width:100%" id="standardWorkingHours"
										data-bind="value:model.standardWorkingHours" required>
										<script type="text/javascript">
											$("#standardWorkingHours").kendoNumericTextBox({
												min:0,
											});
										</script>
								</div>
							</div>
						</div>
					</div>
					<div class="col-sm-12">
						<div class="form-group">
							<div class="col-sm-12">
								<label class="col-sm-4 control-label">SOP动画</label>
								<div class="col-sm-6">
									<input style="width:100%" id="sopId"  data-role="maskedtextbox" class="k-textbox"
										data-bind="value:model.sopId" readOnly="readOnly">
								</div>
								<div class="col-sm-2">
									<span class="btn btn-primary fa fa-upload" style="float:right;" onclick="fileUpload()"></span>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="col-sm-4" >
					<div class="col-sm-12" style="padding-top:15px">
						<div class="form-group">
							<div class="col-sm-12">
								<label class="col-sm-4 control-label">工序名称</label>
								<div class="col-sm-8">
									<input style="width:100%" id="workingProcedureName"  data-role="maskedtextbox" class="k-textbox"
										data-bind="value:model.workingProcedureName"  required>
								</div>
							</div>
						</div>
					</div>
					<div class="col-sm-12">
						<div class="form-group">
							<div class="col-sm-12">
								<label class="col-sm-4 control-label">前置工序</label>
								<div class="col-sm-8">
									<input style="width:100%" id="preWorkingProcedure"  data-role="maskedtextbox" class="k-textbox"
										data-bind="value:model.preWorkingProcedure" required>
								</div>
							</div>
						</div>
					</div>
					<div class="col-sm-12">
						<div class="form-group">
							<div class="col-sm-12">
								<label class="col-sm-4 control-label">工序版本</label>
								<div class="col-sm-8">
									<input style="width:100%" id="versionNumber"  data-role="maskedtextbox" class="k-textbox"
										data-bind="value:model.versionNumber"   placeholder='------------auto------------' disabled>
								</div>
							</div>
						</div>
					</div>
					<div class="col-sm-12">
						<div class="form-group">
							<div class="col-sm-12">
								<label class="col-sm-4 control-label"></label>
								<div class="col-sm-8">
									<a href="javascript:queryEbomData()" ><h4 style="text-decoration: underline">查看E-BOM信息</h4></a>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="col-sm-4" >
					<div class="col-sm-12" style="padding-top:15px">
						<div class="form-group">
							<div class="col-sm-12">
								<label class="col-sm-4 control-label">主线/辅线</label>
								<div class="col-sm-8"  style="margin-top:5px;>
									<div style="width:100%" id="lineType""
										data-bind="enabled: isEnabled,value:model.lineType">
									<script>
				                        $("#lineType").kendoRadio({
											layout: '',//vertical
											readonly: false,
											items: [{
														label: '主线',
														value: "mainLine"
													}, {
														label: '辅线',
														value: "auxiLine"
													}],
										});
									</script>
								</div>
							</div>
						</div>
					</div>
					<div class="col-sm-12">
						<div class="form-group">
							<div class="col-sm-12">
								<label class="col-sm-4 control-label">内制/外制</label>
								<div class="col-sm-8" style="margin-top:5px;>
									<input style="width:100%" id="inOutMake"
										data-bind="enabled: isEnabled,value:model.inOutMake" >
									<script>
				                        $("#inOutMake").kendoRadio({
											layout: '',//vertical
											readonly: false,
											items: [{
														label: '内制',
														value: "IN"
													}, {
														label: '外制',
														value: "OUT"
													}],
										});
									</script>
								</div>
							</div>
						</div>
					</div>
					<div class="col-sm-12">
						<div class="form-group">
							<div class="col-sm-12">
								<label class="col-sm-4 control-label">自动/手动</label>
								<div class="col-sm-8" style="margin-top:5px;>
									<input style="width:100%" id="autoFlag"
										data-bind="enabled: isEnabled,value:model.autoFlag"">
									<script>
				                        $("#autoFlag").kendoRadio({
											layout: '',//vertical
											readonly: false,
											items: [{
														label: '手动',
														value: "noAuto"
													}, {
														label: '自动',
														value: "auto"
													}],
										});
									</script>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</form>

		<#--第二行部分-->
		<div class="row">
			<div class="col-lg-9" style="padding: 0px">
				<h5 style="margin-top: 25px;margin-top:3px;margin-bottom: 6px;margin-left: 7px;color: #0c91e5">工艺步骤</h5>
			</div>
			<div class="col-lg-3" style="padding: 0px">
				<h5 style="margin-top: 25px;margin-top:3px;margin-bottom: 6px;margin-left: 7px;color: #0c91e5">选择测试动作</h5>
			</div>
		</div>
		<div class="row">
			<div class="col-lg-9" style="padding: 0px">
				<div class="panel" style="padding: 0px; height:250px; ">
					<div class="row" style="margin-top: 5px;margin-left: 5px;margin-bottom: 7px">
						<div id="matToolbar-btn" >
							<span class="btn btn-primary k-grid-add" style="float:left;margin-right:5px;" onclick="createMatNumber()"><i class="fa fa-plus-square" style="margin-right:3px;"></i>添加辅助动作</span>
							<span data-bind="click:remove" class="btn btn-danger" style="float:left;"><@spring.message "hap.delete"/></span>
						</div>
						<script>kendo.bind($('#matToolbar-btn'), viewModelMat);</script>
					</div>
					<#--工序步骤表格-->
					<hr style="padding: 0px;margin-bottom: 0px;margin-top: 1px;">
					<div style="clear:both;">
						<div id="matGrid" style="border: 2px;height: 205px;"></div>
					</div>
				</div>
			</div>
			<div class="col-lg-3" style="padding: 0px">
				<div class="panel" style="padding: 0px; height:250px; ">
					<div id="testAction" style="height: 100%;padding-top: 15px">

							<div class="col-sm-12" style="padding-top:10px;">
								<label class="labelA" style="color: black; margin-top: 6px;">测试动作</label>
									<input id="testActionId" data-bind="value:model.standardActionId">
									<script type="text/javascript">
										$("#testActionId").kendoComboBox({
											filter:"contains",
											valuePrimitive:true,
											dataTextField:"text",
											dataValueField:"value",
											dataSource:{
												transport:{
													read:_basePath + "/npi/technology/queryTestActionName",
												}
											},
											select:function(e) {
												//每次修改的时候 将测试动作的一些属性值set到其余的数据中
												//这里带出测试动作的一些值
												var id= e.dataItem.value;
												$.ajax({
													url:_basePath + "/hqm/technology/standard/action/query?standardActionId="+id,
													async:false,
													success:function(data){
														//这里的kendoui不一定会双向绑定,所以使用jquery手动赋值
														if(viewModelComposeHead.model.actionTimes != null || viewModelComposeHead.model.actionTimes != undefined ){
															viewModelComposeHead.model.matterWorkHours = viewModelComposeHead.model.actionTimes*data.rows[0].standardWorkingHours;
														}else{
															viewModelComposeHead.model.matterWorkHours = data.rows[0].standardWorkingHours;
														}
														viewModelComposeHead.model.matterWorkHoursUnit=data.rows[0].standardWorkingHours;
														viewModelComposeHead.model.actionName=data.rows[0].actionName;
														$("#compMatterWorkHours").val(viewModelComposeHead.model.matterWorkHours);
													}
												});
												//这里需要从spec里面带出值  通过标准动作和上面的物料属性 去spec里面查找带出
												//获取到上面的所有物料属性的ids
												var matGridData = $("#matGrid").data("kendoGrid").dataSource._data;
												var materielIds=[];
												$.each(matGridData,function(index,item){
													materielIds[index]=item.materielIds;
												});
											},
											change:function (e) {
												$("#compGrid").data("kendoGrid").dataSource.data([])
											},
											clear:function (e) {
												$("#compGrid").data("kendoGrid").dataSource.data([])
											}
										});
									</script>
							</div>
							<div class="col-sm-12" style="padding-top:10px;">
								<label class="labelA" style="color: black; margin-top: 6px;">动作次数</label>
								<!-- <label class="col-sm-4 control-label">动作次数</label> -->
								<input id="actionTimes"  data-bind="value:model.actionTimes">
								<script type="text/javascript">
									$("#actionTimes").kendoNumericTextBox({
										min:0,
										change:function(e){
											viewModelComposeHead.model.matterWorkHours=viewModelComposeHead.model.matterWorkHoursUnit*this.value();
											$("#compMatterWorkHours").val(viewModelComposeHead.model.matterWorkHours);
										}
									});
								</script>
							</div>
							<div class="col-sm-12" style="padding-top:10px;">
								<label class="labelA"   style="color: black; margin-top: 6px;">标准工时参考值</label>
								<input id="compMatterWorkHours" class="k-textbox" " data-bind="value:model.matterWorkHours" readonly="readonly">
								<script type="text/javascript">
									/*$("#compMatterWorkHours").kendoNumericTextBox({
										min:0,
										spinners:false,
									});*/
								</script>
							</div>
							<div class="col-sm-12" style="padding-top:10px;">
								<label class="labelA" style="color: black; margin-top: 6px;">标准工时</label>
								<input  id="standardTime" data-bind="value:model.standardWorkingHours" required>
								<script type="text/javascript">
									$("#standardTime").kendoNumericTextBox({
										min:0,
									});
								</script>
							</div>
							<div class="col-sm-12" style="padding-top:19px;">
								<div class="form-group">
									<div class="col-sm-6">
										<div style="margin:0 auto;margin-left: 30px">
											<span class="btn btn-success k-grid-add" style="margin:0 auto;" onclick="addEquipmentByStandard()"><i class="fa fa-plus-square" style="margin-right:3px;"></i>添加工装设备</span>
										</div>
									</div>
									<div class="col-sm-6">
										<div style="margin:0 auto;">
											<span  id="selectSpec" class="btn btn-primary k-grid-add" style="margin:0 auto;" onclick="getPSPEC()">选择P-SPEC要求</span>
										</div>
									</div>
								</div>
							</div>
					</div>
				</div>
			</div>
		</div>
		<#--第三行部分-->
		<div class="row">
			<div class="col-lg-6" style="padding: 1px">
				<h5 style="margin-top: 25px;margin-top:3px;margin-bottom: 6px;margin-left: 7px;color: #0c91e5">工装/夹具/设备</h5>
			</div>
			<div class="col-lg-6" style="padding: 1px">
				<h5 style="margin-top: 25px;margin-top:3px;margin-bottom: 6px;margin-left: 7px;color: #0c91e5">P-SPEC要求</h5>
			</div>
		</div>
		<form id="compForm" style="paddiing-bottom:50px;padding-top:1px" class="form-horizontal" method="post" enctype="application/json;charset=UTF-8">
			<div class="row" style="height:250px;">
				<div class="col-sm-6" style="border:2px;padding: 0px;">
					<div class="panel" style="padding: 0px; ">
						<div style="clear:both">
							<div id="equipGrid" style="height: 250px;"></div>
						</div>
					</div>
				</div>
				<div class="col-sm-6" style="border:2px;padding: 0px;">
					<div class="panel" style="padding: 0px; ">
						<div style="clear:both">
							<div id="compGrid" style="height: 250px;"></div>
						</div>
					</div>
				</div>
			</div>
		</form>
	</div>
	<div id="newMatAttrWindow"></div>
	<div id="eBomViewWindow"></div>
	<div id="newEquipWindow"></div>
	<div id="selectPspecWindow"></div>
	<div id="mainBottom" class="text-right" style="bottom:15px;position:fixed;float:left;padding-top:15px;border-top:1px solid #e8e1eb;
		width:100%;background:#fff;margin-right:30px">
		<span class="btn btn-primary" data-bind="click:save" type="submit" style="margin-right:5px">保存</span>
		<span class="btn btn-primary" data-bind="click:saveAndAdd" type="submit" style="margin-right:5px">保存并新建下一道工序</span>
		<span class="btn btn-default" data-bind="click:closeWin" type="button" style="margin-right:25px">取消</span>
	</div>
	<div hidden class="demo-section k-content">
		<input name="files" id="uploadFiles" type="file" accept=".wmv,.rmvb,.jpeg,.jpg,.mp4" />
	</div>
	<script>
		kendo.bind($('#mainForm'), viewModel);
		kendo.bind($('#mainBottom'), viewModel);
		kendo.bind($('#compForm'), viewModelComposeHead);
		kendo.bind($('#testAction'), viewModelComposeHead);
	</script>
	<script>
		$('#mainForm').kendoValidator({
			messages:{
				required:'<@spring.message "hap.validation.notempty"/>'
			},
			invalidMessageType:"tooltip"
		});
	</script>
<script>
    var BaseUrl = _basePath;
    var dataSourceMat = new kendo.data.DataSource({
        transport: {
            read: {
                url: BaseUrl + "/hqm/technology/standard/action/query1",
                type: "POST",
                dataType: "json"
            },
            destroy: {
                url: BaseUrl + "/hqm/technology/standard/action/remove",
                type: "POST",
                contentType: "application/json"
            },
            create:{
                url: BaseUrl + "/hqm/technology/standard/action/add",
                type: "POST",
                contentType: "application/json",
                async: true
            },
            parameterMap: function (options, type) {
                if (type !== "read" && options.models) {
                    var datas = Hap.prepareSubmitParameter(options, type);
                    return kendo.stringify(datas);
                } else if (type === "read") {
                    return Hap.prepareQueryParameter(viewModel.model.toJSON(), options)
                }
            }
        },
        batch: true,
        serverPaging: true,
        pageSize: 20,
        schema: {
            data: 'rows',
            total: 'total',
            model: {
                //id: "standardActionId",
                fields: {
                	materielNumber :{validation:{required:true}},
                	auxiliaryActionId :{validation:{required:true}},
                	//materielAttribute :{validation:{required:true}},
                	qty :{validation:{required:true}},
                	assemblingDetail :{validation:{required:true}},
                	matterWorkHours :{validation:{required:true}},
                	standardWorkingHours :{validation:{required:true}},
                	status :{validation:{required:true}},
                	//equipment :{validation:{required:true}},
                	lowerLimit :{validation:{required:true}},
                	upperLimit :{validation:{required:true}},
                	unit :{validation:{required:true}},
                	measurementMethod :{validation:{required:true}},
                },
                editable:function(col){
                	if(col == 'matterWorkHours') {
                		return false;
                	}
					if (col=='assemblingDetail'){
						return false
					}
					if (col=='measurementMethod'){
						return false
					}
                	return true;
                }
            }
        },
    });
    var dataSourceComp = new kendo.data.DataSource({
        transport: {
            read: {
                url: BaseUrl + "/hqm/technology/standard/action/query1",
                type: "POST",
                dataType: "json"
            },
            destroy: {
                url: BaseUrl + "/hqm/technology/standard/action/remove",
                type: "POST",
                contentType: "application/json"
            },
            create:{
                url: BaseUrl + "/hqm/technology/standard/action/add",
                type: "POST",
                contentType: "application/json",
                async: true
            },
            parameterMap: function (options, type) {
                if (type !== "read" && options.models) {
                    var datas = Hap.prepareSubmitParameter(options, type);
                    return kendo.stringify(datas);
                } else if (type === "read") {
                    return Hap.prepareQueryParameter(viewModel.model.toJSON(), options)
                }
            }
        },
        batch: true,
        serverPaging: true,
        pageSize: 20,
        schema: {
            data: 'rows',
            total: 'total',
            model: {
                //id: "standardActionId",
                fields: {
                	materielAttribute :{validation:{required:true}},
                	qty :{validation:{required:true}},
                	assemblingDetail :{validation:{required:true}},
                	matterWorkHours :{validation:{required:true}},
                	meteringCount :{validation:{required:true}},
                	standardWorkingHours :{validation:{required:true}},
                	status :{validation:{required:true}},
                	equipment :{validation:{required:true}},
                	lowerLimit :{validation:{required:true}},
                	upperLimit :{validation:{required:true}},
                	unit :{validation:{required:true}},
                	measurementMethod :{validation:{required:true}},
                },
                editable:function(col){
                	if(col == 'testActionId' || col == 'composeName' || col == 'standardWorkingHours'|| col == 'actionName'
                		|| col == 'status' || col == 'equipment'|| col == 'equipmentName') {
                		return true;
                	}
                	return false;	
                }
            }
        }
    });
    var dataSourceEquip = new kendo.data.DataSource({
        transport: {
            read: {
                url: BaseUrl + "/hqm/technology/standard/action/query",
                type: "POST",
                dataType: "json"
            },
            parameterMap: function (options, type) {
                if (type !== "read" && options.models) {
                    var datas = Hap.prepareSubmitParameter(options, type);
                    return kendo.stringify(datas);
                } else if (type === "read") {
                    return Hap.prepareQueryParameter(viewModel.model.toJSON(), options)
                }
            }
        },
        batch: true,
        serverPaging: true,
        pageSize: 20,
        schema: {
            data: 'rows',
            total: 'total',
            model: {
                //id: "standardActionId",
                fields: {
                	qty :{validation:{required:true}},
                },
                editable:function(col){
                	if(col == 'materielNumberName' ||col == 'actionName') {
                		return false;
                	}
                	return true;	
                }
            }
        }
    });

</script>

<script>
	function createMatNumber(){
		//取物料
		var grid = $("#matGrid").data("kendoGrid");
    	grid.addRow();
    	grid.dataSource._data[0].materielType='mat';
	}
	function createComNumber(){
		//取组件
		var grid = $("#matGrid").data("kendoGrid");
    	grid.addRow();
    	grid.dataSource._data[0].materielType='com';
	}
	function fileUpload(){
		$("#uploadFiles").trigger("click");
    }
	function editMat(uid,materielType){
		//传uid 和 物料类型过去 组件和物料获取属性的方式不同
		var row=$("#matGrid").data("kendoGrid").dataSource.getByUid(uid);
	    var materielNumber = row.materielNumber;
		if(materielNumber == null || materielNumber == undefined){
			kendo.ui.showWarningDialog({
				message: "请先选择物料!"
			});
			return ;
		}
		var url='wp_materiel_data_query.html?uid='+uid+'&materielType='+materielType+'&materielNumber='+materielNumber;
		var newDataWindow = $("#newMatAttrWindow").kendoWindow({
			actions:["close"],
			width:800,
			height:500,
			title:'物料属性选择',
			content:url,
			iframe:true,
			visible:false,
			resizable:true,
			modal:true,
			close:function(){
				//$("#leftGrid").data('kendoGrid').dataSource.read();
			}
			
		}).data("kendoWindow");
		newDataWindow.center().open();
    }
	
	//辅助动作添加工装设备
	function addEquipment(uid){
		var row=$("#matGrid").data("kendoGrid").dataSource.getByUid(uid)
    	var grid = $("#equipGrid").data("kendoGrid");
    	grid.addRow();
    	grid.dataSource._data[0].parentUid=uid;
    	grid.dataSource._data[0].__status = "add";
    	//新的行的物料编码和动作需要带出
    	grid.dataSource._data[0].actionName = row.actionName;
    	grid.dataSource._data[0].materielNumberName = row.materielNumberName;
    	var gridPat = $("#matGrid").data("kendoGrid");
    	for(var i =0 ;i < gridPat.dataSource._data.length; i++){
			if(gridPat.dataSource._data[i].uid == uid){
				var equipList = gridPat.dataSource._data[i].equipList;
				if(equipList == null){
					var arrayObj = new Array();
					arrayObj.push(grid.dataSource._data[0]);
					gridPat.dataSource._data[i].equipList = arrayObj;
				}else{
					gridPat.dataSource._data[i].equipList.push(grid.dataSource._data[0]);
				}
			}
        }
    	$("#equipGrid").data("kendoGrid").refresh();
	}
	//标准动作添加工装设备
	function addEquipmentByStandard(){
		var uid='9893df82-e551-4b37-bef0-245ece8a553d';
		//var row=$("#matGrid").data("kendoGrid").dataSource.getByUid(uid)
		var row=viewModelComposeHead.model;
		if(row.standardActionId == null || row.standardActionId == undefined ){
			kendo.ui.showWarningDialog({
				message: "测试动作未选择！"
			});
		}
    	var grid = $("#equipGrid").data("kendoGrid");
    	grid.addRow();
    	grid.dataSource._data[0].parentUid=uid;
    	grid.dataSource._data[0].__status = "add";
    	//新的行的物料编码和动作需要带出
    	grid.dataSource._data[0].actionName = row.actionName;
    	grid.dataSource._data[0].materielNumberName = row.materielNumberName;
    	var gridPat = viewModelComposeHead.model;
		var equipList = gridPat.equipList;
		if(equipList == null){
			var arrayObj = new Array();
			arrayObj.push(grid.dataSource._data[0]);
			gridPat.equipList = arrayObj;
		}else{
			gridPat.equipList.push(grid.dataSource._data[0]);
		}
    	$("#equipGrid").data("kendoGrid").refresh();
	}

	//添加SPEC至SPEC要求表
	function addSpecToCompGrid(data) {
		var compGridData = $("#compGrid").data('kendoGrid').dataSource._data;
		var existFlag = false;
		$.each(compGridData,function (index,item) {
			if (data.detailId == item.detailId){
				existFlag = true;
			}
		})
		if (!existFlag) {
			compGridData.push(data)
		}
		$("#compGrid").data("kendoGrid").refresh();
	}

	//删除工装设备
	function delEquipment(uid){
    	$("#equipGrid").data("kendoGrid").refresh();
    	var grid = $("#equipGrid").data("kendoGrid");
    	grid.removeRow("tr[data-uid="+uid+"]");
	}
	function getPSPEC(){
		var url='tp_spec_list.html';
		var pspecWindow = $("#selectPspecWindow").kendoWindow({
			actions:["close"],
			width:900,
			height:500,
			title:'选择P-SPEC要求',
			content:url,
			requestData:{
				skuCode:sku
			},
			iframe:true,
			visible:false,
			resizable:true,
			modal:true,
			close:function(){
				//$("#leftGrid").data('kendoGrid').dataSource.read();
			}

		}).data("kendoWindow");
		pspecWindow.center().open();
	}
	function createNewEquip(uid) {
		//传uid 和 物料类型过去 组件和物料获取属性的方式不同
		var row = $("#equipGrid").data("kendoGrid").dataSource.getByUid(uid);
		var url = 'equipment_create.html?uid=' + uid;
		var newDataWindow = $("#newEquipWindow").kendoWindow({
			actions: ["close"],
			width: 800,
			height: 500,
			title: '新建工装/工具/设备',
			content: url,
			iframe: true,
			visible: false,
			resizable: true,
			modal: true,
			close: function () {
				//$("#leftGrid").data('kendoGrid').dataSource.read();
			}

		}).data("kendoWindow");
		newDataWindow.center().open();
	}
	function queryEbomData(){
		var url='wp_e_bom_view.html?sku='+sku;
		var eBomViewWindow = $("#eBomViewWindow").kendoWindow({
			actions:["close"],
			width:800,
			height:500,
			title:'当前工艺路径可用E-BOM数据查看',
			content:url,
			iframe:true,
			visible:false,
			resizable:true,
			modal:true,
			close:function(){
			}
			
		}).data("kendoWindow");
		eBomViewWindow.center().open();
	}

	//辅助动作表
    var matGrid = $("#matGrid").kendoGrid({
        dataSource: dataSourceMat,
        resizable: true,
        scrollable: true,
        navigatable: false,
        //sortable:true,
        autoBind:false,
        selectable: 'multiple, rowbox',
        dataBound: function () {
            if (parent.autoResizeIframe) {
                parent.autoResizeIframe('${RequestParameters.functionCode!}')
            }
        },
        columns: [
            {
                field: "auxiliaryActionId",
                title: '辅助动作',
                width: 100,
                headerAttributes: {
                    style: "text-align: center"
                },
                attributes: {
                    style: "text-align: center"
                },
                template: function (item) {
                    return item['actionName'] || ''
                },
                editor: function (container, options) {
                		$('<input required name="' + options.field + '"/>').appendTo(container).kendoComboBox({
                        	filter:"contains",
    						valuePrimitive:true,
    						dataTextField:"text",
							dataValueField:"value",
    						dataSource:{
    							transport:{
    								read:_basePath + "/npi/technology/queryAuxiliaryActionName",
    							}
    						},
    						select:function(e) {
	                        	options.model.set('actionName',e.dataItem.text);
	                        	//options.model.set('auxiliaryActionId',e.dataItem.value); 这里set值没效果
	                        	var id=e.dataItem.value
	                        	$.ajax({
	                    			url:_basePath + "/hqm/technology/auxiliary/action/query?auxiliaryActionId="+id,
	                    			async:false,
	                    			success:function(data){
	                    				//这里下拉框和lov的获取到的options不同 下拉框获取的是自己那个字段的，和lov的不一样，这里方法是通过uid获取到数据，然后手动set数据，然后刷新grid(不然数据不显示)
	                    				var row=$("#matGrid").data("kendoGrid").dataSource.getByUid(options.model.uid);
	                    				row.matterWorkHours=data.rows[0].standardWorkingHours;
	                    				row.matterWorkHoursUnit=data.rows[0].standardWorkingHours;
	                    				row.assemblingDetail=data.rows[0].assemblingDetail;
	                    				row.measurementMethod=data.rows[0].standardTestMethod;
	                    				row.auxiliaryActionId=id;
	                    				$("#matGrid").data("kendoGrid").refresh();
	                    			}
	                    		});
	                        }
    					});
                	}
            },
            {
            	field: "assemblingDetail",
                title: '装配要求明细',
                width: 220,
                headerAttributes: {
                    style: "text-align: center"
                },
				attributes: {style:"text-align:center;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;"},
               /* template:function(dataItem){
                	if(dataItem.assemblingDetail!=null&& dataItem.assemblingDetail!=''){
                		var returnDateItem = dataItem.assemblingDetail.replace(/\r\n/g, '##').replace(/\n/g, '##').replace(/\s/g, '##');
                		returnDateItem = returnDateItem.replace(/##/g,'<br>');
                		return returnDateItem;
                	}else{
                		return '';
                	}
                }*/
            },
            {
                field: "matterWorkHours",
                title: '标准工时参考值',
                width: 60,
                headerAttributes: {
                    style: "text-align: center"
                },
                attributes: {
                    style: "text-align: center"
                }
            },
            {
                field: "standardWorkingHours",
                title: '标准工时',
                width: 60,
                headerAttributes: {
                    style: "text-align: center"
                },
                attributes: {
                    style: "text-align: center"
                },
                editor: function (container, options) {
                    $('<input required name="' + options.field + '"/>').appendTo(container).kendoNumericTextBox({
						min:0,
					});
                } 
            },
            {
            	field: "measurementMethod",
                title: '标准/测量方法',
                width: 80,
                headerAttributes: {
                    style: "text-align: center"
                },
                attributes: {
                    style: "text-align: center"
                }
            },
            {
                title: '操作',
                width: 80,
                headerAttributes: {
                    style: "text-align: center"
                },
                attributes: {
                    style: "text-align: center"
                },
                template:function (dataItem) { 
                	return '<span class="btn btn-success k-grid-add" onclick="addEquipment(\''+dataItem.uid+'\')" ><i class="fa fa-plus-square" style="margin-right:3px;"></i>添加工装设备</span>';
                }
            }
        ],
        editable: true
    }).data("kendoGrid");

    //工装/夹具表
    var equipGrid = $("#equipGrid").kendoGrid({
        dataSource: dataSourceEquip,
        resizable: true,
        scrollable: true,
        navigatable: false,
        //sortable:true,
        autoBind:false,
        //selectable: 'multiple, rowbox',
        dataBound: function () {
            if (parent.autoResizeIframe) {
                parent.autoResizeIframe('${RequestParameters.functionCode!}')
            }
        },
       /* pageable: {
            pageSizes: [5, 10, 20, 50],
            refresh: true,
            buttonCount: 5
        },*/
        columns: [
        	{
                field: "actionName",
                title: '动作',
                width: 100,
                headerAttributes: {
                    style: "text-align: center"
                },
                attributes: {
                    style: "text-align: center"
                }
            },
        	{
                field: "status",
                title: '工装/工具/设备状态',
                width: 100,
                headerAttributes: {
                    style: "text-align: center"
                },
                attributes: {
                    style: "text-align: center"
                },
                template: function (dataItem) {
                    var v = dataItem.status ? dataItem.status : "";
                    $.each(NPI_ROUTE_EQUIP_STATUS	, function (i, n) {
                        if ((n.value || '').toLowerCase() == (v || '').toLowerCase()) {
                            v = n.meaning;
                            return v;
                        }
                    });
                    return v;
                },
                editor: function (container, options) {
                    $('<input required name="' + options.field + '"/>')
                        .appendTo(container)
                        .kendoDropDownList({
                            dataTextField: "meaning",
                            dataValueField: "value",
                            valuePrimitive: true,
                            dataSource: NPI_ROUTE_EQUIP_STATUS	
                        });
                }
            },
            {
                field: "equipmentCode",
                title: '工装/工具/设备编码',
                width: 120,
                headerAttributes: {
                    style: "text-align: center"
                },
                attributes: {
                    style: "text-align: center"
                },
                editor: function (container, options) {
                	if(options.model.status == 'add'){
                		//新增时添加临时编码
                		$('<span class="k-widget k-lov k-header">'
        	                    +'<span tabindex="-1" unselectable="on" class="k-dropdown-wrap k-state-default">'
        	                    +'<input name="'
        	                    + options.field
        	                    +'" class="k-input" type="text" role="lov" title=" '+ options.model.materielAttribute
        	                    +'" aria-expanded="false" disabled="true" readonly="readonly" data-bind="value: '
        	                    + options.field 
        	                    +'" style="width:100%;">'
        	                    +'<span unselectable="on" class="k-select" aria-label="select" role="button" tabindex="-1"'
        	                    +' onclick="createNewEquip('
        	                    +"'"+options.model.uid+'\',\''+options.model.materielType+"'"+')">'
        	                    +'<span class="k-icon k-i-search"></span>'+'</span></span></span>').appendTo(container);
                	}else{
                		$('<input name="' + options.field + '"/>')
	                        .appendTo(container)
	                        .kendoLov($.extend(<@lov "SPARE_PART_CODE_DETAIL"/>, {
	                        query: function (e) {
	                            /* e.param['enableFlag'] = 'Y'
	                            e.param['roleFastCode']= 'SRM_USER_MANAGEMENT'; */
	                        },
	                        textField: 'detailsName', 
	                        model: options.model,
	                        select:function(e) {
	                        }
	                    }));
                	}
            	}
            },
            {
                field: "equipmentName",
                title: '工装/工具/设备名称',
                width: 150,
                headerAttributes: {
                    style: "text-align: center"
                },
                attributes: {
                    style: "text-align: center"
                }
            },
            {
                field: "qty",
                title: '数量',
                width: 80,
                headerAttributes: {
                    style: "text-align: center"
                },
                attributes: {
                    style: "text-align: center"
                },
                editor: function (container, options) {
                    $('<input  required name="' + options.field + '"/>').appendTo(container).kendoNumericTextBox({
						min:0,
					});
                }
            },
            {
                title: '删除',
                width: 50,
                headerAttributes: {
                    style: "text-align: center"
                },
                attributes: {
                    style: "text-align: center"
                },
                template:function (dataItem) { 
                	return '<span class="btn btn-danger k-grid-add" onclick="delEquipment(\''+dataItem.uid+'\')" >删除</span>';
                }
            }
        ],
        editable: true
    }).data("kendoGrid");

    //SPEC要求
	var compGrid = $("#compGrid").kendoGrid({
		dataSource: dataSourceComp,
		resizable: true,
		scrollable: false,
		navigatable: false,
		//sortable:true,
		autoBind:false,
		selectable: false,
		dataBound: function () {
			if (parent.autoResizeIframe) {
				parent.autoResizeIframe('${RequestParameters.functionCode!}')
			}
		},
		/* pageable: {
             pageSizes: [5, 10, 20, 50],
             refresh: true,
             buttonCount: 5
         },*/
		columns: [
			{
				field: "assemblingDetail",
				title: '装配要求明细',
				width: 135,
				headerAttributes: {
					style: "text-align: center"
				},
				attributes: {style:"text-align:center;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;"},
				/*template:function(dataItem){
                    if(dataItem.specRequirement!=null&& dataItem.specRequirement!=''){
                        var returnDateItem = dataItem.specRequirement.replace(/\r\n/g, '##').replace(/\n/g, '##').replace(/\s/g, '##');
                        returnDateItem = returnDateItem.replace(/##/g,'<br>');
                        return returnDateItem;
                    }else{
                        return '';
                    }
                }*/
			},{
				field: "meteringCount",
				title: '计量/计数',
				width: 70,
				headerAttributes: {
					style: "text-align: center"
				},
				attributes: {
					style: "text-align: center"
				},
				template: function (dataItem) {
					var v = dataItem.meteringCount ? dataItem.meteringCount : "";
					$.each(NPI_METERING_COUNT, function (i, n) {
						if ((n.value || '').toLowerCase() == (v || '').toLowerCase()) {
							v = n.meaning;
							return v;
						}
					});
					return v;
				},
				editor: function (container, options) {
					$('<input required name="' + options.field + '"/>')
							.appendTo(container)
							.kendoDropDownList({
								dataTextField: "meaning",
								dataValueField: "value",
								valuePrimitive: true,
								dataSource: NPI_METERING_COUNT
							});
				}
			},
			{
				field: "lowerLimit",
				title: '下限',
				width: 70,
				headerAttributes: {
					style: "text-align: center"
				},
				attributes: {
					style: "text-align: center"
				}
			},
			{
				field: "upperLimit",
				title: '上限',
				width: 70,
				headerAttributes: {
					style: "text-align: center"
				},
				attributes: {
					style: "text-align: center"
				}
			},
			{
				field: "unit",
				title: '单位',
				width: 70,
				headerAttributes: {
					style: "text-align: center"
				},
				attributes: {
					style: "text-align: center"
				}
			},
			{
				field: "characteristicName",
				title: '<@spring.message "特性分类"/>',
				headerAttributes: {
					style: "text-align: center"
				},
				attributes:{style:"text-align: center;white-space:nowrap;text-overflow:ellipsis;"},
				width: 120,

			},
			{
				field: "msa",
				title: 'MSA',
				width: 120,
				headerAttributes: {
					style: "text-align: center"
				},
				attributes: {
					style: "text-align: center"
				}
			},
			{
				field: "spc",
				title: 'SPC',
				width: 120,
				headerAttributes: {
					style: "text-align: center"
				},
				attributes: {
					style: "text-align: center"
				}
			}
		],
		editable: false
	}).data("kendoGrid");

	//Hap.autoResizeGrid("#matGrid");
	//Hap.autoResizeGrid("#compGrid");

	$("#matGrid").kendoTooltip({
		show: function(e){
			if($.trim(this.content.text()) !=""){
				$('[role="tooltip"]').css("visibility", "visible");
			}
		},
		hide: function(){
			$('[role="tooltip"]').css("visibility", "hidden");
		},
		filter: "td:nth-child(n+3)",
		content: function(e){
			var element = e.target[0];
			if(element.offsetWidth < element.scrollWidth){
				var text = $(e.target).text();
				return '<div style="min-width:100px;max-width: 1000px;">' + text + '</div>';
			}else{
				$('[role="tooltip"]').css("visibility", "hidden");//解决鼠标一开始放在上面出现空模块
				return "";
			}
		}
	}).data("kendoTooltip");
	$("#compGrid").kendoTooltip({
		show: function(e){
			if($.trim(this.content.text()) !=""){
				$('[role="tooltip"]').css("visibility", "visible");
			}
		},
		hide: function(){
			$('[role="tooltip"]').css("visibility", "hidden");
		},
		filter: "td:nth-child(n+3)",
		content: function(e){
			var element = e.target[0];
			if(element.offsetWidth < element.scrollWidth){
				var text = $(e.target).text();
				return '<div style="min-width:100px;max-width: 1000px;">' + text + '</div>';
			}else{
				$('[role="tooltip"]').css("visibility", "hidden");//解决鼠标一开始放在上面出现空模块
				return "";
			}
		}
	}).data("kendoTooltip");

</script>
</div>
</body>
</html>