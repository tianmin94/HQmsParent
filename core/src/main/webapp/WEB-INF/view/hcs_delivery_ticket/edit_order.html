<#include "../include/header.html">
<style>
body{
font-size: 10px;
}
</style>
<script src="${base.contextPath}/common/code?SRM_TICKET_TYPE=SRM_TICKET_TYPE"></script>
<script src="${base.contextPath}/common/code?SRM_TICKET_STATUS=SRM_TICKET_STATUS"></script>
<script src="${base.contextPath}/common/code?SRM_TICKET_LINE_STATUS=SRM_TICKET_LINE_STATUS"></script>
<script src="${base.contextPath}/common/code?SRM_PACKING_TYPE=SRM_PACKING_TYPE"></script>
<script type="text/javascript">
    var viewModel = Hap.createGridViewModel("#grid");
    var parentData = window.parent.parentData;
    var info = [];
    var count = 0;
    var flag = "N";
    var status;
    var shippingableList = [];
    var initData = {};
    //送货单ID
    var ticketIdData;
    $(function(){
    	var myDate = new Date();
    	if(window.parent.supplierId == null){
			$("#save").hide()
			$("#cancel").hide()
		} 
    	if(parentData[0].enableFlag === 'F'){
    		$("#toPrint").hide();  
    	}
    	if(parentData[0].enableFlag === 'F' || parentData[0].enableFlag === 'H'){
    		//已有送货单头查询
    		var ticketIdData = {
    				"ticketId" : parentData[0].id
    		}
    		$.ajax({
	    		url:"${base.contextPath}/hcs/delivery/ticket/h/queryByTicketId",
	    		type:"POST",
	    		data:ticketIdData,
	    		async:false,
	    		dataType:'json',
	    		success: function(data){
	    			if(parentData[0].enableFlag === 'F'){
	    				status = data.rows[0].status;
	    				if(data.rows[0].status === 'P'){
	    					//发货日期不可编辑
	    					var str = '<input id="shipDate" style="width:210px;background-color:#ededed;" value="'+data.rows[0].shipDate+'" disabled  data-role="maskedtextbox" type="text" data-bind="value:model.shipDate" data-lable="<@spring.message "发货日期 "/>"/>';
	    					$("#ship").empty();
	    					$("#ship").append(str)
	    					//预计到货时间不可编辑
	    					var strTime = '<input id="expectedDate"  style="width:210px;background-color:#ededed;" disabled value="'+data.rows[0].expectedDate+'"  data-role="maskedtextbox" type="text" data-bind="value:model.expectedDate" data-lable="<@spring.message "预计到货日期"/>"/>'
	    					$("#expected").empty();
	    					$("#expected").append(strTime)
	    	    			//送货单备注不可编辑
	    	    			$("#remarks").attr("disabled","true");
	    	    			$("#remarks").css("background","#EDEDED");
	    	    		}
	    			}
	    			//发货单号
	    			viewModel.model.set('ticketNumber',data.rows[0].ticketNumber);
	    			//供应商
	    			viewModel.model.set('supplierCode',data.rows[0].supplierCode);
	    			viewModel.model.set('supplierName',data.rows[0].supplierName);
	    			viewModel.model.set('status',data.rows[0].status);
	    			viewModel.model.supplierId = data.rows[0].supplierId
	    			//供应商地点
	    			viewModel.model.set('supplierSiteName',data.rows[0].supplierSiteName);
	    			viewModel.model.supplierSiteId = data.rows[0].supplierSiteId
					//工厂
	    			viewModel.model.set('plantName',data.rows[0].plantName);
	    			viewModel.model.plantId = data.rows[0].plantId
	    			viewModel.model.set('remarks',data.rows[0].remarks);
	    			if(checkStr(data.rows[0].shipDate)){
		    			viewModel.model.set('shipDate',data.rows[0].shipDate.slice(0,10));
	    			}else{
	    				viewModel.model.set('shipDate',data.rows[0].shipDate)
	    			}
	    			viewModel.model.set('expectedDate',data.rows[0].expectedDate);
	    			if(data.rows[0].status == 'P'){
	    				$("#save").hide()
	    				$("#cancel").hide()
	    			} 
	    			$("#grid").data("kendoGrid").refresh();
	    			}
	    	});
    	}else{   	
	    	for(var i=0;i<parentData.length;i++){
	    		parentData[i].uomCode = parentData[i].unitCode;
	
	    		info[i] = new Object();
	    		info[i].itemCode= parentData[i].itemCode;
	    		info[i].itemName= parentData[i].itemName;
	    		info[i].itemVersion= parentData[i].itemVersion;
	    		info[i].uomCode= parentData[i].uomCode;
	    		info[i].shippingable=parentData[i].quantity - parentData[i].shipped;
	    		}
	    	var dto = {"supplierId" : parentData[0].supplierId}
	    	
			//供应商
			viewModel.model.set("supplierCode",parentData[0].supplierCode);
			viewModel.model.set("supplierName",parentData[0].supplierName);
			viewModel.model.supplierId = parentData[0].supplierId
			//供应商地点
			viewModel.model.set("supplierSiteName",parentData[0].supplierSiteName);
			viewModel.model.supplierSiteId = parentData[0].supplierSiteId
			//收货组织
			viewModel.model.set("plantName",parentData[0].plantName);
			viewModel.model.plantId = parentData[0].plantId
			$("#grid").data("kendoGrid").refresh();
			viewModel.model.set('status','N');
    	}
    	
    	initData = viewModel.model.toJSON();
	})
	function checkStr(str){
		if(str == null || str === '' ||typeof(str) == "undefined"){
    		return false;
    	}
		return true;
    }
      function p(s) {
        return s < 10 ? '0' + s : s
      }
	var flag = true;
	//保存
	viewModel.saveHeadLine = function(){
    	var dataHeadLine = $("#grid").data("kendoGrid")._data;

    	if(dataHeadLine.length>0){
    		var dirty = false;
        	for(var i=0;i<dataHeadLine.length;i++){
        		if(dataHeadLine[i].dirty){
        			dirty = true;
        		}
        	}
        	var ditryForm = true;
        	if(viewModel.model.shipDate === initData.shipDate && viewModel.model.expectedDate === initData.expectedDate 
        			&& viewModel.model.remarks === initData.remarks){
        		ditryForm = false;
        	}
        	if(dirty || ditryForm){         		
	    		if(!checkStr(viewModel.model.shipDate)||!checkStr(viewModel.model.expectedDate)){
	    			kendo.ui.showInfoDialog({
		    			title: '<@spring.message "hap.tip.info"/>',
		    			message: '<@spring.message "error.srm_purchase_0037"/>'
		    		})
		    		return;
	    		}
	    		//头数信息
	    		dataHeadLine[0].ticketNumber =viewModel.model.ticketNumber;
	    		dataHeadLine[0].supplierId = viewModel.model.supplierId;
	    		dataHeadLine[0].supplierSiteId = viewModel.model.supplierSiteId;
	    		dataHeadLine[0].plantId = viewModel.model.plantId;
	    		var shipDate;
	    		if(viewModel.model.shipDate.length == 10){
	    			shipDate= viewModel.model.shipDate + ' 00:00:00'
	    		}else{
	    			shipDate = viewModel.model.shipDate
	    		}
	    		dataHeadLine[0].shipDate =  shipDate;
	    		dataHeadLine[0].expectedDate = viewModel.model.expectedDate;
	    		dataHeadLine[0].remarksH = viewModel.model.remarks;
	    		var errorHave = false;
	    		for(var i=0;i<dataHeadLine.length;i++){
	    			if(!checkStr(dataHeadLine[i].shipQuantity) || !checkStr(dataHeadLine[i].itemVersion) || !checkStr(dataHeadLine[i].lotsNum) || !checkStr(dataHeadLine[i].packetInfo)){
	    				errorHave = true;
	    			}
	    		}
	    		if(errorHave){
	    			kendo.ui.showConfirmDialog({
		    			title: '<@spring.message "hap.tip.info"/>',
		    			message: '<@spring.message "error.srm_purchase_10001"/>'
		    		}).done(function (e) {
	                    if(e.button.toUpperCase() == "OK"){
	        	    		$.ajax({
	        					url:"${base.contextPath}/hcs/delivery/ticket/l/saveHeadLine",
	        					type:"POST",
	        					data: kendo.stringify(dataHeadLine),
	        					contentType: "application/json",
	        					success: function (data){
	        						if(data.success){
	        							if(!(parentData[0].enableFlag === 'F' || parentData[0].enableFlag === 'H')){
	        								Hap.showToast({
	        	                    			type:'success',
	        	                    			"positionClass": "toast-bottom-right",
	        	                    			message:data.message,
	        	                    			hideDuration:10*1000
	        	                    		})					
	        							}
	        							viewModel.model.set("ticketNumber",data.rows[0].ticketNumber);
	        							parentData[0].enableFlag = 'S' 
	        							parentData[0].id = data.rows[0].ticketId
	        							if(data.rows[0].headFlag === 'N'){
	        								viewModel.model.set('status','C');
	        							}
	        							window.parent.viewModel.refresh();
	        				    		viewModel.query();
	        				    		initData = viewModel.model.toJSON();
	        						}else{
	        							if(data.message == 'ErrorMessage'){
	        								kendo.ui.showErrorDialog({
	        									title: '<@spring.message "hap.error"/>',
	        					    			message: '<@spring.message "error.srm_purchase_0011"/>'
	        					    		})
	        							}else if(data.message == 'ErrorMessageDate'){
	        								kendo.ui.showErrorDialog({
	        									title:'<@spring.message "hap.error"/>',
	        					    			message: '<@spring.message "error.srm_purchase_0044"/>'
	        					    		})
	        							}else{
	        								kendo.ui.showErrorDialog({
	        									title: '<@spring.message "hap.error"/>',
	        					    			message: data.message
	        					    		})
	        							}
	        						}
	        					}
	        				});
	                    }
	                });
	    		}else{
		    		$.ajax({
						url:"${base.contextPath}/hcs/delivery/ticket/l/saveHeadLine",
						type:"POST",
						data: kendo.stringify(dataHeadLine),
						contentType: "application/json",
						success: function (data){
							if(data.success){
								if(!(parentData[0].enableFlag === 'F' || parentData[0].enableFlag === 'H')){
									Hap.showToast({
		                    			type:'success',
		                    			"positionClass": "toast-bottom-right",
		                    			message:data.message,
		                    			hideDuration:10*1000
		                    		})					
								}
								viewModel.model.set("ticketNumber",data.rows[0].ticketNumber);
								parentData[0].enableFlag = 'S' 
								parentData[0].id = data.rows[0].ticketId
								if(data.rows[0].headFlag === 'N'){
									viewModel.model.set('status','C');
								}
								window.parent.viewModel.refresh();
					    		viewModel.query();
					    		initData = viewModel.model.toJSON();
							}else{
								if(data.message == 'ErrorMessage'){
									kendo.ui.showErrorDialog({
										title: '<@spring.message "hap.error"/>',
						    			message: '<@spring.message "error.srm_purchase_0011"/>'
						    		})
								}else if(data.message == 'ErrorMessageDate'){
									kendo.ui.showErrorDialog({
										title:'<@spring.message "hap.error"/>',
						    			message: '<@spring.message "error.srm_purchase_0044"/>'
						    		})
								}else{
									kendo.ui.showErrorDialog({
										title: '<@spring.message "hap.error"/>',
						    			message: data.message
						    		})
								}
							}
						}
					});
	    		}
	    		

        	}
    	}
    }
    //取消送货单行
    viewModel.cancelLine = function(){
    	var grid = $("#grid").data("kendoGrid");
    	var checked = grid.selectedDataItems();
    	checked[0].ticketId = viewModel.model.ticketId;
    	var len = checked.length;
    	if(len === 0){
    		kendo.ui.showInfoDialog({
    			title: '<@spring.message "hap.tip.info"/>',
    			message: '<@spring.message "hap.tip.selectrow"/>'
    		})
    		return;
    	}
    	for(var i=0;i<len;i++){
    		if(checked[i].ticketLineId == null || checked[i].ticketLineId === '' ||typeof(checked[i].ticketLineId) == "undefined"){
    			kendo.ui.showInfoDialog({
					title: '<@spring.message "hap.tip.info"/>',
	    			message: '<@spring.message "error.srm_purchase_1059"/>'
	    		})
	    		return;
    		}
    	}
    	kendo.ui.showConfirmDialog({
    		title: '<@spring.message "po.confirm"/>',
    		message: '<@spring.message "error.srm_purchase_1057"/>'
    	}).done(function(e){
    		if(e.button=='OK'){
    			$.ajax({
    				url:"${base.contextPath}/hcs/delivery/ticket/l/cancelLine",
    				type:"POST",
    				data: kendo.stringify(checked),
    				contentType: "application/json",
    				success: function (data){
    					if(data.success){
    						if(data.rows[0].headFlag != null && data.rows[0].headFlag === 'N'){
    							viewModel.model.set('status','C');
    						}
    						window.parent.viewModel.refresh();
    			    		viewModel.query();
    					}else{
    						kendo.ui.showErrorDialog({
    							title: '<@spring.message "hap.error"/>',
    			    			message: data.message
    			    		})
    					}
    				}
    			}) 
    		}
    	})
    	
    }
    function closeWindow(){
    	window.parent.$('#LineWindow').data('kendoWindow').close();
    }
    var splitData;
    //拆分
    function split(id,num){
    	var grid = $("#grid").data("kendoGrid");
    	$("#grid").data("kendoGrid").addRow();// 在第1行增加
    	var dataHeadLine = $("#grid").data("kendoGrid")._data;
    	 var jsonData;
    	var idList = new Array();
    	if(num === 1 || num === 0){
    		idList.push(-1);
    		idList.push(id);
    		//送货单数据
    		jsonData = {
    			"ticketLineId" : id,
    			"ticketId" : viewModel.model.ticketId,
    			"lineLocationIdList":	JSON.stringify(idList).replace(/\[|]/g,'')
    		}
    	}else{
    		idList.push(id);
    		//采购订单数据
    		jsonData = {
    			"lineLocationIdList":	JSON.stringify(idList).replace(/\[|]/g,'')
    		}
    	}
    	$.ajax({
			url:"${base.contextPath}/hcs/delivery/ticket/l/query",
			type:"POST",
			data: jsonData,
			dataType: "json",
			success: function (data){
				if(data.success){
					if(num === 1 || num === 0){
						dataHeadLine[0].flagId = id;
					}
					dataHeadLine[0].ticketLineNum = dataHeadLine.length;
					dataHeadLine[0].itemCode = data.rows[0].itemCode;
					dataHeadLine[0].itemName = data.rows[0].itemName;
					dataHeadLine[0].itemVersion = data.rows[0].itemVersion;
					dataHeadLine[0].itemId = data.rows[0].itemId;
					dataHeadLine[0].uomCode = data.rows[0].uomCode;
					dataHeadLine[0].quantity = data.rows[0].quantity;
					dataHeadLine[0].shipped = data.rows[0].shipped;
					dataHeadLine[0].shippingable = data.rows[0].quantity - data.rows[0].shipped;
					dataHeadLine[0].needByDate = data.rows[0].needByDate;
					dataHeadLine[0].promisedDate = data.rows[0].promisedDate;
					dataHeadLine[0].poNumber = data.rows[0].poNumber;
					dataHeadLine[0].poHeaderId = data.rows[0].poHeaderId;
					dataHeadLine[0].lineNum = data.rows[0].lineNum;
					dataHeadLine[0].poLineId = data.rows[0].poLineId;
					dataHeadLine[0].shipmentNum = data.rows[0].shipmentNum;
					dataHeadLine[0].lineLocationId = data.rows[0].lineLocationId;
					dataHeadLine[0].lineLocationDesc = data.rows[0].lineLocationDesc;
					dataHeadLine[0].dirty = true;
					grid.refresh();
				}else{
					kendo.ui.showErrorDialog({
						title: "错误提示",
		    			message: data.message
		    		})
				}
			}
		}) 
    }
    var ticketNumber;
    //去打印
    viewModel.toPrint = function(){
        ticketNumber = $("#ticketNumber").val();
    	var dialog = $("#printWindow").kendoWindow({
				actions: ["Close"],
				width: "95%",
				height: "90%",
				title: '<@spring.message "srm.purchase.deliveryticketedit"/>',
				visible: false,
				iframe: true,
				modal: true,
				content: 'delivery_ticket_l.html'
			}).data("kendoWindow");
			dialog.center().open();
    }
    var parentJson = {};
    //绑定
    function bind(id,itemId,qty){
    	parentJson.ticketLineId = id;
    	parentJson.itemId = itemId;
    	parentJson.qty = qty;
    	parentJson.ticketId = viewModel.model.ticketId;
    	parentJson.plantId = viewModel.model.plantId;
    	parentJson.status = viewModel.model.status;
    	window.parent.parentJson = parentJson;
    	var dialog = window.parent.$("#bindWindow").kendoWindow({
			actions: ["Close"],
			width: 1400,
			height: 700,
			title: '<@spring.message "srm.purchase.bind"/>',
			visible: false,
			iframe: true,
			modal: true,
			content: 'delivery_ticket_bind.html',
			close : function(){
				viewModel.query();
			}
		}).data("kendoWindow");
		dialog.center().open();
    }
    //详情
    function detail(id,itemId,qty){
    	parentJson.ticketLineId = id;
    	parentJson.itemId = itemId;
    	parentJson.qty = qty;
    	parentJson.ticketId = viewModel.model.ticketId;
    	parentJson.plantId = viewModel.model.plantId;
    	parentJson.status = viewModel.model.status;
    	window.parent.parentJson = parentJson;
    	var dialog = window.parent.$("#bindWindow").kendoWindow({
			actions: ["Close"],
			width: 1400,
			height: 700,
			title: '<@spring.message "srm.purchase.bind"/>',
			visible: false,
			iframe: true,
			modal: true,
			content: 'delivery_ticket_bind.html'
		}).data("kendoWindow");
		dialog.center().open();
    }
    
</script>
<body>
<div id="bindWindow"></div>
<div id="printWindow"></div>
<div id="page-content" class="container" style="width:100%">
	<div id="head">
		<form class="form-horizontal">
			<div id="form">
					<div class="row">
					    <div class="pull-left" id="toolbar-btn" style="padding-bottom:10px;">
						    <span id="save" class="btn btn-success k-grid-save-changes" style="float:left;margin-right:5px;"
	                          data-bind="click:saveHeadLine"><i class="fa fa-save" style="margin-right:3px;"></i><@spring.message "hap.save"/></span>					    
					        <span id="cancel"  data-bind="click:cancelLine" class="btn btn-danger" style="float:left;margin-right:5px"><@spring.message "editorder.cancelticketline"/></span>
					        <!-- <span id="toPrint" class="btn btn-success k-grid-save-changes" data-bind="click:toPrint" style="float:left;margin-right:5px;"><@spring.message "去打印"/></span> -->
					        <span class="btn btn-primary k-grid-excel" style="float:left;margin-right:5px;" data-bind="click:exportExcel">
			    			<i class="fa fa-file-excel-o" style="margin-right:3px"></i><@spring.message "srm.exportexcel"/></span>
					       	<span type="button" class="btn btn-primary"
                         	style="float:left;margin-right:5px" onClick="closeWindow()"><i class="fa fa-undo" style="margin-right:3px;"></i><@spring.message "hap.back"/></span>					       	
					    </div>
					    <script>kendo.bind($('#toolbar-btn'), viewModel);</script>
					    <div class="pull-right" id="query-form" style="padding-bottom:10px;">
					           
					        <div style="clear:both"></div>
					    </div>
					    <script>kendo.bind($('#query-form'), viewModel);</script>
				    </div>
				    <div id="hide">
					    <div class="row" style="margin-top: 5px;font-size:small;width: 100%;">
					    		<!-- 送货单号 -->
							    <div class="col-sm-3">
							    	    <lable class="col-xs-4 control-lable" style="text-align:right;padding:0px;margin-top:2%"><@spring.message "edit.ticketNumber"/></lable>
							    	    <div class="col-xs-8"  style="padding:0px">
								    	    <input id="ticketNumber" disabled="disabled"  style="width: 100%"  data-role="maskedtextbox" type="text" data-bind="value:model.ticketNumber" data-lable="<@spring.message "送货单号"/>"/>
								    	    <script>kendo.bind($("#ticketNumber"),viewModel);</script>
							    	    </div>
							    </div>
							    
							    <!-- 送货单状态 -->
							    <div class="col-sm-3">
							    	    <lable class="col-xs-4 control-lable" style="text-align:right;padding:0px;margin-top:2%"><@spring.message "edit.status"/></lable>
							    	    <div class="col-xs-8" style="padding:0px">
								    	    <input id="status" style="width:100%" disabled="disabled" data-bind="value:model.status"/>
							    	    </div>
							    	    <script>
							    	    			kendo.bind($("#status"),viewModel);
								                   $("#status").kendoComboBox({
									               	    dataTextField: "meaning",
									               	    dataValueField: "value",
									               	    valuePrimitive: true,
									               	    dataSource: SRM_TICKET_STATUS,
									               	});
						                </script>
							    </div>
								<!-- 送货单类型 -->
<!-- 							    <div class="col-sm-3"> -->
<!-- 							    	    <lable class="col-xs-4 control-lable" style="text-align:right;padding:0px;margin-top:2%"><@spring.message "edit.ticketType"/></lable> -->
<!-- 							    	    <div class="col-xs-8" style="padding:0px"> -->
<!-- 							    	    	<input id="ticketType" style="width:100%" required data-bind="value:model.ticketType"> -->
<!-- 						    				<script type="text/javascript"> -->
<!-- // 						    					kendo.bind($("#ticketType"),viewModel) -->
<!-- // 						    					$("#ticketType").kendoComboBox({ -->
<!-- // 						    				        dataTextField: "meaning", -->
<!-- // 						    				        dataValueField: "value", -->
<!-- // 						    				        valuePrimitive: true, -->
<!-- // 						    				        dataSource:SRM_TICKET_TYPE -->
<!-- // 						    					}); -->
<!-- 						    				</script> -->
<!-- 							    	    </div> -->
<!-- 							    </div> -->
	
							   <!-- 供应商编码 -->
							    <div class="col-sm-3">
							    	    <lable class="col-xs-4 control-lable" style="text-align:right;padding:0px;margin-top:2%"><@spring.message "edit.supplierCode"/></lable>
							    	    <div class="col-xs-8" style="padding:0px">
								    	    <input id="supplierCode" style="width:100%" disabled="disabled"  data-role="maskedtextbox" type="text" data-bind="value:model.supplierCode"/>
							    	    	<script>kendo.bind($("#supplierCode"),viewModel);</script>
							    	    </div>
							    </div>
							    
							    <!-- 供应商名称 -->
							    <div class="col-sm-3">
							    	    <lable class="col-xs-4 control-lable" style="text-align:right;padding:0px;margin-top:2%;"><@spring.message "srm.suppliername"/>：</lable>
							    	    <div class="col-xs-8" style="padding:0px">
								    	    <input id="supplierName" disabled="disabled" style="width:110%" data-role="maskedtextbox" data-bind="value:model.supplierName" type="text"/>
							    	    	<script>kendo.bind($("#supplierName"),viewModel);</script>
							    	    </div>
							    </div>
					    </div>
					    <div class="row" style="margin-top: 1%;font-size:small;width: 100%;">
					    		
					    		<!-- 供应商地点 -->
<!-- 							    <div class="col-sm-3"> -->
<!-- 							    	    <lable class="col-xs-4 control-lable" style="text-align:right;padding:0px;margin-top:2%"><@spring.message "edit.supplierSiteName"/></lable> -->
<!-- 							    	    <div class="col-xs-8"  style="padding:0px"> -->
<!-- 								    	    <input id="supplierSiteName" style="width:100%" disabled="disabled" data-role="maskedtextbox" type="text" data-bind="value:model.supplierSiteName"/> -->
<!-- 								    	    <script>kendo.bind($("#supplierSiteName"),viewModel);</script>  -->
<!-- 							    	    </div> -->
<!-- 							    </div> -->
							    
							    
							    <!-- 工厂 -->
							    <div class="col-sm-3">
							    	    <lable class="col-xs-4 control-lable" style="text-align:right;padding:0px;margin-top:2%"><@spring.message "srm.purchase.plantname"/>：</lable>
							    	    <div class="col-xs-8" style="padding:0px">
							    	    		<input id="plantName" style="width:100%" data-role="maskedtextbox"  disabled data-bind="value:model.plantName"/>
							    	   			<script>kendo.bind($("#plantName"),viewModel);</script>
							    	    </div>
							    </div>
							    <!-- 发货日期 -->
							    <div class="col-sm-3">
							    	    <lable class="col-xs-4 control-lable" style="text-align:right;padding:0px;margin-top:2%"><@spring.message "edit.shipDate"/></lable>
							    	    <div id="ship" class="col-xs-8"  style="padding:0px">
								    	    <input id="shipDate" style="width:100%"  required type="text" data-bind="value:model.shipDate"/>
							    	    </div>
							    	    <script>
								    	    kendo.bind($("#shipDate"),viewModel);
								    	    $("#shipDate").kendoDatePicker({
					    					    format: "{0:yyyy-MM-dd}",
					    					});
							    	    </script>
							    </div>
							    <!-- 预计到货时间 -->
							    <div class="col-sm-3">
							    	    <lable class="col-xs-4 control-lable" style="text-align:right;padding:0px;margin-top:2%"><@spring.message "edit.expectedDate"/></lable>
							    	    <div id="expected" class="col-xs-8" style="padding:0px">
<!-- 								    	        <input id="expectedDate" type="text" required data-role="datetimepicker" style="width:110%;"data-bind="value:model.expectedDate" class="datetimepicker"> -->
								    	    <input id="expectedDate" required style="width:100%" type="text" data-bind="value:model.expectedDate"/>
								    	    <script>
									    	    kendo.bind($("#expectedDate"),viewModel);
									    	    $("#expectedDate").kendoDateTimePicker({
						    					    format: "{0:yyyy-MM-dd HH:mm:ss}",
						    					});
								    	    </script>
							    	    </div>
							    </div>
							    
							    <!-- 送货单备注 -->
							    <div class="col-sm-3">
							    	    <lable class="col-xs-4 control-lable" style="text-align:right;padding:0px;margin-top:2%"><@spring.message "edit.remarks"/></lable>
							    	    <div class="col-xs-8" style="padding:0px">
							    	    	<input id="remarks"  style="width:110%"   data-role="maskedtextbox" type="text" data-bind="value:model.remarks"/>
								    	    <script>kendo.bind($("#remarks"),viewModel);</script>
							    	    </div>
							    </div>
					    </div>
<!-- 					    <div class="row" style="margin-top: 1%;font-size:small;width: 100%;"> -->
					    		
<!-- 					    </div> -->
				    </div>
				    <div style="clear:both;margin-top:1%">
				        <div id="grid"></div>
				    </div>
			</div>
		</form>
	</div>
</div>
<script type="text/javascript">
    Hap.initEnterQuery('#query-form', viewModel.query);
    var BaseUrl = _basePath;
    dataSource = new kendo.data.DataSource({
         transport: {
            read: {
                url: BaseUrl + "/hcs/delivery/ticket/l/query",
                type: "POST",
                dataType: "json"
            },
            update: {
                url: BaseUrl + "/hcs/po/line/locations/submit",
                type: "POST",
                contentType: "application/json"
            },
            destroy: {
                url: BaseUrl + "/hcs/po/line/locations/remove",
                type: "POST",
                contentType: "application/json"
            },
            create: {
                url: BaseUrl + "/hcs/po/line/locations/submit",
                type: "POST",
                contentType: "application/json"
            },
            parameterMap: function (options, type) {
                if (type !== "read" && options.models) {
                    var datas = Hap.prepareSubmitParameter(options, type)
                    return kendo.stringify(datas);
                } else if (type === "read") {
                	var idArr = new Array();
                	if(parentData[0].enableFlag === 'N'){                		
	                	$.each(parentData,function(i,n){
	                		idArr.push(parentData[i].lineLocationId)
	                	})
                	}else if(parentData[0].enableFlag === 'S'){
                		viewModel.model.ticketId = parentData[0].id
                		idArr.push(-1)
                	}else{
                		var lineData = window.parent.lineData;
                		if(parentData[0].enableFlag != 'F'){
		                	$.each(parentData,function(i,n){
		                		idArr.push(parentData[i].lineLocationId)
		                	})
                		}
	                	idArr.push(-1)
                		$.each(lineData,function(i,n){
	                		idArr.push(lineData[i].ticketLineId)
	                	})
	                	viewModel.model.ticketId = parentData[0].id
	                	
                	}
                	
                	viewModel.model.lineLocationIdList = JSON.stringify(idArr).replace(/\[|]/g,'');
                	if(checkStr(viewModel.model.shipDate)){	
	                	var shipDate = viewModel.model.shipDate;
	                	if(shipDate.length == 10){
	                		viewModel.model.shipDate = viewModel.model.shipDate + ' 00:00:00';
	                	}
                	}
                    return Hap.prepareQueryParameter(viewModel.model.toJSON(), options)
                }
            }
        },
        batch: true,
        serverPaging: true,
        pageSize: 2,
        data:[],
        schema: {
            data: 'rows',
            total: 'total', 
            model: {
                id: "lineLocationId",
                fields: {
                	ticketLineNum:{
                		editable:false
                	},
                	cancelFlag:{
                		type:'boolean',
                		checkedValue:'Y',
                		uncheckedValue:'N',
                		defaultValue:'N',
                		editable:false,
                	},
                	operation:{
			        	editable:false
			        },
			        itemName:{
			        	editable:false
			        },
			        itemCode:{
			        	editable:false
			        },
			        lineStatus:{
			        	editable:false
			        },
			        uomCode:{
			        	editable:false
			        },
			        itemVersion:{
			        	 validation: {
			        		 	required: true,
	                        	itemVersionvalidation: function(input){
									if(input.val().length > 30){
										input.attr("data-itemVersionvalidation-msg", '<@spring.message "error.srm_purchase_1052"/>');
		                             	return false;
									}
	                            	return true;
	                            }
	                        },
			        },
			        shippingable:{
			        	editable:false
			        },
			        shipQuantity:{
			        	type:'number',
                        validation: {
                            required: true,
                            shipQuantityvalidation: function(input){
                            	var r = /^[1-9]/;
                            	if(!r.test(input.val())){
                            		 input.attr("data-shipQuantityvalidation-msg", '<@spring.message "error.srm_purchase_1060"/>');
                            		return false;
                            	}
                            	return true;
                            }
                        },
			        },
			        packetQuantity:{
			        	type:'number',
                        validation: {
                        	min: 0,
                        },
			        },
			        outsideBoxQuantity:{
			        	type:'number',
                        validation: {
                        	min: 0,
                        },
			        },
			        needByDate:{
			        	editable:false
			        },
			        promisedDate:{
			        	editable:false
			        },
			        poNumber:{
			        	editable:false
			        },
			        lineNum:{
			        	editable:false
			        },
			        shipmentNum:{
			        	editable:false
			        },
			        lineLocationDesc:{
			        	editable:false
			        },
			        lotsNum:{
			        	 validation: {
			        		 	required: true,
			        		 	lotsNumvalidation: function(input){
									if(input.val().length > 240){
										input.attr("data-lotsNumvalidation-msg", '<@spring.message "error.srm_purchase_1053"/>');
		                             	return false;
									}
	                            	return true;
	                            }
	                        },
			        },
			        spreading:{
			        	 validation: {
			        		 	spreadingvalidation: function(input){
									if(input.val().length > 30){
										input.attr("data-spreadingvalidation-msg", '<@spring.message "error.srm_purchase_1052"/>');
		                             	return false;
									}
	                            	return true;
	                            }
	                        },
			        },
			        packingSize:{
			        	 validation: {
			        		 packingSizevalidation: function(input){
									if(input.val().length > 30){
										input.attr("data-packingSizevalidation-msg", '<@spring.message "error.srm_purchase_1052"/>');
		                             	return false;
									}
	                            	return true;
	                            }
	                        },
			        },
			        remarks:{
			        	 validation: {
			        		 remarksvalidation: function(input){
									if(input.val().length > 240){
										input.attr("data-remarksvalidation-msg", '<@spring.message "error.srm_purchase_1053"/>');
		                             	return false;
									}
	                            	return true;
	                            }
	                        },
			        },
                },
                editable: function(col){
                	if(status === 'P' || this.lineStatus === 'C'){
                		return false;
                	}else{
                		if(col  == 'packingSize' || col  == 'spreading' || col  == 'itemVersion' ||col  == 'shipQuantity' || col == 'lotsNum' || col == 'packetQuantity' || col == 'outsideBoxQuantity' || col == 'packetInfo' || col == 'remarks'){
                			return true;
                		}else{
                			return false;
                		}
                	}
                }
            }
        }
    });

    $("#grid").kendoGrid({
    	excel: {
    		fileName:"送货单创建-明细.xlsx",
    		filterable: true,
    	},
    	excelExport: function(e){
    		var rows = e.workbook.sheets[0].rows;
    		var datas = e.data;
    		rows[0].cells[6].value = rows[0].cells[6].value.split('</span>')[1]
    		rows[0].cells[8].value = rows[0].cells[8].value.split('</span>')[1]
    		rows[0].cells[11].value = rows[0].cells[11].value.split('</span>')[1]
    		rows[0].cells[12].value = rows[0].cells[12].value.split('</span>')[1]
    		for(var i=1;i<rows.length; i++){
    			rows[i].cells[1].value = Hap.getCodeMeaning(SRM_TICKET_LINE_STATUS,datas[i-1].lineStatus);
    			rows[i].cells[10].value = shippingableList[i-1]
    			rows[i].cells[12].value = Hap.getCodeMeaning(SRM_PACKING_TYPE,datas[i-1].packetInfo);
    			//rows[i].cells[1].value = datas[i-1].cancelFlag;
    		}
    	},
        dataSource: dataSource,
        resizable: true,
        scrollable: true,
        sortable:true,
        navigatable: false,
        selectable: 'multiple, rowbox',
        dataBound: function () {
            if (parent.autoResizeIframe) {
                parent.autoResizeIframe('${RequestParameters.functionCode!}')
            }
        }, 
//         pageable: {
//             pageSizes: [50, 100, 200, 'ALL'],
//             refresh: true,
//             buttonCount: 5
//         },
        columns: [
        	{
                field: "",
                title: '<@spring.message "editoder.operate"/>',
                width: 50,
                attributes: {style: "text-align:center;white-space: nowrap;"},
                headerAttributes: {style: "text-align:center"},
                template: function(rowdata){
                	if(rowdata.lineStatus === "C"){
                		return '<span></span>'
                	}else if(rowdata.flagId!=null){
                		return '<a href="javascript:void(0)" onclick="split('+rowdata.flagId+",0"+')"><@spring.message "editoder.split"/></a>'
                	}else if(rowdata.ticketLineId!=null){
                		return '<a href="javascript:void(0)" onclick="split('+rowdata.ticketLineId+",1"+')"><@spring.message "editoder.split"/></a>'
                	}else{	
                		return '<a href="javascript:void(0)" onclick="split('+rowdata.lineLocationId+",2"+')"><@spring.message "editoder.split"/></a>'
                	} 
                },
                //locked:true
            },
//             {
//                 field: "cancelFlag",
//                 title: '<@spring.message "editorder.cancelFlag"/>',
//                 width: 120,
//                 attributes: {style: "text-align:center;white-space: nowrap;"},
//                 headerAttributes: {style: "text-align:center"},
//                 //locked:true
//             },
            {
                field: "ticketLineNum",
                title: '<@spring.message "editorder.ticketLineNum"/>',
                width: 50,
                attributes: {style: "text-align:center;white-space: nowrap;"},
                headerAttributes: {style: "text-align:center"},
                //locked:true
            },
                    {
                field: "lineStatus",
                title: '<@spring.message "polinelocations.lineStatus"/>',
                width: 70,
                attributes: {style: "text-align:center;white-space: nowrap;"},
                headerAttributes: {style: "text-align:center"},
                template: function (dataItem) {
                    var v = dataItem.lineStatus ? dataItem.lineStatus : "N";
                    dataItem.lineStatus = v
                    $.each(SRM_TICKET_LINE_STATUS, function (i, n) {
                        if ((n.value || '').toLowerCase() == (v || '').toLowerCase()) {
                            v = n.meaning;
                            return v;
                        }
                    });
                    return v;
                },
                editor: function (container, options) {
                    $('<input name="' + options.field + '"/>')
                        .appendTo(container)
                        .kendoDropDownList({
                            dataTextField: "meaning",
                            dataValueField: "value",
                            valuePrimitive: true,
                            dataSource:SRM_TICKET_LINE_STATUS
                        });
                }
            },
            {
                field: "poNumber",
                title: '<@spring.message "polinelocations.poNumber"/>',
                width: 100,
                attributes: {style: "text-align:center;white-space: nowrap;"},
                headerAttributes: {style: "text-align:center"}
            },
                    {
                field: "lineNum",
                title: '<@spring.message "polinelocations.lineNumber"/>',
                width: 60,
                attributes: {style: "text-align:center;white-space: nowrap;"},
                headerAttributes: {style: "text-align:center"}
            },
            {
                field: "itemCode",
                title: '<@spring.message "polinelocations.itemCode"/>',
                width: 120,
                attributes: {style: "text-align:center;white-space: nowrap;"},
                headerAttributes: {style: "text-align:center"}
            },
            {
                field: "itemName",
                title: '<@spring.message "polinelocations.itemName"/>',
                width: 120,
                attributes: {style: "text-align:center;white-space: nowrap;"},
                headerAttributes: {style: "text-align:center"}
            },
            {
                field: "itemVersion",
                title: '<span style='+'color:red>'+'*&nbsp;</span>' + '<@spring.message "polinelocations.itemVersion"/>',
                width: 80,
                attributes: {style: "text-align:center;white-space: nowrap;"},
                headerAttributes: {style: "text-align:center"}
            },
                    {
                field: "uomCode",
                title: '<@spring.message "polinelocations.uomCode"/>',
                width: 50,
                attributes: {style: "text-align:center;white-space: nowrap;"},
                headerAttributes: {style: "text-align:center"}
            },
            {
                field: "shipQuantity",
                title: '<span style='+'color:red>'+'*&nbsp;</span>' + '<@spring.message "polinelocations.shipQuantity"/>',
                width: 80,
                attributes: {style: "text-align:center;white-space: nowrap;"},
                headerAttributes: {style: "text-align:center"}
            }, 
            {
                field: "packingQty",
                title: '<@spring.message "polinelocations.packingQty"/>',
                width: 100,
                attributes: {style: "text-align:center;white-space: nowrap;"},
                headerAttributes: {style: "text-align:center"}
            },
            {
                field: "shippingable",
                title: '<@spring.message "polinelocations.shippingable"/>',
                width: 60,
                attributes: {style: "text-align:center;white-space: nowrap;"},
                headerAttributes: {style: "text-align:center"},
                template: function(rowdata){
                	shippingableList.push(rowdata.quantity - rowdata.shipped)
                	return '<span>'+(rowdata.quantity - rowdata.shipped)+'</span>'
                } 
            },
                  
            {
                field: "lotsNum",
                title: '<span style='+'color:red>'+'*&nbsp;</span>' + '<@spring.message "polinelocations.lotsNum"/>',
                width: 120,
                attributes: {style: "text-align:center;white-space: nowrap;"},
                headerAttributes: {style: "text-align:center"}
            },
                    {
                field: "packetInfo",
                title: '<span style='+'color:red>'+'*&nbsp;</span>' + '<@spring.message "polinelocations.packetInfo"/>',
                width: 120,
                attributes: {style: "text-align:center;white-space: nowrap;"},
                headerAttributes: {style: "text-align:center"},
                template: function (dataItem) {
                    var v = dataItem.packetInfo ? dataItem.packetInfo : "";
                    $.each(SRM_PACKING_TYPE, function (i, n) {
                        if ((n.value || '').toLowerCase() == (v || '').toLowerCase()) {
                            v = n.meaning;
                            return v;
                        }
                    });
                    return v;
                },
                editor: function (container, options) {
                    $('<input required name="' + options.field + '"/>')
                        .appendTo(container)
                        .kendoDropDownList({
                            dataTextField: "meaning",
                            dataValueField: "value",
                            valuePrimitive: true,
                            dataSource:SRM_PACKING_TYPE
                        });
                }
            },
//             {
//                 field: "packetQuantity",
//                 title: '<@spring.message "polinelocations.packetQuantity"/>',
//                 width: 120,
//                 attributes: {style: "text-align:center;white-space: nowrap;"},
//                 headerAttributes: {style: "text-align:center"}
//             },
//                     {
//                 field: "outsideBoxQuantity",
//                 title: '<@spring.message "polinelocations.outsideBoxQuantity"/>',
//                 width: 120,
//                 attributes: {style: "text-align:center;white-space: nowrap;"},
//                 headerAttributes: {style: "text-align:center"}
//             },
			{
                field: "spreading",
                title: '<@spring.message "polinelocations.spreading"/>',
                width: 120,
                attributes: {style: "text-align:center;white-space: nowrap;"},
                headerAttributes: {style: "text-align:center"}
            },
            {
                field: "packingSize",
                title: '<@spring.message "polinelocations.packingSize"/>',
                width: 120,
                attributes: {style: "text-align:center;white-space: nowrap;"},
                headerAttributes: {style: "text-align:center"}
            },
            {
                field: "",
                title: '<@spring.message "editoder.codeinfo"/>',
                width: 120,
                attributes: {style: "text-align:center;white-space: nowrap;"},
                headerAttributes: {style: "text-align:center"},
                template: function(rowdata){
                	if(rowdata.lineStatus === "C"){
                		return '<span></span>'
                	}else if(rowdata.lineStatus === "N"){
                		return '<a style="color:blue" href="javascript:void(0)" onclick="bind('+rowdata.ticketLineId+","+ rowdata.itemId+","+ rowdata.shipQuantity +')"><@spring.message "editoder.bind"/></a>'
                	}else if(rowdata.lineStatus === "P"){
                		return '<a style="color:blue" href="javascript:void(0)" onclick="detail('+rowdata.ticketLineId+","+ rowdata.itemId+","+ rowdata.shipQuantity +')"><@spring.message "editoder.detail"/></a>'
                	}else{	
                		return '<span></span>'
                	} 
                },
                //locked:true
            },
            {
                field: "barcodeQty",
                title: '<@spring.message "polinelocations.barcodeQty"/>',
                width: 120,
                attributes: {style: "text-align:center;white-space: nowrap;"},
                headerAttributes: {style: "text-align:center"}
            },
                    {
                field: "remarks",
                title: '<@spring.message "polinelocations.remarks"/>',
                width: 120,
                attributes: {style: "text-align:center;white-space: nowrap;"},
                headerAttributes: {style: "text-align:center"}
            },
            
//                     {
//                 field: "needByDate",
//                 title: '<@spring.message "polinelocations.needByDate"/>',
//                 width: 150,
//                 attributes: {style: "text-align:center;white-space: nowrap;"},
//                 headerAttributes: {style: "text-align:center"}
//             },
//             {
//                 field: "promisedDate",
//                 title: '<@spring.message "polinelocations.promisedDate"/>',
//                 width: 150,
//                 attributes: {style: "text-align:center;white-space: nowrap;"},
//                 headerAttributes: {style: "text-align:center"}
//             },
                    
                    {
                field: "shipmentNum",
                title: '<@spring.message "polinelocations.shipmentNum"/>',
                width: 120,
                attributes: {style: "text-align:center;white-space: nowrap;"},
                headerAttributes: {style: "text-align:center"}
            },
        ],
        editable: true
    });
    Hap.autoResizeGrid('#grid');
</script>
</body>
</html>