<#include "../include/header.html"> 
 <script src="${base.contextPath}/common/code?HQM_8D_PROBLEM_SOURCE=HQM_8D_PROBLEM_SOURCE"></script>
 <script src="${base.contextPath}/common/code?HPM_ECR_ONHAND_STATUS=HPM_ECR_ONHAND_STATUS"></script>
 <script src="${base.contextPath}/common/code?HQM_8D_PROBLEM_LEVEL=HQM_8D_PROBLEM_LEVEL"></script>
 <script src="${base.contextPath}/common/code?HQM_8D_PROBLEM_TYPE=HQM_8D_PROBLEM_TYPE"></script>
 <script src="${base.contextPath}/common/code?HPM_ITEM_RESULT=HPM_ITEM_RESULT"></script>
 <body>
<style>

  .btn-foot{
        width: 95%;
        position: absolute;
        bottom: 20px;
    }
#_loading_div {
    vertical-align: middle;
    display: inline-block;
    width: 100%;
    height: 100%;
    margin: 0 auto;
    text-align: center;
    position: absolute;
    z-index: 3;
    line-height: 20;
    opacity: 0.7;
    display: none;
    position: absolute;
    top: 0px;
    background: #f7f7f7;
       
}


.data-table {
        width: 100%;
        text-align: center;
        border-color: #DDDDDD;
    }

    .data-thead {
        color: #758697;
        background-color: #F5F5F5;
    }

    .data-table .data-thead tr {
        height: 40px;
    }

    .data-table .data-thead th {
        padding: 0px;
        text-align: center;
        font-weight: bold;
        font-family: "Helvetica Neue", "Luxi Sans", "DejaVu Sans", Tahoma, "Microsoft Yahei", "Hiragino Sans GB", sans-serif;
        font-size: 12px;
    }

    .data-table .data-thead th div {
        width: 100%;
        height: 100%;
        padding: 10px;
        position: relative;
        background-color: #F5F5F5;
    }

    .data-tbody {
        font-weight: 100;
        color: #758697;
        font-family: "Helvetica Neue", "Luxi Sans", "DejaVu Sans", Tahoma, "Microsoft Yahei", "Hiragino Sans GB", sans-serif;
        font-size: 12px;
    }

    .data-tbody tr{
        height: 35px;
    }

    .data-tbody td{
        padding: 5px 10px;
    }
     div[role=tooltip].k-tooltip{
        padding: 2px;
        background: #5c9acf;
    }
    .k-tooltip-content{
        padding: 4px;
        text-align: left;
        background: #fff;
        color: #666;
    }
    .k-callout {
        border-bottom-color: #5c9acf;
    }
</style>

<script>
var toolTipOpt = {
	    show: function(e){
	        if($.trim(this.content.text()) !=""){
	            $('[role="tooltip"]').css("visibility", "visible");
	        }
	    },
	    hide: function(){
	        $('[role="tooltip"]').css("visibility", "hidden");
	    },
	    filter: "td:nth-child(n+3)",
	    content: function(e){
	        var element = e.target[0];
	        if(element.offsetWidth < element.scrollWidth){
	            var text = $(e.target).text();
	            return '<div style="min-width:100px;max-width: 1000px;">' + text + '</div>';
	        }else{
	            //解决鼠标一开始放在上面出现空模块
	            $('[role="tooltip"]').css("visibility", "hidden");
	            return "";
	        }
	    }
	};

var viewModel =Hap.createGridViewModel("#gridItem");  
viewModel.model.ecrno= "${RequestParameters.ecrno!}";
var userId= "${Session.employeeCode!}";

 function onhandSave(itemId,buyer){
	 // var row=$("#gridItem").data("kendoGrid").select();
var detailFlag=true;	
		if( buyer==userId){
			detailFlag=false;
 	     }
   	else{
   		detailFlag=true;
   	}
	 var dialog =  window.parent.$("#onhandWindow").kendoWindow({
         actions: ["Close"],
         width: "96%",
         height: "60%",
         title: '库存明细',
         visible: false,
         iframe: true,
         modal: true,
         content: 'pspc_ecr_details.html?ecrno=' + viewModel.model.ecrno+'&itemId='+itemId+'&mode='+detailFlag	,
         close: function () {
        	 var grid = $("#gridItem").data("kendoGrid").dataSource.read(); 
         }
     }).data("kendoWindow");
     dialog.center().open(); 
 }
 
 
</script>


<div style="width:98%">
 <div id="tabContent" class="tab-content">
	  <ul class="nav nav-tabs" id="mytab">
	        <li id="inboundtab" style="margin-top: 10px; margin-left: 10px;"><@spring.message "ecritemcontrol.items"/></li>
	        <li id="outboundtab1" style="margin-top: 10px; margin-left: 10px;"><@spring.message "ecritemcontrol.report"/></li>
	        <li id="approveQuery" style="margin-top: 10px; margin-left: 10px;"><@spring.message "ecritemcontrol.approveQuery"/></li>
	               
	    </ul>

<!--<div class="row"> -->
<!--<div class="col-xs-1">-->
<!--		  -->
<!--		</div>-->
<!--		 <div class="col-xs-10" > -->
<!--<div class="pull-right" id="toolbar-btn" style="padding-bottom:10px;">-->
<!--        <span class="btn btn-primary k-grid-add " style="float:left;margin-right:5px;" onclick="onhandSave()"><@spring.message "ecrmain.onhand"/></span>         -->
<!--    </div>-->
<!--    </div>-->
<!--    -->
<!--     <div class="col-xs-1">-->
<!--	</div>-->
<!--    </div>-->
<div   class="tab-pane fade in active" style="margin-top: 10px;">
	
    <script>kendo.bind($('#toolbar-btn'), viewModel);</script>
	<div id="gridRow" class="row"> 
		<div class="col-xs-1">
		  
		</div>
		 <div class="col-xs-10" style="height:100%;"> 
		  <div  id="gridItem" style="width:100%;height:100%;float:left" ></div> 
         </div>
         <div class="col-xs-1">
		</div>
	</div>
	<div id="autoResult" display="none" class="row"> 
		<div class="col-xs-1">
		  
		</div> 
		<div class="col-xs-10" > 
			 <div id="dataTableDiv"  >
		            <!-- table id="dataTable" border="1" cellpadding="0px" cellspacing="0px" class="data-table">
		                <thead id="dataThead" class="data-thead"></thead>
		                <tbody id="dataTbody" class="data-tbody"></tbody>
		            </table> -->
		        </div>
        </div>
        <div class="col-xs-1">
		</div>
	</div>
	<!-- 根据替换物料进行数据计算，前台目前先不开发，逻辑清楚后进行前台编写 -->
	 
	
	
	
	
	 		  	 		
	  <div id="mainBottom" class="text-center  " style="   float: left;padding-top:15px;width:100%; background: #fff;">
	        <span id="confirms" class="btn btn-primary"  onclick="commit()" type="submit" style="margin-right:5px"><@spring.message "hap.commit"/></span>
	      
	        <span class="btn btn-default" data-bind="click:closeWin" type="button" style="margin-right:25px;"><@spring.message "hap.cancel"/></span>
	 </div>
	 </div>
	 <div   class="tab-pane fade " style="margin-top: 10px; ">
	  <div class="row">
	  	<div class="col-xs-9 col-xs-push-1 col-xs-pull-1">
	  		<span id="testReport" class="btn btn-primary"  onclick="testReport()" type="submit" style="margin-right:5px"><@spring.message "hap.commit"/></span>
	  	</div> 	
	  		
	  </div>
		 <div class="row"> 				 
				<div class="col-xs-9 col-xs-push-1 col-md-pull-1" > 
					 <div id="dataTableDiv1"  >
				         
				        </div>
		        </div>		        
			</div>
				<div class="row"> 				
				<div class="col-xs-9 col-xs-push-1 col-md-pull-1" style="margin-top:50px	" > 
					 <div id="gridReport"  >				           
				        </div>
		        </div>		        
			</div>
			<div class="row"> 				
				<div class="col-xs-9 col-xs-push-1 col-md-pull-1" > 
					 <div id="gridReportDetail"  >				           
				        </div>
		        </div>		        
			</div>
	 </div>
	 
	 	<!-- 审批信息 -->
		<div class="tab-pane fade " style="margin-top: 10px;">
			<iframe id="approveHistory" style="width:100%;height:1000px;frameborder=no;border:none" ></iframe> 
		</div>
 </div> 
</div>



<script>
	/* 查询审批信息 */
	var urlPid = "${base.contextPath}/hpm/ecr/process/query?ecrno=";
	var processCode = "MatScrapSolutionApprOfECR";
	//var ecrno = "ECR20200359";
	var ecrno = viewModel.model.ecrno;
	console.log("ecrno")
	// 查询 processInstanceId
   	$.ajax({
 		url: urlPid + ecrno + "&processCode=" + processCode,
 		async:false,
 		success:function(data){ 			
 			if(data.rows.length > 0){
				var processInstanceId = data.rows[0].processId;
				var currentTaskId = "";
				// 查询 taskId
		    	$.ajax({
	   				url: "${base.contextPath}/hqm/measure/tool/scrap/queryTask?processInstanceId="+processInstanceId,
	   				async:false,
	   				success:function(data){
	   					if(data && data.rows && data.rows.length > 0){
  							currentTaskId = data.rows[0].taskId;
	   					}
	   				}
	   			})
	   			if(currentTaskId){
	   				var urlHis = "${base.contextPath}/activiti/approve_history.html?processInstanceId="+processInstanceId;
					$("#approveHistory").attr("src", urlHis);
					console.log("taskId")
	   			} else if(processInstanceId){
	 				var urlHis = "${base.contextPath}/activiti/approve_history_view.html?processInstanceId="
  	 						+processInstanceId + "&ecrno=" + ecrno;
					$("#approveHistory").attr("src", urlHis);	
					console.log("processId")
   	 			}
 			}
 		}
 	});
</script>

<script type="text/javascript">	
function testReport(){
	
		 	
	 loading.baosight.showPageLoadingMsg(true);
	 var data= viewModel.model.toJSON();
	 $.ajax({
	        url: '${base.contextPath}/hpm/ecr/item/report/job/create',
	        data:JSON.stringify( data ) ,
	        type: 'POST',
	        dataType: 'json',
	        contentType: "application/json;charset=UTF-8",
	        success: function (args) {
	        	if(args.success){
	        	 kendo.ui.showInfoDialog({
                    title: $l('hap.tip.info'),
                    message: "成功"
                });
	        	 location.reload();
	        	}
	        	else{
	        		kendo.ui.showInfoDialog({
	                     title: $l('hap.tip.info'),
	                     message:args.message
	                 });
	        	}
	        	loading.baosight.hidePageLoadingMsg();
	        },
	        async: true
	    });
}

var tabToActivate = $("#inboundtab");

var tabstrip =$("#tabContent").kendoTabStrip({
    animation: {
        close: {
            duration: 200,
            effects: "fadeOut"
        },
        open: {
            duration: 200,
            effects: "fadeIn"
        }
    }
}
).data("kendoTabStrip");  

tabstrip.activateTab(tabToActivate);


//点击现有申请单进入界面时，不允许修改
var loading = {
    baosight: {
        showPageLoadingMsg: function (showMessage) {
            if ($("#_loading_div").length == 0) {
                $("body").append('<div id="_loading_div" style="font-size: 24px"> <i class="fa fa-refresh fa-spin"></i><span><@spring.message "calberporder.info"/></span></div>');
            }
            $("#_loading_div").show();
        },
        hidePageLoadingMsg: function () {
            $("#_loading_div").hide();
        }
    }
}

var webWidth=window.screen.availHeight*0.2; 
$('#gridItem').css("height",webWidth); 


function commit(){
	if(viewModel.model.readFlag=="Y"){
		return;
	}
	  	 var all=	$("#gridItem").data("kendoGrid").dataSource.data();
	 var array=[];
	 for(var i=0;i<all.length;i++){
		 viewModel.model.onhandStatus=all[i].onhandStatus;
		 viewModel.model.onhandQty=all[i].onhandQty;
		 viewModel.model.kid=all[i].kid; 
		 viewModel.model.itemId=all[i].itemId; 
		 array.push(viewModel.model.toJSON());
	 }
	 
	 loading.baosight.showPageLoadingMsg(true);
	// var data= viewModel.model.toJSON();
	 $.ajax({
	        url: '${base.contextPath}/hpm/ecr/influencedmaterial/item/control/save',
	        data:JSON.stringify( array ) ,
	        type: 'POST',
	        dataType: 'json',
	        contentType: "application/json;charset=UTF-8",
	        success: function (args) {
	        	if(args.success){
	        	 kendo.ui.showInfoDialog({
                     title: $l('hap.tip.info'),
                     message: "成功"
                 });
	        	 location.reload();
	        	}
	        	else{
	        		kendo.ui.showInfoDialog({
	                     title: $l('hap.tip.info'),
	                     message:args.message
	                 });
	        	}
	        	loading.baosight.hidePageLoadingMsg();
	        },
	        async: true
	    });
 }
var BaseUrl = _basePath;
var dataSource = new kendo.data.DataSource({
    transport: {
    	   read: {
               url: BaseUrl + "/hpm/ecr/influencedmaterial/bsquery",
               type: "POST",
               dataType: "json"
           },
        parameterMap: function (options, type) {
            if (type !== "read" && options.models) {
                var datas = Hap.prepareSubmitParameter(options, type)
                return kendo.stringify(datas);
            } else if (type === "read") {
                return Hap.prepareQueryParameter(viewModel.model.toJSON(), options)
            }
        }
    },
    requestEnd:function(e){
    	for(var i=0;i<e.response.rows.length;i++){
    		if(e.response.rows[i].onhandStatus!="A"){
	    		$("#confirms").text("保存");
	    		break;
    		}
    	}
    },
    batch: true,
    serverPaging: true,
    pageSize: 10,
    schema: {
    	data: 'rows',
        total: 'total',
        model: {
            id: "kid",
            fields: {
            	itemCode:{
                    
                     validation:{
                         required:true,
                         custom:function(e){
                        	 if(e[0]!= undefined && e[0] != ""){
                 			var length=e[0].value;
                 			var datas=$("#gridItem").data('kendoGrid').dataSource.data();
                 			$.each(datas,function(i,v){
                 				if(v.itemId==length){
                 					  
                 					return false;
                 				}
                 			});
                        	 }
                 			return true;
                 		}
                        
                     }
                 },
                 buyerId:{},
                 itemId:{}
            },
            editable: function (col) {
            	 
                if (col == 'itemCode') {
                	if (!this.isNew()) {
                        return false;
                    }
                    return true;
                };
                if (col == 'itemDescription') {
                    if (!this.isNew()) {
                        return false;
                    }
                    return true;
                };
                if (col == 'onhandStatus') {
                   
                    return true;
                };
                return false;
            }
        }
    }
});

 
$("#gridItem").kendoTooltip(toolTipOpt).data("kendoTooltip");
var grid = $("#gridItem").kendoGrid({
    dataSource: dataSource,
    resizable: true,
    scrollable: true,
    navigatable: false,
  	sortable:true,
    // selectable: 'multiple, rowbox',
    detailInit: detailInit,
    dataBound: function () {
        if (parent.autoResizeIframe) {
            parent.autoResizeIframe('${RequestParameters.functionCode!}')
        }
    },
    
    columns: [
        {
            field: "itemCode",
            title: '<@spring.message "asl.itemcode"/>',
            attributes:{style:"white-space:nowrap;text-overflow:ellipsis;"},
            width: 120,
            require:true,            
            template: function (dataItem) {
                return dataItem['itemCode'] || ''
            },
            editor: function (container, options) {
                $('<input name="' + options.field + '"/>')
                    .appendTo(container)
                    .kendoLov($.extend(<@lov "LOV_ITEM"/>, {
                    valueField: "itemId",
                    textField: 'itemCode',
                    model: options.model,
                    select: function(e) {
                        //options.model.set("itemId", e.item.itemId);
                         var datas=$("#gridItem").data('kendoGrid').dataSource.data();
             			var check=true;
             			$.each(datas,function(i,v){
             				if(v.itemId==e.item.itemId){
             					 kendo.ui.showErrorDialog({
            	                     title: $l('hap.tip.info'),
            	                     message: $l('<@spring.message "ecrmain.itemtip"/>')
            	                 });
             					 e.item.itemCode="";
             					  options.model.itemId="";
             					 options.model.itemCode="";
                                  options.model.set("itemDescription", ""); 
                                  check= false;
                                  return false;
             				}
             			});
                       if(check){
                    	   options.model.itemId=e.item.itemId;
                           options.model.set("itemDescription", e.item.itemDescriptions); 
                       }
                      
                    }
                }));
            }
        },
                {
            field: "itemDescription",
            title: '<@spring.message "asl.itemname"/>',
            attributes:{style:"white-space:nowrap;text-overflow:ellipsis;"},
            width: 120
        },  {
            field: "itemVersion",
            title: '<@spring.message "ecrmain.itemversion"/>',
            attributes:{style:"white-space:nowrap;text-overflow:ellipsis;"},
            width: 120
        },
        {
            field: "buyer",
            title: '<@spring.message "ecrmain.buyer"/>',
            attributes:{style:"white-space:nowrap;text-overflow:ellipsis;"},
            width: 120
        },      
        {
            field: "onhandQty",
            title: '<@spring.message "ecrmain.onhandqty"/>',
            width: 120,
            attributes:{style:"white-space:nowrap;text-overflow:ellipsis;"},
            attributes: {
                style: "text-align: right"
            },
            template:function (dataItem) {
            
                var onhandQty = dataItem.onhandQty;
                var itemId = dataItem.itemId;
                return onhandQty+'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<button id="btn-detail" type="button" onclick=onhandSave(\'' + itemId + '\',\''+dataItem.buyer+'\') class="btn btn-info btn-sm"><@spring.message "ecrmain.onhand"/> </button>';
            }
        },
        {
            field: "onhandStatus",
            title: '<@spring.message "ecrmain.onhandstatus"/>',
            width: 120,
            template: function (dataItem) {
                var v = dataItem.onhandStatus;
                $.each(HPM_ECR_ONHAND_STATUS, function (i, n) {
                    if ((n.value || '').toLowerCase() == (v || '').toLowerCase()) {
                        v = n.meaning;
                        return v;
                    }
                });
                
                return v;
            },
            editor: function (container, options) {
            	 
            		$('<input name="' + options.field + '"/>')
                    .appendTo(container)
                    .kendoDropDownList({
                        dataTextField: "meaning",
                        dataValueField: "value",
                        dataSource: HPM_ECR_ONHAND_STATUS,
                        valuePrimitive: true
                    }); 
            }
        },
                 
            
    ],
    editable: true,
    edit:function(e){
     if(e.model.buyerId!=userId){
    	 this.closeCell();
     }
    }
}).data("kendoGrid");
 
/*表格*/

function detailInit(e) {
    if (!e.data.itemId) {
        e.masterRow.find('.k-icon').removeClass('k-icon').removeClass('k-i-collapse')
        e.detailRow.remove()
        return false;
    }
    $("<div/>").appendTo(e.detailCell).kendoGrid({
        dataSource: {
            transport: {
                read: {
                    url: BaseUrl + "/hpm/ecr/influencedmaterial/bsdetailquery",
                    type: "POST", 
                    dataType: "json"
                },
                parameterMap: function (options, type) {
                	viewModel.model.set("materialId", e.data.itemId);
                   /* var data = JSON.stringify(viewModel.model.toJSON());
                    data = JSON.parse(data);
                    data["materialId"] = e.data.itemId;
                    data["page"] = options.page;
                    data["pageSize"] = options.pageSize;*/
                    return Hap.prepareQueryParameter(viewModel.model.toJSON(), options)
                }
            },
            batch: true,
            serverPaging: true,
           //pageSize: 5,
            schema: {
                data: 'rows',
                total: 'total',
                model: {
                    id: "itemId",
                    fields: {
                        shiftDate: {
                            type: "Date"
                        }
                    },
                }
            }
        }, 
        sortable: true, 
        pageable: false,  
        columns: [
            {
                field: "skucode",
                title: '<@spring.message "ecrmain.skucode"/>',
                width: 80,
                headerAttributes: {style: "text-align:center"},
                attributes: {style: "text-align:center;white-space:nowrap;text-overflow:ellipsis;text-align:center;"},
                 
            },
            {
                field: "skuDescription",
                title: '<@spring.message "ecrmain.skudescription"/>',
                headerAttributes: {style: "text-align:center"},
                attributes: {style: "text-align:center;white-space:nowrap;text-overflow:ellipsis;text-align:center;"},
                width: 80,
            }, {
                field: "productType",
                title: '<@spring.message "platformprogram.platformtype"/>',
                width: 80,
                headerAttributes: {style: " text-align:center"},
                attributes: {style: "text-align:center;white-space:nowrap;text-overflow:ellipsis;text-align:center;"},
                 
            },
            {
                field: "products",
                title: '<@spring.message "ecrmain.products"/>',
                headerAttributes: {style: " text-align:center"},
                attributes: {style: "text-align:center;white-space:nowrap;text-overflow:ellipsis;text-align:center;"},
                width: 80,
            },
            {
                field: "qty",
                title: '<@spring.message "ecrmain.bomuse"/>',
                headerAttributes: {style: " text-align:center"},
                attributes: {style: "text-align:center;white-space:nowrap;text-overflow:ellipsis;text-align:center;"},
                width: 80,
            },
        ]
    });
    $("<div/>").appendTo(e.detailCell).kendoTooltip(toolTipOpt).data("kendoTooltip");
}



 
   function createHead(e){
    // console.info(resultList);

    //region  生成表格

    //region生成标题头
	var htmlHead = '<tr>\n' ;
	var all=	e.response.rows;
	 var array=[];
	 htmlHead+=   '                    <th style="text-align: center;color: #000000"><div>方案</div></th>\n' ;
	 for(var i=0;i<all.length;i++){		 
		 htmlHead+=   '                    <th style="text-align: center;color: #000000"><div>'+all[i].itemCode+'</div></th>\n' ;
	 }
	 htmlHead+=   '                    <th style="text-align: center;color: #000000"><div>报废金额</div></th>\n' ;
	 htmlHead+=   '                    <th style="text-align: center;color: #000000"><div>物料最长交货周期</div></th>\n' ;
	 htmlHead+=   '                    <th style="text-align: center;color: #000000"><div>建议切换时间</div></th>\n' ;
	 htmlHead+=   '                    <th style="text-align: center;color: #000000"><div>审批结果</div></th>\n' ;
	 

    //赋值table

    $('#dataThead').html(htmlHead); 
   }
   
   var dataSource1 = new kendo.data.DataSource({
	    
	    batch: true,
	    serverPaging: true,
	    pageSize: 10,
	    schema: {
	    	data: 'rows',
	        total: 'total',
	        model: {
	            id: "itemId",
	            fields: {
	            	itemCode:{
	                    
	                     validation:{
	                         required:true,
	                         custom:function(e){
	                        	 if(e[0]!= undefined && e[0] != ""){
	                 			var length=e[0].value;
	                 			var datas=$("#gridItem").data('kendoGrid').dataSource.data();
	                 			$.each(datas,function(i,v){
	                 				if(v.itemId==length){
	                 					  
	                 					return false;
	                 				}
	                 			});
	                        	 }
	                 			return true;
	                 		}
	                        
	                     }
	                 },
	                 ite3: {type: "date" }
	            },
	            editable: function (col) {
	            	if (this.isNew()) {
                        return true;
                    }
	                 
	                return false;
	            }
	        }
	    }
	});
   //$("#grid").data("kendoGrid").dataSource.data("");

 //最后一行插入行对象
 /*for(var i=0;i< args.rows.length;i++){
     $('#grid').data('kendoGrid').dataSource.insert(args.rows[i]);
 }*/
 $("#dataTableDiv").kendoTooltip(toolTipOpt).data("kendoTooltip");
 var grid1 = $("#dataTableDiv").kendoGrid({
     dataSource: dataSource1,
     resizable: true,
     scrollable: true,
     navigatable: false,
   	 sortable:false,
     selectable: false,   
     dataBound: function () {
         if (parent.autoResizeIframe) {
             parent.autoResizeIframe('${RequestParameters.functionCode!}')
         }
     },
    
     editable: false
 }).data("kendoGrid");
 Date.prototype.format = function (fmt) {
	    var o = {
	        "M+": this.getMonth() + 1, //月份
	        "d+": this.getDate(), //日
	        "h+": this.getHours(), //小时
	        "m+": this.getMinutes(), //分
	        "s+": this.getSeconds(), //秒
	        "q+": Math.floor((this.getMonth() + 3) / 3), //季度
	        "S": this.getMilliseconds() //毫秒
	    };
	    if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
	    for (var k in o)
	        if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
	    return fmt;
	}
 //初始化
 $.ajax({
	    url: '${base.contextPath}/hpm/ecr/influencedmaterial/item/control/result',
	    data:JSON.stringify( viewModel.model.toJSON() ) ,
	    type: 'POST',
	    dataType: 'json',
	    contentType: "application/json;charset=UTF-8",
	    success: function (args) { 
	    	 if(args.success){
	    			var columns = [];
	    		 if(args.rows.length>0){
	    			 for (var i =0; i < args.rows[0].itemCodes.length; i++) {
	    				 columns.push({
	    		 				field: "item" + i,
	    		 				title: args.rows[0].itemCodes[i],
	    		 				attributes:{style:"white-space:nowrap;text-overflow:ellipsis;"},
	    		 				width: 120
	    		 			});
	    			 } 
	    			 columns.push({
 		 				field: "ite1"  ,
 		 				title: "报废金额",
 		 				attributes:{style:"white-space:nowrap;text-overflow:ellipsis;"},
 		 				width: 120
 		 			});
	    			 columns.push({
 		 				field: "ite2" ,
 		 				title: "物料最长交货周期",
 		 				attributes:{style:"white-space:nowrap;text-overflow:ellipsis;"},
 		 				width: 120
 		 			});
	    			 columns.push({
 		 				field: "ite3" ,
 		 				title: "建议切换时间",
 		 				width: 120,
 		 				format: "{0:yyyy/MM/dd}",
 		 					attributes:{style:"white-space:nowrap;text-overflow:ellipsis;"},
 		 			});
	    			 columns.push({
 		 				field: "ite4"  ,
 		 				title: "审批结果",
 		 				attributes:{style:"white-space:nowrap;text-overflow:ellipsis;"},
 		 				width: 120,
 		 	            template: function (dataItem) {
 		 	                var v = dataItem.ite4;
 		 	                $.each(HPM_ITEM_RESULT, function (i, n) {
 		 	                    if ((n.value || '').toLowerCase() == (v || '').toLowerCase()) {
 		 	                        v = n.meaning;
 		 	                        return v;
 		 	                    }
 		 	                });
 		 	              var uid = dataItem.uid;
 		 	              if (dataItem.ite4 == "A") {
 		 	                    setTimeout(function () {
 		 	                         $("tr[data-uid=" + uid + "]").css("background", "green");
 		 	                         $("tr[data-uid=" + uid + "]").css("color", "white");
 		 	                     }, 0);
 		 	               } 
 		 	                return v;
 		 	            },
 		 	            editor: function (container, options) {
 		 	            	 
 		 	            		$('<input name="' + options.field + '"/>')
 		 	                    .appendTo(container)
 		 	                    .kendoDropDownList({
 		 	                        dataTextField: "meaning",
 		 	                        dataValueField: "value",
 		 	                        dataSource: HPM_ITEM_RESULT,
 		 	                        valuePrimitive: true
 		 	                    }); 
 		 	            } 		 				
 		 			});
	    		 
	    			 grid1.setOptions({
	    		 		columns: columns
	    		 	});
	    			 var viewModel1 =Hap.createGridViewModel(grid1);  
	    		 //加载列结束 新增数据	    			 	    		 	 
		    		 for (var i =0; i < args.rows.length; i++){
		    			 var value =[];		    			 
		    			 for(var j=0;j<args.rows[i].qtys.length;j++){
		    				 viewModel1.model.set("item" + j,args.rows[i].qtys[j]);
		    			 }
		    			 var date=new Date();
		    			 date=args.rows[i].adviceChangeTime;
		    			 date=new Date(date).format("yyyy-MM-dd");	
		    			 viewModel1.model.set("ite1", args.rows[i].scrap);
		    			 viewModel1.model.set( "ite2",args.rows[i].cycleDays);
		    			 viewModel1.model.set( "ite3",date);
		    			 viewModel1.model.set( "ite4",args.rows[i].status);
		    			 viewModel1.model.set( "groupId",args.rows[i].groupId);
		    			 grid1.dataSource.add(viewModel1.model);
		    			  
		    		 }
		    		 $('#autoResult').css('display','table');
		    		 $("#confirms").kendoButton({
		    		        enable: false
		    		    });
		    		 viewModel.model.readFlag="Y";
	    		 }
	    		 //如果查询不到数据证明不需要展示 则隐藏对应的gird
	    		 else{
	    			$('#autoResult').css('display','none'); 
	    			
	    		 }
	    	 }
	    },
	    async: false
});


 
 
 var dataSource2 = new kendo.data.DataSource({
	    
	    batch: true,
	    serverPaging: true,
	    pageSize: 10,
	    schema: {
	    	data: 'rows',
	        total: 'total',
	        model: {
	            id: "itemId",
	            fields: {
	            	itemCode:{
	                    
	                     validation:{
	                         required:true,
	                         custom:function(e){
	                        	 if(e[0]!= undefined && e[0] != ""){
	                 			var length=e[0].value;
	                 			var datas=$("#gridItem").data('kendoGrid').dataSource.data();
	                 			$.each(datas,function(i,v){
	                 				if(v.itemId==length){
	                 					  
	                 					return false;
	                 				}
	                 			});
	                        	 }
	                 			return true;
	                 		}
	                        
	                     }
	                 }
	            },
	            editable: function (col) {
	            	if (this.isNew()) {
                     return true;
                 }
	                 
	                return false;
	            }
	        }
	    }
	});
var gridss = $("#dataTableDiv1").kendoGrid({
dataSource: dataSource2,
resizable: true,
scrollable: true,
navigatable: false,
 sortable:true,
selectable: 'multiple, rowbox',   
dataBound: function () {
  if (parent.autoResizeIframe) {
      parent.autoResizeIframe('${RequestParameters.functionCode!}')
  }
},

editable: false
}).data("kendoGrid");
//初始化
$.ajax({
    url: '${base.contextPath}/hpm/ecr/influencedmaterial/item/control/result',
    data:JSON.stringify( viewModel.model.toJSON() ) ,
    type: 'POST',
    dataType: 'json',
    contentType: "application/json;charset=UTF-8",
    success: function (args) { 
    	 if(args.success){
    			var columns = [];
    		 if(args.rows.length>0){
    			 for (var i =0; i < args.rows[0].itemCodes.length; i++) {
    				 columns.push({
    		 				field: "item" + i,
    		 				title: args.rows[0].itemCodes[i],
    		 				width: 120
    		 			});
    			 }
    			 columns.push({
		 				field: "ite1"  ,
		 				title: "报废金额",
		 				width: 120
		 			});
    			 columns.push({
		 				field: "ite2" ,
		 				title: "物料最长交货周期",
		 				width: 120
		 			});
    			 columns.push({
		 				field: "ite3" ,
		 				title: "建议切换时间",
		 				width: 120
		 			});
    			 columns.push({
		 				field: "ite4"  ,
		 				title: "审批结果",
		 				width: 120,
		 	            template: function (dataItem) {
		 	                var v = dataItem.ite4;
		 	                $.each(HPM_ITEM_RESULT, function (i, n) {
		 	                    if ((n.value || '').toLowerCase() == (v || '').toLowerCase()) {
		 	                        v = n.meaning;
		 	                        return v;
		 	                    }
		 	                });
		 	              var uid = dataItem.uid;
		 	              if (dataItem.ite4 == "A") {
		 	                    setTimeout(function () {
		 	                         $("tr[data-uid=" + uid + "]").css("background", "green");
		 	                         $("tr[data-uid=" + uid + "]").css("color", "white");
		 	                     }, 0);
		 	               } 
		 	                return v;
		 	            },
		 	            editor: function (container, options) {
		 	            	 
		 	            		$('<input name="' + options.field + '"/>')
		 	                    .appendTo(container)
		 	                    .kendoDropDownList({
		 	                        dataTextField: "meaning",
		 	                        dataValueField: "value",
		 	                        dataSource: HPM_ITEM_RESULT,
		 	                        valuePrimitive: true
		 	                    }); 
		 	            } 	
		 			});
    		 
    			 gridss.setOptions({
    		 		columns: columns
    		 	});
    			 var viewModel1 =Hap.createGridViewModel(gridss);  
    		 //加载列结束 新增数据	    			 	    		 	 
	    		 for (var i =0; i < args.rows.length; i++){
	    			 if(args.rows[i].status!="A")
	    				 continue;
	    			 var value =[];		    			 
	    			 for(var j=0;j<args.rows[i].qtys.length;j++){
	    				 viewModel1.model.set("item" + j,args.rows[i].qtys[j]);
	    			 }
	    			 var date=new Date();
	    			 date=args.rows[i].adviceChangeTime;
	    			 date=new Date(date).format("yyyy-MM-dd");	
	    			 viewModel1.model.set("ite1", args.rows[i].scrap);
	    			 viewModel1.model.set( "ite2",args.rows[i].cycleDays);
	    			 viewModel1.model.set( "ite3",date);
	    			 viewModel1.model.set( "ite4",args.rows[i].status);
						
	    			 viewModel1.model.set( "groupId",args.rows[i].groupId);
	    			 gridss.dataSource.add(viewModel1.model);
	    		 }
	    		 $('#dataTableDiv1').css('display','table'); 
    		 }
    		 //如果查询不到数据证明不需要展示 则隐藏对应的gird
    		 else{
    			$('#dataTableDiv1').css('display','none'); 
    		 }
    	 }
    },
    async: false
});




var dataSourceReport = new kendo.data.DataSource({
     
    batch: true,
    serverPaging: true,
    pageSize: 10,
    schema: {
    	data: 'rows',
        total: 'total',
        model: {
            id: "kid",
            fields: {
            	itemCode:{
                    
                     validation:{
                         required:true,
                         custom:function(e){
                        	 if(e[0]!= undefined && e[0] != ""){
                 			var length=e[0].value;
                 			var datas=$("#gridItem").data('kendoGrid').dataSource.data();
                 			$.each(datas,function(i,v){
                 				if(v.itemId==length){
                 					  
                 					return false;
                 				}
                 			});
                        	 }
                 			return true;
                 		}
                        
                     }
                 },
                 buyerId:{},
                 itemId:{}
            },
            editable: function (col) {
            	 
                if (col == 'itemCode') {
                	if (!this.isNew()) {
                        return false;
                    }
                    return true;
                };
                if (col == 'itemDescription') {
                    if (!this.isNew()) {
                        return false;
                    }
                    return true;
                };
                if (col == 'onhandStatus') {
                   
                    return true;
                };
                return true;
            }
        }
    }
});

 
$("#gridReport").kendoTooltip(toolTipOpt).data("kendoTooltip");
var gridReport = $("#gridReport").kendoGrid({
    dataSource: dataSourceReport,
    resizable: true,
    scrollable: true,
    navigatable: false,
  	sortable:true,
  	autoBind:false,
    // selectable: 'multiple, rowbox',
    detailInit: detailInit,
    dataBound: function () {
        if (parent.autoResizeIframe) {
            parent.autoResizeIframe('${RequestParameters.functionCode!}')
        }
    },
    
    editable: false   
}).data("kendoGrid");
function reprotDetail(headId){
	viewModel.model.set("reportId",headId);

	$("#gridReportDetail").data("kendoGrid").dataSource.data("");	 
	$.ajax({
	    url: '${base.contextPath}/hpm/ecr/item/report/get/detail',
	    data:JSON.stringify( viewModel.model.toJSON() ) ,
	    type: 'POST',
	    dataType: 'json',
	    contentType: "application/json;charset=UTF-8",
	    success: function (args) { 
	    	 if(args.success&&args.rows.length>0){
	    		 var columns = [];
	    	    	columns.push({
	    	              field: "skuCode",
	    	              title: '<@spring.message "ecrmain.skucode"/>',
	    	              attributes:{style:"white-space:nowrap;text-overflow:ellipsis;"},
	    	              width: 120,            
	    	          });
	    	    	columns.push(           {
	    	              field: "bomUse",
	    	              title: '<@spring.message "ecritemcontrol.itemneed"/>',
	    	              attributes:{style:"white-space:nowrap;text-overflow:ellipsis;"},
	    	              width: 120
	    	          });
	    	    	for (var i =0; i < args.rows[0].ecrItemReportDetailV1s.length; i++) {
	    	    		
	    				 columns.push({
	    		 				field: "itemdetail" + i,
	    		 				title: args.rows[0].ecrItemReportDetailV1s[i].month,
	    		 				attributes:{style:"white-space:nowrap;text-overflow:ellipsis;"},
	    		 				width: 120,
	    		 				columns: [{
	    	                        field: "itemdetaili" + i,
	    	                        title: "已生产",
	    	                        width: 200 
	    	                    },{
	    	                        field: "itemdetailk" + i,
	    	                        title: "本月预测",
	    	                        width: 200
	    	                    },{
	    	                    	field: "itemdetailj" + i,
	    	                        title: "上月剩余",
	    	                        width:200
	    	                    } ]
	    		 			});
	    			 } 
	    	    	gridReportDetail.setOptions({
	    		 		columns: columns
	    		 	});
	    	    	var viewModelReport =Hap.createGridViewModel(gridReportDetail);
	    			 //加载列结束 新增数据	    			 	    		 	 
	    	    		 for (var i =0; i < args.rows.length; i++){
	    	    			 var value =[];		    			 
	    	    			 viewModelReport.model.set("skuCode",args.rows[i].skuCode);
	    	    			 viewModelReport.model.set("bomUse",args.rows[i].bomUse);
	    	    			 for(var j=0;j< args.rows[i].ecrItemReportDetailV1s.length;j++){
	    	    				 
	    	    				 viewModelReport.model.set("itemdetaili" + j,args.rows[i].ecrItemReportDetailV1s[j].completeQty);
	    	    				 viewModelReport.model.set("itemdetailk" + j,args.rows[i].ecrItemReportDetailV1s[j].demandQty);
	    	    				 viewModelReport.model.set("itemdetailj" + j,args.rows[i].ecrItemReportDetailV1s[j].leftQty); 
	    	    				// viewModelReport.model.set("item" + j,viewModel.model);
	    	    			 }
	    	    			 
	    	    			 gridReportDetail.dataSource.add(viewModelReport.model.toJSON());
	    	    		 }
	    	 }
	    },
	    async: false
	});
}
var index=0;
var max=-1;

//初始化
$.ajax({
    url: '${base.contextPath}/hpm/ecr/item/report/get/head',
    data:JSON.stringify( viewModel.model.toJSON() ) ,
    type: 'POST',
    dataType: 'json',
    contentType: "application/json;charset=UTF-8",
    success: function (args) { 
    	 if(args.success&&args.rows.length>0){

    		 var columns = [];
    	    	columns.push({
    	              field: "itemCode",
    	              title: '<@spring.message "asl.itemcode"/>',
    	              attributes:{style:"white-space:nowrap;text-overflow:ellipsis;"},
    	              width: 120,            
    	          });
    	    	columns.push(           {
    	              field: "buyer",
    	              title: '<@spring.message "asl.itemname"/>',
    	              attributes:{style:"white-space:nowrap;text-overflow:ellipsis;"},
    	              width: 120
    	          });
   	    		max=args.rows[0].ecrItemReportV1s.length;
    	    	for (var i =0; i < args.rows[0].ecrItemReportV1s.length; i++) {
    	    		
    				 columns.push({
    		 				field: "item" + i,
    		 				title: args.rows[0].ecrItemReportV1s[i].planDate,
    		 				attributes:{style:"white-space:nowrap;text-overflow:ellipsis;"},
    		 				width: 120,
    		 				columns: [{
    	                        field: "itemm" + i,
    	                        title: "id",
    	                        hidden:true                        
    	                    },{
    	                        field: "itemi" + i,
    	                        title: "总需求",
    	                        width: 200
    	                        ,
    	                        template:function (dataItem) {
    	                            if(index>=max){
    	                            	index=0;
    	                            }    	                            
    	                            var item = dataItem.get("itemi" + index);
    	                            var kid=dataItem.get("itemm" + index);
    	                            index=index+1;
    	                            //var itemId = dataItem.itemId;
    	                            return item+'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<button id="btn-detail" type="button" onclick=reprotDetail(\'' + kid + '\') class="btn btn-info btn-sm"><@spring.message "ecritemcontrol.reportdetail"/> </button>';
    	                        }
    	                    },{
    	                        field: "itemj" + i,
    	                        title: "采购",
    	                        width: 200
    	                    },{
    	                    	field: "itemk" + i,
    	                        title: "库存",
    	                        width:200
    	                    }]
    		 			});
    			 } 
    	    	gridReport.setOptions({
    		 		columns: columns
    		 	});
    	    	
    			 //加载列结束 新增数据	    			 	    		 	 
    	    		 for (var i =0; i < args.rows.length; i++){
    	    			 var viewModelReport =Hap.createGridViewModel(gridReport);
    	    			 
    	    			 var value =[];		    			 
    	    			 viewModelReport.model.set("itemCode",args.rows[i].itemCode);
    	    			 viewModelReport.model.set("buyer",args.rows[i].buyer);
    	    			 for(var j=0;j< args.rows[i].ecrItemReportV1s.length;j++){
    	    				 
    	    				 viewModelReport.model.set("itemi" + j,args.rows[i].ecrItemReportV1s[j].sumQty);
    	    				 viewModelReport.model.set("itemj" + j,args.rows[i].ecrItemReportV1s[j].onhandQty);
    	    				 viewModelReport.model.set("itemk" + j,args.rows[i].ecrItemReportV1s[j].buyerQty);
    	    				 viewModelReport.model.set("itemm" + j,args.rows[i].ecrItemReportV1s[j].reportId);
    	    				// viewModelReport.model.set("item" + j,viewModel.model);
    	    			 }
    	    			 
    	    			 gridReport.dataSource.add(viewModelReport.model);
    	    		 }
    	 }
    },
    async: false
}); 
 


 var dataSourceReportDetail = new kendo.data.DataSource({
   
    batch: true,
    serverPaging: true,
    pageSize: 10,
    schema: {
    	data: 'rows',
        total: 'total',
        model: {
            id: "kid",
            fields: {
            	itemCode:{
                    
                     validation:{
                         required:true,
                         custom:function(e){
                        	 if(e[0]!= undefined && e[0] != ""){
                 			var length=e[0].value;
                 			var datas=$("#gridItem").data('kendoGrid').dataSource.data();
                 			$.each(datas,function(i,v){
                 				if(v.itemId==length){
                 					  
                 					return false;
                 				}
                 			});
                        	 }
                 			return true;
                 		}
                        
                     }
                 },
                 buyerId:{},
                 itemId:{}
            },
            editable: function (col) {
            	 
                if (col == 'itemCode') {
                	if (!this.isNew()) {
                        return false;
                    }
                    return true;
                };
                if (col == 'itemDescription') {
                    if (!this.isNew()) {
                        return false;
                    }
                    return true;
                };
                if (col == 'onhandStatus') {
                   
                    return true;
                };
                return false;
            }
        }
    }
});

 
$("#gridReportDetail").kendoTooltip(toolTipOpt).data("kendoTooltip");
var gridReportDetail = $("#gridReportDetail").kendoGrid({
    dataSource: dataSourceReportDetail,
    resizable: true,
    scrollable: true,
    navigatable: false,
  	sortable:true,
    // selectable: 'multiple, rowbox',
    detailInit: detailInit,
    dataBound: function () {
        if (parent.autoResizeIframe) {
            parent.autoResizeIframe('${RequestParameters.functionCode!}')
        }
    },
    requestEnd:function(e){

    	
    },
    columns: [
        {
            field: "itemCode",
            title: '<@spring.message "asl.itemcode"/>',
            attributes:{style:"white-space:nowrap;text-overflow:ellipsis;"},
            width: 120  
        },
        {
            field: "buyer",
            title: '<@spring.message "asl.itemname"/>',
            attributes:{style:"white-space:nowrap;text-overflow:ellipsis;"},
            width: 120
        },                            
    ],
    editable: true,
    edit:function(e){
     if(e.model.buyer!=userId){
    	 this.closeCell();
     }
    }
}).data("kendoGrid");

</script>

/body>
