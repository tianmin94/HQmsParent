<#include "../include/header.html">
<script src="${base.contextPath}/lib/bootstrap-3.3.7/js/bootstrap.min.js"></script>

<script type="text/javascript">
    var viewModel = Hap.createGridViewModel("#grid");
    var viewModelTree = kendo.observable({
        model: { },
        query: function (e) {
            $('#gridTree').data('kendoTreeList').dataSource.read();
        },
    });
    var viewModelRole = Hap.createGridViewModel("#gridRole");
    var viewModelUser = Hap.createGridViewModel("#gridUser");
</script>
<style>
.abc{background:#000; color:#FFF}
    .k-state-selected{
        background-color: #ec971f!important;
    }
</style>
<!--新建-->
<!-- <script>


        viewModel.create= function(){
		var dialog = $("#childWindow1").kendoWindow({
            width: window.innerWidth * 0.47,
            height: window.innerHeight *0.75,
            title: '<@spring.message "iso.manager.new"/>',
            visible: false,
            iframe: true,
            modal: true,
            close: function(){	
                $("#grid").data("kendoGrid").dataSource.page(1);
          
               },
            content: '../file_manager/managerAdd.html'
        }).data("kendoWindow");   
	    dialog.center().open(); 
	}
        
       viewModel.show= function(){
    	 //权限校验
			 var flag = true;
        	 var grid = $("#grid").data("kendoGrid"),
             selections = grid.selectedDataItems();
             console.log(selections.length);
    			var operationFlag = true;
    			if(selections.length>1||selections.length<1){
    				operationFlag = false;
    				kendo.ui.showWarningDialog({
    		            message: "请选择一条数据！"
    		        });
    				return;
    			}
    			fileId = selections[0].fileId;
    			 var ticketIdData =
   			  {   fileId :  fileId  ,
   				 permissionCode :"R"	}
   		    	$.ajax({
   		        url: '${base.contextPath}/file/permission/check',
   		        type: 'POST',
   		        data: ticketIdData,
   		        async: false,
   		        dataType: "json",
   		        success: function (response) {
   		            if (response.success) {
        
   	            	}else{
   	            		   flag =false;
   		            		kendo.ui.showWarningDialog({
   		                        message: "您的权限不足"
   		                    });
   		            		return;
   		            	}
   		            }
   		        });	
    			 if(flag)
 				{
    		var dialog = $("#childWindow2").kendoWindow({
                width: window.innerWidth * 0.5,
                height: window.innerHeight *0.8,
                title: '查看',
                visible: false,
                iframe: true,
                modal: true,
                close: function(){	
                    $("#grid").data("kendoGrid").dataSource.page(1);
                   },
                content: '../file_manager_his/manager_his_detail.html?fileId='+fileId
            }).data("kendoWindow");   
    	    dialog.center().open(); 
 				}
    	}
       
	     function edit() 
			 {
	    	 var flag = true;
	    	 var grid = $("#grid").data("kendoGrid"),
             selections = grid.selectedDataItems();
             console.log(selections.length);
    			var operationFlag = true;
    			if(selections.length>1||selections.length<1){
    				operationFlag = false;
    				kendo.ui.showWarningDialog({
    		            message: "请 一条数据！"
    		        });
    				return;
    			}
    			fileId = selections[0].fileId;
    			var classifyId = selections[0].classifyId;
    			//权限校验
    			 var ticketIdData =
    			  {   fileId :  fileId  ,
    				 permissionCode :"E"	}
    		    	$.ajax({
    		        url: '${base.contextPath}/file/permission/check',
    		        type: 'POST',
    		        data: ticketIdData,
    		        async: false,
    		        dataType: "json",
    		        success: function (response) {
    		            if (response.success) {
           
    	            	}else{
    	            		    flag =false;
    		            		kendo.ui.showWarningDialog({
    		                        message: "您的权限不足"
    		                    });
    		            		return;
    		            	}
    		            }
    		        });
    			if(flag)
    				{
	    	     var dialog = $("#childWindow3").kendoWindow({
	                width: window.innerWidth * 0.6,
	                height: window.innerHeight *0.8,
	                title: '<@spring.message "iso.manager.edit"/>',
	                visible: false,
	                iframe: true,
	                modal: true,
	                close: function(){	
	                    $("#grid").data("kendoGrid").dataSource.page(1);
	                   },
	                content: '../file_manager_his/manager_his.html?fileId='+fileId+'&classifyId='+classifyId
	            }).data("kendoWindow");   
	    	    dialog.center().open();  
    				}
			 }	
	     
	   viewModel.download= function(){
		   var flag = true;
		   var grid = $("#grid").data("kendoGrid"),
           selections = grid.selectedDataItems();
           console.log(selections.length);
  			var operationFlag = true;
  			if(selections.length>1||selections.length<1){
  				operationFlag = false;
  				kendo.ui.showWarningDialog({
  		            message: "请选择一条数据！"
  		        });
  				return;
  			}
  			fileId = selections[0].fileId;
  			 var ticketIdData =
			  {   fileId :  fileId  ,
				 permissionCode :"R"}
		    	$.ajax({
		        url: '${base.contextPath}/file/permission/check',
		        type: 'POST',
		        data: ticketIdData,
		        async: false,
		        dataType: "json",
		        success: function (response) {
		            if (response.success) {
      
	            	}else{
	            		    flag =false;
		            		kendo.ui.showWarningDialog({
		                        message: "您的权限不足"
		                    });
		            		return;
		            	}
		            }
		        });
			if(flag)
				{
	    			var dialog = $("#childWindow4").kendoWindow({
	    	            width: window.innerWidth * 0.5,
	    	            height: window.innerHeight *0.5,
	    	            title: '<@spring.message "iso.manager.download"/>',
	    	            visible: false,
	    	            iframe: true,
	    	            modal: true,
	    	            close: function(){	
	    	                $("#grid").data("kendoGrid").dataSource.page(1);
	    	               },
	    	            content: '../file_manager_his/manager_his_download.html?fileId='+fileId
	    	        }).data("kendoWindow");   
	    		    dialog.center().open(); 
				}
	    		}	 
				 
			
</script> -->


<body>
<div id="page-content">
    <div class="pull-left" id="toolbar-btn" style="padding-bottom:10px;">
        <span class="btn btn-primary" onclick="expand()" style="float:left;margin-right:5px;">
        	<i class="fa fa-plus-square-o" style="margin-right:3px;"></i><@spring.message "hap.expand"/></span>
        <span class="btn btn-warning" onclick="collapse()"  style="float:left;margin-right:5px;">
        	<i class="fa fa-minus-square-o" style="margin-right:3px;"></i><@spring.message "hap.collapse"/></span>
        <span class="btn btn-primary k-grid-add" style="float:left;margin-right:5px;" 
        	onclick="openLeftNewWindow()">新增组件分类</span>
    </div>
    <script>kendo.bind($('#toolbar-btn'), viewModelTree);</script>
    

    
   <!-- 侧面加分层 -->
   	<div class="row" style="width: 100%;height: 100%;margin-top: 10px;">
   		<div class="col-sm-12" style="height: 100%">
   			<div class="col-sm-4" style="height: 100%;border: 2px solid #EEEEEE;border-radius:10px;">
   				<div style="clear:both;">
        			<div id="gridTree"style="height: 700px"></div>
    			</div>
   			</div>
			<div class="col-sm-8" >
                <ul class="nav nav-tabs" id="mytab">
                    <li id="tab1" class="active"><a href="#div1"  data-toggle="tab"><@spring.message "属性"/></a></li>
                    <li id="tab2" class=""><a href="#div2" data-toggle="tab"><@spring.message "工程师"/></a></li>
                </ul>
                <div id="tabContent" class="tab-content">
                    <div id="div1" class="tab-pane fade in active">
                        <div class="pull-left"  style="padding-bottom:10px;padding-top: 10px;">
                            <span id="add-btn" class="btn btn-primary k-grid-add" style="float:left;margin-right:15px;"
                                  onclick="openNewWindow()">新增属性 </span>
                        </div>
                        <div id="query-form" class="pull-right" style="padding-bottom:10px;padding-top: 10px;">
                            <input id="detailsCode" data-role="maskedtextbox" style="width:150px;margin-right:5px;" placeholder='零件属性编码'
                                   data-bind="value:model.detailsCode" class="k-textbox">
                            <input  id="detailsName" data-role="maskedtextbox"
                                    style="width:150px;margin-right:5px;" placeholder="零件属性名称" data-bind="value:model.detailsName">
                            <span class="btn btn-primary" style="width:70px;margin-right:5px;" data-bind="click:query" type="submit">查询</span>
                            <span class="btn btn-default" type="button" data-bind="click:reset" style="margin-right:40px;"><i class="fa fa-eraser"></i>重置</span>
                        </div>
                        <script>kendo.bind($('#query-form'), viewModel);</script>

                        <div class="pull-right" id="toolbar-btn-details" style="padding-bottom:25px;">
                            <!-- <span class="btn btn-warning" onclick="edit()" style="float:left;margin-right:5px;">
                                <i class="fa fa-minus-square-o" style="margin-right:3px;"></i><@spring.message "iso.manager.edit"/></span> -->
                        </div>
                        <script>kendo.bind($('#toolbar-btn-details'), viewModel);</script>
                        
                        <div style="clear:both">
                            <div id="grid"></div>
                        </div>

                    </div>
                    <div id="div2" class="tab-pane fade">
                        <div class="pull-left"  style="padding-bottom:10px;padding-top: 10px;">
                            <span  class="btn btn-primary k-grid-add" style="float:left;margin-right:15px;"
                                   onclick="openNewRoleWindow()">新增职位 </span>
                        </div>
                        <div style="clear:both;">
                            <div id="gridRole"></div>
                        </div>
                        <div class="pull-left"  style="padding-bottom:10px;padding-top: 10px;">
                            <span  class="btn btn-primary k-grid-add" style="float:left;margin-right:15px;"
                                   onclick="openNewUserWindow()">新增人员</span>
                        </div>
                        <div style="clear:both;">
                            <div id="gridUser"></div>
                        </div>

                    </div>
                </div>

    		</div>
     	</div>
	</div>
</div>
<div id="detailsNewWindow"></div>
<div id="detailsViewWindow"></div>
<div id="leftNewWindow"></div>
<div id="leftNewWindow2"></div>
<div id="leftViewWindow"></div>
<div id="roleNewWindow"></div>
<div id="roleViewWindow"></div>
<div id="userNewWindow"></div>
<div id="userViewWindow"></div>
<script>

	//展开
	function expand() {
        var tree = gridTree.dataSource.data();
        for (var i = 0; i < tree.length; i++) {
            if (tree[i].hasChildren) {
            	gridTree.expand(tree[i]);
            }
        }
    }
	
	//合并
	function collapse() {
        var tree = gridTree.dataSource.data();
        for (var i = 0; i < tree.length; i++) {
            if (tree[i].hasChildren) {
            	gridTree.collapse(tree[i]);
            }
        }
    }
	
	//进入组件新建页面,顶层
	function openLeftNewWindow(){
		var url='technology_spare_part_new.html';
		
		var leftNewWindow = $("#leftNewWindow").kendoWindow({
			actions:["close"],
			width:600,
			height:300,
			title:'新建物料组件',
			content:url,
			iframe:true,
			visible:false,
			resizable:true,
			modal:true,
			close:function(){
				$('#gridTree').data('kendoTreeList').dataSource.read();
			}
			
		}).data("kendoWindow");
		leftNewWindow.center().open();
	}
	
	//进入组件新建页面,非顶层
	function openLeftNewWindow2(sparePartId,sparePartLevel){
		var url='technology_spare_part_new2.html?sparePartId='+sparePartId+'&sparePartLevel='+sparePartLevel;
		
		var leftNewWindow2 = $("#leftNewWindow2").kendoWindow({
			actions:["close"],
			width:600,
			height:300,
			title:'新建物料组件',
			content:url,
			iframe:true,
			visible:false,
			resizable:true,
			modal:true,
			close:function(){
				$('#gridTree').data('kendoTreeList').dataSource.read();
			}
			
		}).data("kendoWindow");
		leftNewWindow2.center().open();
	}
	
	//进入组件编辑页面
	function openLeftViewWindow(sparePartId){
		var url='technology_spare_part_view2.html?sparePartId='+sparePartId;
		
		var leftViewWindow = $("#leftViewWindow").kendoWindow({
			actions:["close"],
			width:600,
			height:300,
			title:'编辑物料组件',
			content:url,
			iframe:true,
			visible:false,
			resizable:true,
			modal:true,
			close:function(){
				$('#gridTree').data('kendoTreeList').dataSource.read();
			}
			
		}).data("kendoWindow");
		leftViewWindow.center().open();
	}
	
	//进入零件新建页面
	function openNewWindow(){
		var url='technology_spare_part_details_new.html';
		
		var detailsNewWindow = $("#detailsNewWindow").kendoWindow({
			actions:["close"],
			width:600,
			height:400,
			title:'新建物料零件',
			content:url,
			iframe:true,
			visible:false,
			resizable:true,
			modal:true,
			close:function(){
				$("#grid").data('kendoGrid').dataSource.read();
			}
		}).data("kendoWindow");
		detailsNewWindow.center().open();
	}
	
	//进入零件编辑页面
	function openViewWindow(sparePartDetailsId){
		var url='technology_spare_part_details_view.html?sparePartDetailsId='+sparePartDetailsId;
		
		var detailsViewWindow = $("#detailsViewWindow").kendoWindow({
			actions:["close"],
			width:600,
			height:400,
			title:'编辑物料零件',
			content:url,
			iframe:true,
			visible:false,
			resizable:true,
			modal:true,
			close:function(){
				$("#grid").data('kendoGrid').dataSource.read();
			}
		}).data("kendoWindow");
		detailsViewWindow.center().open();
	}
	//刪除零件
	function delSparePartDetail(sparePartDetailsId){
		kendo.ui.showConfirmDialog({
            title: $l('hap.confirm'),
            message: '確定刪除？'
        }).done(function (e) {
            if (e.button == 'OK') {
            	$.ajax({
                    url: '${base.contextPath}/npi/technology/spare/part/details/deleteById?sparePartDetailsId='+sparePartDetailsId,
                    type: 'GET',
                    contentType: "application/json",
                    dataType: "json",
                    success: function (response) {
                        if (response.success) {
                        	kendo.ui.showInfoDialog({
                                  message: "成功"
                           });
                        	$("#grid").data('kendoGrid').dataSource.read();
                        } else {
                        	kendo.ui.showWarningDialog({
                                message: response.message
                            });
                        }
                    }
                });
            }
        })
	}
	function delSparePart(sparePartId ,sparePartLevel){
		kendo.ui.showConfirmDialog({
            title: $l('hap.confirm'),
            message: '確定刪除？'
        }).done(function (e) {
            if (e.button == 'OK') {
            	$.ajax({
                    url: '${base.contextPath}/npi/technology/spare/part/deleteById?sparePartId='+sparePartId+"&sparePartLevel="+sparePartLevel,
                    type: 'GET',
                    contentType: "application/json",
                    dataType: "json",
                    success: function (response) {
                        if (response.success) {
                        	kendo.ui.showInfoDialog({
                                  message: "成功"
                           });
                        	$('#gridTree').data('kendoTreeList').dataSource.read();
                        } else {
                        	kendo.ui.showWarningDialog({
                                message: response.message
                            });
                        }
                    }
                });
            }
        })
	}

    //刪除职位
    function delPositonRole(kid){
        kendo.ui.showConfirmDialog({
            title: $l('hap.confirm'),
            message: '確定刪除？'
        }).done(function (e) {
            if (e.button == 'OK') {
                $.ajax({
                    url: '${base.contextPath}/hcm/position/role/deleteById?kid='+kid,
                    type: 'GET',
                    contentType: "application/json",
                    dataType: "json",
                    success: function (response) {
                        if (response.success) {
                            kendo.ui.showInfoDialog({
                                message: "成功"
                            });
                            $("#gridRole").data('kendoGrid').dataSource.read();
                            $("#gridUser").data('kendoGrid').dataSource.read();
                        } else {
                            kendo.ui.showWarningDialog({
                                message: response.message
                            });
                        }
                    }
                });
            }
        })
    }

    //刪除角色
    function delPositonUser(kid){
        kendo.ui.showConfirmDialog({
            title: $l('hap.confirm'),
            message: '確定刪除？'
        }).done(function (e) {
            if (e.button == 'OK') {
                $.ajax({
                    url: '${base.contextPath}/hcm/position/user/deleteById?kid='+kid,
                    type: 'GET',
                    contentType: "application/json",
                    dataType: "json",
                    success: function (response) {
                        if (response.success) {
                            kendo.ui.showInfoDialog({
                                message: "成功"
                            });
                            $("#gridUser").data('kendoGrid').dataSource.read();
                        } else {
                            kendo.ui.showWarningDialog({
                                message: response.message
                            });
                        }
                    }
                });
            }
        })
    }

    //进入职位新建页面
    function openNewRoleWindow(){
	    debugger
        var treeList = $("#gridTree").data("kendoTreeList");
        var row= treeList.select();
        if(row.length > 0){
            var data = treeList.dataItem(row);
            if(data.sparePartLevel != 3){
                kendo.ui.showWarningDialog({
                    message: "请选择左侧三级分类！"
                });
                return;
            }else{
                var categoryId = data.sparePartId;
                if(categoryId != null){
                    var url='technology_spare_part_role_new.html?categoryId='+categoryId;
                    var roleNewWindow = $("#roleNewWindow").kendoWindow({
                        actions:["close"],
                        width:600,
                        height:400,
                        title:'新增职位',
                        content:url,
                        iframe:true,
                        visible:false,
                        resizable:true,
                        modal:true,
                        close:function(){
                            $("#gridRole").data('kendoGrid').dataSource.read();
                        }
                    }).data("kendoWindow");
                    roleNewWindow.center().open();
                }
            }
        }else{
            kendo.ui.showWarningDialog({
                message: "请选择左侧三级分类"
            });
            return;
        }
    }

    //进入职位编辑页面
    function openViewRoleWindow(kid){
        var url='technology_spare_part_role_view.html?kid='+kid;

        var roleViewWindow = $("#roleViewWindow").kendoWindow({
            actions:["close"],
            width:600,
            height:400,
            title:'编辑职位',
            content:url,
            iframe:true,
            visible:false,
            resizable:true,
            modal:true,
            close:function(){
                $("#gridRole").data('kendoGrid').dataSource.read();
            }
        }).data("kendoWindow");
        roleViewWindow.center().open();
    }

    //进入人员新建页面
    function openNewUserWindow(){
        var grid = $("#gridRole").data("kendoGrid"),
            selections = grid.selectedDataItems();
        if(selections.length>1||selections.length<1){
            kendo.ui.showWarningDialog({
                message: "请选择功能职位名称！"
            });
            return;
        }
        positionId = selections[0].kid;
        if(positionId != null ){
            var url='technology_spare_part_user_new.html?positionId='+positionId;
            var userNewWindow = $("#userNewWindow").kendoWindow({
                actions:["close"],
                width:600,
                height:400,
                title:'新增人员',
                content:url,
                iframe:true,
                visible:false,
                resizable:true,
                modal:true,
                close:function(){
                    $("#gridUser").data('kendoGrid').dataSource.read();
                }
            }).data("kendoWindow");
            userNewWindow.center().open();
        }

    }

    //进入人员编辑页面
    function openViewUserWindow(kid){
        var url='technology_spare_part_user_view.html?kid='+kid;

        var userViewWindow = $("#userViewWindow").kendoWindow({
            actions:["close"],
            width:600,
            height:400,
            title:'编辑人员',
            content:url,
            iframe:true,
            visible:false,
            resizable:true,
            modal:true,
            close:function(){
                $("#gridUser").data('kendoGrid').dataSource.read();
            }
        }).data("kendoWindow");
        userViewWindow.center().open();
    }
</script>

<script type="text/javascript">
	Hap.initEnterQuery('#query-form', viewModel.query);
	var BaseUrl = _basePath;
	dataSource = new kendo.data.DataSource({
	    transport: {
	        read: {
	            url: BaseUrl + "/npi/technology/spare/part/details/queryByCondition",
	            type: "POST",
	            dataType: "json"
	        },
	        update: {
	            url: BaseUrl + "/npi/technology/spare/part/details/submit",
	            type: "POST",
	            contentType: "application/json"
	        },
	        destroy: {
	            url: BaseUrl + "/npi/technology/spare/part/details/remove",
	            type: "POST",
	            contentType: "application/json"
	        },
	        create: {
	            url: BaseUrl + "/npi/technology/spare/part/details/submit",
	            type: "POST",
	            contentType: "application/json"
	        },
	        parameterMap: function (options, type) {
	            if (type !== "read" && options.models) {
	                var datas = Hap.prepareSubmitParameter(options, type)
	                return kendo.stringify(datas);
	            } else if (type === "read") {
	                return Hap.prepareQueryParameter(viewModel.model.toJSON(), options)
	            }
	        }
	    },
	    batch: true,
	    serverPaging: true,
	    pageSize: 20,
	    schema: {
	        data: 'rows',
	        total: 'total',
	        model: {
	            id: "sparePartDetailsId",
	            fields: {}
	        }
	    }
	});

    var grid = $("#grid").kendoGrid({
        dataSource: dataSource,
        resizable: true,
        scrollable: true,
        navigatable: false,
        // selectable: 'single,rowbox',
        sortable: {
        	mode: "multiple"
        },
        dataBound: function () {
            if (parent.autoResizeIframe) {
                parent.autoResizeIframe('${RequestParameters.functionCode!}')
            }
        },
        pageable: {
            pageSizes: [5, 10, 20, 50],
            refresh: true,
            buttonCount: 5
        },
        columns: [
            /* {
                field: "sparePartDetailsId",
                title: '<@spring.message "technologysparepartdetails.sparepartdetailsid"/>',
                width: 120,
                attributes: {style: "text-align:center;white-space: nowrap;"},
                headerAttributes: {style: "text-align:center"},
            }, */
                    {
                field: "detailsCode",
                title: '零件属性编码',
                width: 120,
                attributes: {style: "text-align:center;white-space: nowrap;"},
                headerAttributes: {style: "text-align:center"},
                template:function(rowdata) {
                	return '<a href="#" style="color:blue" onclick="openViewWindow('+rowdata.sparePartDetailsId+')">'+rowdata.detailsCode+'</a>'
                }
            },
                    {
                field: "detailsName",
                title: '零件属性名称',
                width: 120,
                attributes: {style: "text-align:center;white-space: nowrap;"},
                headerAttributes: {style: "text-align:center"},
            },
                    {
                field: "detailsValue",
                title: '零件属性值',
                width: 120,
                attributes: {style: "text-align:center;white-space: nowrap;"},
                headerAttributes: {style: "text-align:center"},
            },
                    {
                field: "detailsUnit",
                title: '零件属性单位',
                width: 120,
                attributes: {style: "text-align:center;white-space: nowrap;"},
                headerAttributes: {style: "text-align:center"},
            },
                    {
                field: "detailsCost",
                title: '价值',
                width: 120,
                attributes: {style: "text-align:center;white-space: nowrap;"},
                headerAttributes: {style: "text-align:center"},
            },
        	{
                title: '<@spring.message "iso.classify.operation"/>',
                width: 120,
                attributes: {style: "text-align:center;white-space: nowrap;"},
	            headerAttributes: {style: "text-align:center"},
                template:function (rowdata) {
                	return '<a href="#" onclick="delSparePartDetail(\'' + rowdata.sparePartDetailsId + '\')">刪除</a>';
                }
            }
        ],
        editable: false
    });

</script>

<script type="text/javascript">
	function treelist(arr, childrens, parentId,parentCode) {
	    for (var i = 0; i < childrens.length; i++) {
	        childrens[i].parentId = parentId;
	        childrens[i].parentCode = parentCode;
	        childrens[i].hasChildren = true;
	        arr.push(childrens[i])
	        if (childrens[i].children && childrens[i].children.length > 0) {
	            treelist(arr, childrens[i].children, childrens[i].id,childrens[i].functionCode);
	        } else {
	            childrens[i].hasChildren = false;
	        }
	    }
	}

    var BaseUrl = _basePath;
    dataSourceTree = new kendo.data.TreeListDataSource({
        transport: {
            read: {
                url: BaseUrl + "/npi/technology/spare/part/queryTreeData",
                type: "POST",
                dataType: "json"
            },
            update: {
                url: BaseUrl + "/npi/technology/spare/part/submit",
                type: "POST",
                contentType: "application/json"
            },
            destroy: {
                url: BaseUrl + "/npi/technology/spare/part/remove",
                type: "POST",
                contentType: "application/json"
            },
            create: {
                url: BaseUrl + "/npi/technology/spare/part/submit",
                type: "POST",
                contentType: "application/json"
            },
            parameterMap: function (options, type) {
                if (type !== "read" && options.models) {
                    var datas = Hap.prepareSubmitParameter(options, type)
                    return kendo.stringify(datas);
                } else if (type === "read") {
                	return Hap.prepareQueryParameter(viewModelTree.model.toJSON(), options)
                }
            }
        },
        requestEnd: function (e) {
            var response = e.response;
            if (!response)
                return;
            var datas = [];
            treelist(datas, response.rows || [], null,null);
            response.rows = datas;
        },
        batch: true,
        serverPaging: true,
        pageSize: 10,
        schema: {
            data: 'rows',
            total: 'total',
            model: {
                id: "id",
                parentId: 'parentId',
                fields: {},
                expanded: true
            }
        }
    });

    var gridTree = $("#gridTree").kendoTreeList({
        dataSource: dataSourceTree,
        resizable: true,
        scrollable: true,
        navigatable: false,
        selectable: 'multiple, row',
        dataBound: function () {
            if (parent.autoResizeIframe) {
                parent.autoResizeIframe('${RequestParameters.functionCode!}')
            }
        },
        pageable: {
            pageSizes: [5, 10, 20, 50],
            refresh: true,
            buttonCount: 5
        },
        columns: [  
        	{
        		field: "sparePartCode",
	            title: '组件分类编码',
	            width: 120,
	            headerAttributes: {style: "text-align:center"},
        	},
        	{
	            field: "sparePartName",
	            title: '名称',
	            width: 120,
	            attributes: {style: "text-align:center;white-space: nowrap;"},
	            headerAttributes: {style: "text-align:center"},
        	},
        	{
                title: '<@spring.message "iso.classify.operation"/>',
                width: 120,
                attributes: {style: "text-align:center;white-space: nowrap;"},
	            headerAttributes: {style: "text-align:center"},
                template:function (dataItem) {
                	if(dataItem.sparePartLevel == '3'){
                		return '<a href="#" onclick="openLeftViewWindow(\'' + dataItem.sparePartId + '\')">编辑</a>&nbsp;&nbsp;&nbsp;&nbsp;'+
                    	'<a href="#" onclick="delSparePart(\'' + dataItem.sparePartId + '\',\''+dataItem.sparePartLevel + '\')">刪除</a>&nbsp;&nbsp;&nbsp;&nbsp;';
                	} else {
                		return '<a href="#" onclick="openLeftNewWindow2(\'' + dataItem.sparePartId + '\',\''+dataItem.sparePartLevel+'\')">新增</a>&nbsp;&nbsp;&nbsp;&nbsp;'+
                        	'<a href="#" onclick="openLeftViewWindow(\'' + dataItem.sparePartId + '\')">编辑</a>&nbsp;&nbsp;&nbsp;&nbsp;'+
                        	'<a href="#" onclick="delSparePart(\'' + dataItem.sparePartId + '\',\''+dataItem.sparePartLevel + '\')">刪除</a>&nbsp;&nbsp;&nbsp;&nbsp;';
                	}
              	  
              	                 
                }
            }
        ],
        editable: false
    }).data('kendoTreeList');
</script>
<script>
	$('#gridTree').on('dblclick', 'tr', function () {
	    debugger
		var rowIndex = $(this).index();
		var data = gridTree.dataSource.data()[rowIndex];
	    viewModel.model.sparePartId = data.sparePartId;
	    viewModel.model.sparePartLevel = data.sparePartLevel;
        viewModelRole.model.set("categoryId",data.sparePartId);

        viewModel.query();
        //选择三级分类时查询相应的功能职位
        if(data.sparePartLevel ==3){
            viewModelRole.query()
        }

	});
	$('#grid').on('dblclick', 'tr', function () {
		var rowIndex = $(this).index();
		var data = $("#grid").data("kendoGrid").dataSource.data()[rowIndex];
		console.log(data.sparePartId);
		var grid =$("#gridTree").data("kendoTreeList");
		var view=$("#gridTree").data("kendoTreeList").dataSource.view();

		for(var i=0;i<view.length;i++){
			if(view[i].id === data.sparePartId){
				$("#gridTree tbody").find("tr[data-uid="+view[i].uid+"]").addClass("k-state-selected");
			}else{
				$("#gridTree tbody").find("tr[data-uid="+view[i].uid+"]").removeClass("k-state-selected");
			}
		}
		//grid.select(1);

	    /* viewModel.model.sparePartId = data.sparePartId;
	    viewModel.model.sparePartLevel = data.sparePartLevel;
	    viewModel.query(); */
	});
</script>

<script type="text/javascript">

    //选择功能职位时查询相应的人员
    function onChange(arg) {
        var grid = $("#gridRole").data("kendoGrid"),
            selections = grid.selectedDataItems();
        if(selections.length>0){
            var positionId = selections[0].kid;
            viewModelUser.model.positionId=positionId;
            viewModelUser.query()
        }
    }

    //工程师--功能职位
    var BaseUrl = _basePath;
    dataSourceRole = new kendo.data.DataSource({
        transport: {
            read: {
                url: BaseUrl + "/hcm/position/role/query",
                type: "POST",
                dataType: "json"
            },
            update: {
                url: BaseUrl + "/hcm/position/role/submit",
                type: "POST",
                contentType: "application/json"
            },
            create: {
                url: BaseUrl + "/hcm/position/role/submit",
                type: "POST",
                contentType: "application/json"
            },
            parameterMap: function (options, type) {
                if (type !== "read" && options.models) {
                    var datas = Hap.prepareSubmitParameter(options, type)
                    return kendo.stringify(datas);
                } else if (type === "read") {
                    return Hap.prepareQueryParameter(viewModelRole.model.toJSON(), options)
                }
            }
        },
        batch: true,
        serverPaging: true,
        pageSize: 5,
        schema: {
            data: 'rows',
            total: 'total',
            model: {
                id: "kid",
                fields: {}
            }
        }
    });

    var gridRole = $("#gridRole").kendoGrid({
        dataSource: dataSourceRole,
        resizable: true,
        scrollable: true,
        navigatable: false,
        change: onChange,
        selectable: 'single，rowbox',
        sortable: {
            mode: "multiple"
        },
        dataBound: function () {
            if (parent.autoResizeIframe) {
                parent.autoResizeIframe('${RequestParameters.functionCode!}')
            }
        },
        pageable: {
            pageSizes: [5, 10, 20, 50],
            refresh: true,
            buttonCount: 5
        },
        columns: [
            {
                field: "positionName",
                title: '功能职位名称',
                width: 120,
                attributes: {style: "text-align:center;white-space: nowrap;"},
                headerAttributes: {style: "text-align:center"}
            },
            {
                field: "positionTypeName",
                title: '职责类别',
                width: 120,
                attributes: {style: "text-align:center;white-space: nowrap;"},
                headerAttributes: {style: "text-align:center"},
            },
            {
                title: '<@spring.message "iso.classify.operation"/>',
                width: 120,
                attributes: {style: "text-align:center;white-space: nowrap;"},
                headerAttributes: {style: "text-align:center"},
                template:function (rowdata) {
                    return '<a href="#" onclick="openViewRoleWindow(\'' + rowdata.kid + '\')">编辑</a>&nbsp;&nbsp;'+
                        '<a href="#" onclick="delPositonRole(\'' + rowdata.kid + '\')">刪除</a>';
                }
            }
        ],
        editable: false
    });

</script>

<script type="text/javascript">

    //工程师--人员
    var BaseUrl = _basePath;
    dataSourceUser = new kendo.data.DataSource({
        transport: {
            read: {
                url: BaseUrl + "/hcm/position/user/query",
                type: "POST",
                dataType: "json"
            },
            update: {
                url: BaseUrl + "/hcm/position/user/submit",
                type: "POST",
                contentType: "application/json"
            },
            create: {
                url: BaseUrl + "/hcm/position/user/submit",
                type: "POST",
                contentType: "application/json"
            },
            parameterMap: function (options, type) {
                if (type !== "read" && options.models) {
                    var datas = Hap.prepareSubmitParameter(options, type)
                    return kendo.stringify(datas);
                } else if (type === "read") {
                    return Hap.prepareQueryParameter(viewModelUser.model.toJSON(), options)
                }
            }
        },
        batch: true,
        serverPaging: true,
        pageSize: 5,
        schema: {
            data: 'rows',
            total: 'total',
            model: {
                id: "kid",
                fields: {}
            }
        }
    });

    var gridUser = $("#gridUser").kendoGrid({
        dataSource: dataSourceUser,
        resizable: true,
        scrollable: true,
        navigatable: false,
        sortable: {
            mode: "multiple"
        },
        dataBound: function () {
            if (parent.autoResizeIframe) {
                parent.autoResizeIframe('${RequestParameters.functionCode!}')
            }
        },
        pageable: {
            pageSizes: [5, 10, 20, 50],
            refresh: true,
            buttonCount: 5
        },
        columns: [
            {
                field: "userName",
                title: 'KO号',
                width: 120,
                attributes: {style: "text-align:center;white-space: nowrap;"},
                headerAttributes: {style: "text-align:center"}

            },
            {
                field: "employeeName",
                title: '姓名',
                width: 120,
                attributes: {style: "text-align:center;white-space: nowrap;"},
                headerAttributes: {style: "text-align:center"},
            },
            {
                field: "email",
                title: '邮箱',
                width: 120,
                attributes: {style: "text-align:center;white-space: nowrap;"},
                headerAttributes: {style: "text-align:center"},
            },
            {
                title: '<@spring.message "iso.classify.operation"/>',
                width: 120,
                attributes: {style: "text-align:center;white-space: nowrap;"},
                headerAttributes: {style: "text-align:center"},
                template:function (rowdata) {
                    return '<a href="#" onclick="openViewUserWindow(\'' + rowdata.kid + '\')">编辑</a>&nbsp;&nbsp;'+
                        '<a href="#" onclick="delPositonUser(\'' + rowdata.kid + '\')">刪除</a>';
                }
            }
        ],
        editable: false
    });
</script>




</body>
</html>