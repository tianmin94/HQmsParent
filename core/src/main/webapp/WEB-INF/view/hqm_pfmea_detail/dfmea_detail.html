<#include "../include/header.html">
<script src="${base.contextPath}/common/code?severityData=HQM_FMEA_SEVERITY_RANGE"></script>
<script src="${base.contextPath}/common/code?specialCharacteristicTypeData=HQM_FMEA_SPECIAL_TYPE"></script>
<script src="${base.contextPath}/common/code?occurrenceData=HQM_FMEA_OCCURRENCE_RANGE"></script>
<script src="${base.contextPath}/common/code?detectionData=HQM_FMEA_DETECTION_RANGE"></script>
<style type="text/css">
	span{font-size:15px;font-weight:bold;}
</style>
<script type="text/javascript">
    var kid = "${RequestParameters.kid}";
    console.log("pfema明细")
    var fmeaName = "${RequestParameters.fmeaName}";
    var fmeaCode = "${RequestParameters.fmeaCode}";
    console.log(fmeaCode,fmeaName)
    $(function() {
//     	$('#fmeaCode').val(fmeaCode)
//      $('#fmeaName').val(fmeaName)
     
        $('#fmeaCode').html("&nbsp;&nbsp;项目编号 "  + " : " + fmeaCode)
        $('#fmeaName').html("&nbsp;&nbsp;项目名称 "  + " : " + fmeaName)
    })
    var invalidId;
    var viewModel = kendo.observable({
        model: { },
        query: function (e) {
            $('#grid').data('kendoTreeList').dataSource.read();
        },
        create:function (e) {
            editDialog1.title('<@spring.message "fmea.newprocess"/>');
            $('#branchId').val('');
            $('#parentBranchId').val('');
            $('#parentBranchId').parents('div .row').css('display','none');
            $('#row1').css('display','none')
            $('#row2').css('display','none')
            $('#row3').css('display','none')
            $('#row4').css('display','none')
            $('#row5').css('display','none')
            $('#row6').css('display','none')
            $('#row7').css('display','none')
            $('#row8').css('display','none')
            $('#row9').css('display','none')               
            $('#cjname1').text('<@spring.message "fmea.query.process"/>')
            $("#branchName").attr("disabled",false);
		    $('#branchName').css('background-color','#fff8c5');
		    $('#stuFlag').val('');
		    $('#stuFlag').val(true);
            editDialog1.center().open();
        }
    });
</script>
<style>
    #editDialog .row{
        margin-top: 10px;
    }
    #editDialog .row label{
        text-align: right;
        line-height: 30px;
        font-size: 14px;
    }
    .btn-foot{
        width: 95%;
        position: absolute;
        bottom: 20px;
    }
</style>
<script type="text/javascript">
viewModel.report=function(){	

	 var dialog = $("#childWindow").kendoWindow({
		    width: window.innerWidth*0.9,
		    height: window.innerHeight*0.9,
		    title:'<@spring.message "fmea.risk.analysis"/>',
		    visible: false,
		    iframe: true,
		    modal: true,
		    content: '../hqm_pfmea_detail/dfmea_detail_report.html?kid='+kid
		}).data("kendoWindow");     
		dialog.center().open();	
} 


viewModel.printFunction=function(){	
	var dialog = $("#printWindow").kendoWindow({
        width: "95%",
        height: "90%",
        title: '<@spring.message "dimensionorder.print"/>',
        visible: false,
        iframe: true,
        modal: true,
        content: '../hqm_pfmea_detail/control_plan_print.html?kid='+kid
    }).data("kendoWindow");
	  dialog.center().open();
} 


viewModel.commit=function(){
	kendo.ui.showConfirmDialog({
	    title: '提示',
	    message: '是否提交并更新版本?'
	}).done(function (e) {
	    if(e.button.toUpperCase() == "OK"){
	                var idArr = [];
        			idArr[0] = kid;
            		$.ajax({
        				url:"${base.contextPath}/hqm/pfmea/confirm",
        				data: "list="+idArr,
        				type:"POST",
        				success: function (data){
        					if(data.success){
        						kendo.ui.showInfoDialog({
        							title: "提示",
        			    			message: data.message
        			    		})
        			    		$("#grid").data('kendoGrid').dataSource.read();
        			    		/* window.viewModel.refresh(); */
        					}else{
        						kendo.ui.showErrorDialog({
        							title: "错误提示",
        			    			message: data.message
        			    		})
        					}
        				}
        			})
	    }else{
	    	
	    }
	})
  }
  
viewModel.getMessage=function(){	
  console.log(invalidId);
  var idArr = [];
  if(invalidId==null)
	  {
	       kendo.ui.showInfoDialog({
			title: "提示",
			message: "请选择工序"
		})
		return;
	  }
	idArr[0] = invalidId;
	idArr[1] = kid;
	$.ajax({
		url:"${base.contextPath}/hqm/pfmea/getmessage",
		data: "list="+idArr,
		type:"POST",
		success: function (data){
			if(data.success){
				kendo.ui.showInfoDialog({
					title: "提示",
	    			message: data.message
	    		})
	    		$("#grid").data('kendoTreeList').dataSource.read();
	    		/* window.viewModel.refresh(); */
			}else{
				kendo.ui.showErrorDialog({
					title: "错误提示",
	    			message: data.message
	    		})
			}
		}
	})
} 

</script>
<body>
<input data-role="maskedtextbox" id="ranks" style="display: none">
<input data-role="maskedtextbox" id="stuFlag" style="display: none"><!--新增工序层级标识  -->
<!-- <input data-role="maskedtextbox" id="funFlag" style="display: none">新增要求层级标识  -->
<input data-role="maskedtextbox" id="invalidFlag" style="display: none"><!--新增动作层级标识  -->
<input data-role="maskedtextbox" id="editInvalidFlag" style="display: none"><!--编辑动作层级标识  -->
<input data-role="maskedtextbox" id="branchId" style="display: none">
<div id="childWindow"></div>
<div id="childWindow1"></div>
<div id="printWindow"></div>
<div>
	<div class = "row">
<!-- 		<div  class="pull-left"> -->
<!-- 		   	&nbsp;&nbsp;&nbsp;项目编号  :  <input id = "fmeaCode" type="text" readonly> -->
<!-- 		   	项目名称 :  <input id = "fmeaName" type="text" readonly> -->
<!-- 		</div> -->
			<span id="fmeaCode"></span>
			<span id="fmeaName"></span>
	</div>
	<div class = "row">
		<div id="page-content">
		    <div class="pull-left" id="toolbar-btn" style="padding-bottom:10px;">
		        <span class="btn btn-primary" onclick="expand()" style="float:left;margin-right:5px;"><i class="fa fa-plus-square-o" style="margin-right:3px;"></i><@spring.message "hap.expand"/></span>
		        <span class="btn btn-warning" onclick="collapse()"  style="float:left;margin-right:5px;"><i class="fa fa-minus-square-o" style="margin-right:3px;"></i><@spring.message "hap.collapse"/></span>
		        <span class="btn btn-primary k-grid-add" style="float:left;margin-right:5px;" onclick="addhead()"><@spring.message "fmea.query.process"/></span>
		         <span type="button" class="btn btn-primary"  style="float:left;margin-right:5px" data-bind="click:commit"><i class="fa fa-share" style="margin-right:3px;"></i><@spring.message "fmea.submit"/></span> 
		        <span type="button" class="btn btn-primary"  style="float:left;margin-right:5px" data-bind="click:report"><i class="fa fa-bolt" style="margin-right:3px;"></i><@spring.message "fmea.risk.analysis"/></span> 
		        <span id='btnPrint' class="btn btn-primary k-grid-add" style="float:left;margin-right:5px;" data-bind="click:printFunction"><@spring.message "iqcinspection.print"/></span>
		    </div>
		    <script>kendo.bind($('#toolbar-btn'), viewModel);</script>
		    <div class="pull-right" id="query-form" style="padding-bottom:10px;">
		        <input id="usersLov" placeholder='工序'   data-bind="value:invalidId" >
		               
		        <span type="button" class="btn btn-primary" style="width:70px" data-bind="click:getMessage" ><i class="fa  fa-reply" style="margin-right:3px;"></i>添加</span>
		        <div style="clear:both"></div>
		    </div>
		    <script>kendo.bind($('#query-form'), viewModel);</script>
		    <div style="clear:both">
		        <div id="grid" style="height:600px" ></div>
		    </div>
		</div>
	</div>
</div>

<script type="text/javascript">
$("#usersLov").kendoLov($.extend
	    (<@lov"lov_pfmea_data"/>, {
	        textField: 'invalidName',
	        valueField: 'invalidId',
	        change:function()
	        {
	        	invalidId= 	this._dataItem.invalidId ;   	
	        }
	    }));
</script>
<!-- 编辑界面  -->
<div id="editDialog" style="display: none">
    <div id="myform" class="container" style="width: 95%">
        <div class="row">
            <label  id='cjname' class="col-sm-3 col-md-3"><span style='color:red'>*&nbsp;&nbsp;</span>潜在失效模式</label>
            <div class="col-sm-2 sol-md-2" id="classifyItem-div">
                <input  id="branchName" class="k-textbox" required>
            </div>
        </div>
    
        <div class="row" id="row1">
            <label class="col-sm-3 col-md-3"><@spring.message "fmea.failure.effect"/></label>
            <div class="col-sm-2 sol-md-2" id="classifyItem-div">
                <input  id="invalidConsequence" class="k-textbox" >
            </div>
             <label class="col-sm-3 col-md-3"><span style='color:red'>*&nbsp;&nbsp;</span><@spring.message "fmea.severity"/></label>
            <div class="col-sm-2 sol-md-2" id="classifyItem-div">
                <input  id="severity" data-bind="value:model.severity" required >
            </div>
        </div>

        <div class="row" id="row2">
            <label class="col-sm-3 col-md-3"><@spring.message "fmea.class"/></label>
            <div class="col-sm-2 sol-md-2" id="classifyItem-div">
                <input  id="specialCharacteristicType" data-bind="value:model.specialCharacteristicType" >
            </div>
             <label class="col-sm-3 col-md-3"><@spring.message "fmea.failure.cause"/></label>
            <div class="col-sm-2 sol-md-2" id="classifyItem-div">
                <input  id="failureReason" class="k-textbox" >
            </div>
        </div>
        <div class="row" id="row_a">
            <label class="col-sm-3 col-md-3"><@spring.message "要求"/></label>
            <div class="col-sm-2 sol-md-2" id="classifyItem-div">
                <input  id="claim" data-bind="value:model.claim" >
            </div>
             <label class="col-sm-3 col-md-3"><@spring.message "潜在失效模式"/></label>
            <div class="col-sm-2 sol-md-2" id="classifyItem-div">
                <input  id="potentialFailureMode" class="k-textbox" >
            </div>
        </div>
                
        <div class="row" id="row3">
            <label class="col-sm-3 col-md-3"><@spring.message "fmea.current.preventive.measure"/></label>
            <div class="col-sm-2 sol-md-2" id="classifyItem-div">
                <input  id="preventiveMeasure" class="k-textbox" >
            </div>
             <label class="col-sm-3 col-md-3"><span style='color:red'>*&nbsp;&nbsp;</span><@spring.message "fmea.occurrence"/></label>
            <div class="col-sm-2 sol-md-2" id="classifyItem-div">
                <input  id="occurrence" data-bind="value:model.occurrence" required>
            </div>
        </div>
        
        <div class="row" id="row4">
            <label class="col-sm-3 col-md-3"><@spring.message "fmea.current.testing.measure"/></label>
            <div class="col-sm-2 sol-md-2" id="classifyItem-div">
                <input  id="detectionMeasure" class="k-textbox" >
            </div>
             <label class="col-sm-3 col-md-3"><span style='color:red'>*&nbsp;&nbsp;</span><@spring.message "fmea.detection"/></label>
            <div class="col-sm-2 sol-md-2" id="classifyItem-div">
                <input  id="detection" data-bind="value:model.detection" required>
            </div>
        </div>

        <div class="row" id="row5" style ="border-bottom: 2px gray;">
            <label class="col-sm-3 col-md-3"><@spring.message "fmea.rpn"/></label>
            <div class="col-sm-2 sol-md-2"  id="classifyItem-div">
                <input  id="rpn" disabled class="k-textbox" >
            </div>
        </div>
        
        <!-- 新增字段 -->
          <div class="row" id="row6">
            <label class="col-sm-3 col-md-3"><@spring.message "fmea.recommended.measures"/></label>
            <div class="col-sm-2 sol-md-2" id="classifyItem-div"> 
                <input  id="suggestMeasure" class="k-textbox"  data-bind="value:model.suggestMeasure" >
            </div>
             <label class="col-sm-3 col-md-3"><@spring.message "fmea.principal"/></label>
            <div class="col-sm-2 sol-md-2" id="classifyItem-div">
                <input  id="chargeId"   data-bind="value:model.useName" >
            </div>
        </div>      
         <div class="row" id="row7">
            <label class="col-sm-3 col-md-3"><@spring.message "fmea.estimated.finish.time"/></label>
            <div class="col-sm-2 sol-md-2" id="classifyItem-div">
                <input  id="estimatedFinishTime"  data-bind="value:model.estimatedFinishTime">
                <script type="text/javascript">
					$("#estimatedFinishTime").kendoDatePicker({
						format: "yyyy-MM-dd",
						change:function(){
							viewModel.model.estimatedFinishTime = this.value().format("yyyy-MM-dd");
						}
					});
				</script>
            </div>
             <label class="col-sm-3 col-md-3"><@spring.message "fmea.result.severity"/></label>
            <div class="col-sm-2 sol-md-2" id="classifyItem-div">
                <input  id="postSeverity" data-bind="value:model.postSeverity">
            </div>
        </div>
        <div class="row" id="row8">
            <label class="col-sm-3 col-md-3"><@spring.message "fmea.measure.result"/></label>
            <div class="col-sm-2 sol-md-2" id="classifyItem-div">
                <input  id=measureResult class="k-textbox"  data-bind="value:model.measureResult" >
            </div>
             <label class="col-sm-3 col-md-3"><@spring.message "fmea.result.occurrence"/></label>
            <div class="col-sm-2 sol-md-2" id="classifyItem-div">
                <input  id="postOccurrence"   data-bind="value:model.postOccurrence">
            </div>
        </div>
        <div class="row" id="row9" >
            <label class="col-sm-3 col-md-3"><@spring.message "fmea.result.detection"/></label>
            <div class="col-sm-2 sol-md-2" id="classifyItem-div">
                <input  id="postDetection"  data-bind="value:model.postDetection" >
            </div>
             <label class="col-sm-3 col-md-3"><@spring.message "fmea.result.rpn"/></label>
            <div class="col-sm-2 sol-md-2" id="classifyItem-div">
                <input  id="postRpn" class="k-textbox"  disabled data-bind="value:model.postRpn">
            </div>
        </div>
      </div>
      
      
        <div class="row" style="display:none">
            <label class="col-sm-3 col-md-3">父层级:</label>
            <div class="col-sm-2 sol-md-2">
                <input id="parentBranchId">
            </div>
            <script>
                /* var parentBranchId = $("#parentBranchId").kendoLov($.extend(<@lov "PSPC_ATTACHMENT"/>,{
                    textField: 'branchName',
                    valueField:'branchId',
                    select:function (e) {
                    }
                })).data('kendoLov'); */
            </script>
        </div>
        <script>kendo.bind($('#myform'), viewModel);</script>
    <div class="btn-foot">
        <div class="pull-right">
            <span class="btn btn-primary k-grid-add" onclick="saveAttachment()" style="float:left;margin-right:5px;padding-top:2px"" ><@spring.message "hap.ok"/></span>
            <span class="btn btn-default" onclick="closeDialog('editDialog')" style="float:left;margin-right:10px;padding-top:2px" ><@spring.message "hap.cancel"/></span>
        </div>
    </div>
</div>

<div id="editDialog1" style="display: none">
		<div id="myform1" class="container"
			style="width: 95%; margin-top: 15px;">
			<div class="row">
				<div class="form-group col-sm-6" style="padding: 0px">
					<label id='cjname1' class="col-sm-2 control-label">工序/要求</label>
					<div class="col-sm-5" id="classifyItem-div">
						<input id="processFunctionName" class="k-textbox" onkeypress="javascript:if(event.keyCode == 32)event.returnValue = false;" required>
					</div>
				</div>
			</div>
		</div>
		<script>
			kendo.bind($('#myform1'), viewModel);
		</script>
    <div class="btn-foot">
        <div class="pull-right">
            <span class="btn btn-primary k-grid-add" onclick="saveAttachment()" style="float:left;margin-right:5px;" ><@spring.message "hap.ok"/></span>
            <span class="btn btn-default" onclick="closeDialog1('editDialog1')" style="float:left;margin-right:10px;" ><@spring.message "hap.cancel"/></span>
        </div>
    </div>
</div>
<script>

$("#severity").kendoComboBox({
    dataTextField: "meaning",
    dataValueField: "value",
    valuePrimitive: true,
    dataSource: severityData,
    change:function(){
    	var num=$('#severity').val()*$('#occurrence').val()*$('#detection').val();
     	$('#rpn').val(num);
    }
});

$("#specialCharacteristicType").kendoComboBox({
    dataTextField: "meaning",
    dataValueField: "value",
    valuePrimitive: true,
    dataSource: specialCharacteristicTypeData
});
$("#occurrence").kendoComboBox({
    dataTextField: "meaning",
    dataValueField: "value",
    valuePrimitive: true,
    dataSource: occurrenceData,
    change:function(){
    	var num=$('#severity').val()*$('#occurrence').val()*$('#detection').val();
     	$('#rpn').val(num);
    }
});

$("#postSeverity").kendoComboBox({
    dataTextField: "meaning",
    dataValueField: "value",
    valuePrimitive: true,
    dataSource: occurrenceData,
    change:function(){
    	//var num=$('#postSeverity').val()*$('#postDetection').val()*$('#postOccurrence').val();
    	var num= viewModel.model.postSeverity*viewModel.model.postOccurrence*viewModel.model.postDetection
     	if(num==0)
		{$('#postRpn').val('');}
	else{$('#postRpn').val(num);
	    }
    }
});

$("#postDetection").kendoComboBox({
    dataTextField: "meaning",
    dataValueField: "value",
    valuePrimitive: true,
    dataSource: occurrenceData,
    change:function(){
    	//var num=$('#postSeverity').val()*$('#postDetection').val()*$('#postOccurrence').val();
    	var num= viewModel.model.postSeverity*viewModel.model.postOccurrence*viewModel.model.postDetection
    	if(num==0)
		{$('#postRpn').val('');}
	else{$('#postRpn').val(num);}
    }
});

$("#postOccurrence").kendoComboBox({
    dataTextField: "meaning",
    dataValueField: "value",
    valuePrimitive: true,
    dataSource: occurrenceData,
    change:function(){
    	//var num=$('#postSeverity').val()*$('#postDetection').val()*$('#postOccurrence').val();
    	var num= viewModel.model.postSeverity*viewModel.model.postOccurrence*viewModel.model.postDetection
    	if(num==0)
		{$('#postRpn').val('');}
	else{$('#postRpn').val(num);}
    }
});

$("#detection").kendoComboBox({
    dataTextField: "meaning",
    dataValueField: "value",
    valuePrimitive: true,
    dataSource: detectionData,
    change:function(){
	var num=$('#severity').val()*$('#occurrence').val()*$('#detection').val();
 	$('#rpn').val(num);
    }
});
$("#chargeId").kendoLov($.extend
	    (<@lov"LOV_DFMEA_SRAFF"/>, {
	    	query: function (e) {
                e.param['fmeaId'] = kid
            },
	        textField: 'userName',
	        valueField:'staffId',
	        change :function()
	        {
	        	viewModel.model.set("chargeId",this._dataItem.staffId);
	        	viewModel.model.set("useName",this._dataItem.userName);
	        	console.log(this._dataItem.staffId);
	        	console.log(viewModel.model.useName);
	        }
	    }));	




    var editDialog = $("#editDialog").kendoWindow({
        width: 1000,
        height: 500,
        title: '新增分类组',
        visible: false,
        modal: true,
        actions: [
            "Close"
        ],
        close:function() {
            //关闭时清空
            $('#branchId').val('');
            $("#parentBranchId").val('');
            $('#processFunctionName').val('');
            $('#branchName').val('');
            $('#claim').val('');
            $('#invalidConsequence').val('');
            $('#potentialFailureMode').val('');
            $('#severity').val('');
            $('#specialCharacteristicType').val('');
            $('#failureReason').val('');
            $("#preventiveMeasure").val('');
            $('#occurrence').val('');
            $('#detectionMeasure').val('');
            $('#detection').val('');
            $('#rpn').val('');
            $('suggestMeasure').val('');
            $('chargeId').val('');
            $('estimatedFinishTime').val('');
            $('measureResult').val('');
            $('postOccurrence').val('');
            $('postSeverity').val('');
            $('postRpn').val('');
            $('postDetection').val('');
            $('#ranks').val('');
            $('#stuFlag').val('');
//             $("#funFlag").val('');
            $("#invalidFlag").val('');
            $('#editInvalidFlag').val('');
            viewModel.model.set('severity',''); 
            viewModel.model.set('specialCharacteristicType','');
            viewModel.model.set('occurrence',''); 
            viewModel.model.set('detection',''); 
            //$('#attachment').attr('disabled',false);
            //$('#attachment').css('background-color','#FFFFFF');
        }
    }).data("kendoWindow");
    
    var editDialog1 = $("#editDialog1").kendoWindow({
        width: 800,
        height: 200,
        title: '工序弹窗',
        visible: false,
        modal: true,
        actions: [
            "Close"
        ],
        close:function() {
            //关闭时清空
            $('#branchId').val('');
            $("#parentBranchId").val('');
            $('#processFunctionName').val('');
            $('#branchName').val('');
            $('#invalidConsequence').val('');
            $('#claim').val('');
            $('#potentialFailureMode').val('');
            $('#severity').val('');
            $('#specialCharacteristicType').val('');
            $('#failureReason').val('');
            $("#preventiveMeasure").val('');
            $('#occurrence').val('');
            $('#detectionMeasure').val('');
            $('#detection').val('');
            $('#rpn').val('');
            $('suggestMeasure').val('');
            $('chargeId').val('');
            $('estimatedFinishTime').val('');
            $('measureResult').val('');
            $('postOccurrence').val('');
            $('postSeverity').val('');
            $('postRpn').val('');
            $('postDetection').val('');
            $('#ranks').val('');
            $('#stuFlag').val('');
//             $("#funFlag").val('');
            $("#invalidFlag").val('');
            $('#editInvalidFlag').val('');
            viewModel.model.set('severity',''); 
            viewModel.model.set('specialCharacteristicType','');
            viewModel.model.set('occurrence',''); 
            viewModel.model.set('detection',''); 
            //$('#attachment').attr('disabled',false);
            //$('#attachment').css('background-color','#FFFFFF');
        }
    }).data("kendoWindow"); 
</script>
<script type="text/javascript">
    function treelist(arr, childrens, parentId,parentCode) {
        for (var i = 0; i < childrens.length; i++) {
            childrens[i].parentId = parentId;
            childrens[i].parentCode = parentCode;
            childrens[i].hasChildren = true;
            arr.push(childrens[i])
            if (childrens[i].children && childrens[i].children.length > 0) {
                treelist(arr, childrens[i].children, childrens[i].id,childrens[i].functionCode);
            } else {
                childrens[i].hasChildren = false;
            }
        }
    }

    Hap.initEnterQuery('#query-form', viewModel.query);
    var BaseUrl = _basePath;
    dataSource = new kendo.data.TreeListDataSource({
        transport: {
            read: {
                url: BaseUrl + "/hqm/pfmea/query/tree/data",
                type: "POST",
                dataType: "json"
            },
            update: {
                url: BaseUrl + "/hdm/invalid/submit",
                type: "POST",
                contentType: "application/json"
            },
            destroy: {
                url: BaseUrl + "/hdm/invalid/remove",
                type: "POST",
                contentType: "application/json"
            },
            create: {
                url: BaseUrl + "/hdm/invalid/submit",
                type: "POST",
                contentType: "application/json"
            },
            parameterMap: function (options, type) {
                if (type !== "read" && options.models) {
                    var datas = Hap.prepareSubmitParameter(options, type)
                    return kendo.stringify(datas);
                } else if (type === "read") {
                    viewModel.model.fmeaId = kid
                    console.log("fmeaID:"+ viewModel.model.fmeaId)
                    return Hap.prepareQueryParameter(viewModel.model.toJSON(), options)
                }
            }
        },
        requestEnd: function (e) {
            var response = e.response;
            if (!response)
                return;
            var datas = [];
            treelist(datas, response.rows || [], null,null);
            response.rows = datas;
        },
        batch: true,
        serverPaging: true,
        pageSize: 10,
        schema: {
            data: 'rows',
            total: 'total',
            model: {
                id: "id",
                parentId: 'parentId',
                fields: {
                	branchName:{
                		validation:{
                    		required: true,
                    		required:{message: "必填"},
                    	}
                	},
                	severity:{
                		validation:{
                    		required: true,
                    		required:{message: "严重度为必填"},
                    	}
                	},
                	occurrence:{
                		validation:{
                    		required: true,
                    		required:{message: "频度为必填"},
                    	}
                	},
                	detection:{
                		validation:{
                    		required: true,
                    		required:{message: "检测度为必填"},
                    	}
                	},
                },
                expanded: true,
                editable: function(col){
                	if(col != 'branchName'){
                		if(this.ranks != '2'){
                			return false;
                		}
                	}
                	return true;
                }
            }
        }
    });

    var grid = $("#grid").kendoTreeList({
        dataSource: dataSource,
        editable: "incell",
        resizable: true,
        scrollable: true,
        navigatable: false,
        selectable: 'multiple, rowbox',
        dataBound: function (e) {
            if (parent.autoResizeIframe) {
                parent.autoResizeIframe('${RequestParameters.functionCode!}')
            }
            var datas =grid.dataSource.data();
            $.each(datas,function(i,v)
            		{
            	 if(v.postRpn ==null&&v.postOccurrence ==null&&v.postSeverity ==null)
                 {
            	
                     if(v.rpn>'80'||v.severity>'8'||v.occurrence>'8') 
                  	   {  
                    	 console.log("11111111111111111111");
                    	 $("tr[data-uid='"+ v.uid+"']").css('color','red');
                  	   }
                     else
                 	{
                 	 
                 	 $("tr[data-uid='"+ v.uid+"']").css('color','black'); 
                 	}
                                        	                                        
                  }    
                 else
                 {
                 	if(v.postRpn>'80'||v.postOccurrence>'8'||v.postSeverity>'8') 
               	   {  console.log("3333333333333333333333333");
                 		$("tr[data-uid='"+ v.uid+"']").css('color','red');  
                 		}
                 	 else
                    	{
                    	 
                    	 $("tr[data-uid='"+ v.uid+"']").css('color','black'); 
                    	}
                 	
                 }
            	 if(addLineFlag && addRanks != -1 && addBranchId != -1){
  					if(v.parentId == addBranchId && !isNotEmpty(v.branchId)){
  						v.ranks = addRanks;
	            		    addLineFlag = false;
	            	    	addRanks = -1;
	            	    	addBranchId = -1;
  					}
         	       }          		
            		})
            		
            		
                var items = e.sender.items();
                for (var i = 0; i < items.length; i++) {
                var dataItem = e.sender.dataItem(items[i]);
                var row = $(items[i]);
                if (dataItem.isNew()) {
                    row.find("[data-command='createchild']").hide();
                }
                else {
                    row.find("[data-command='createchild']").show();
                }
            }	
        },
        pageable: {
            pageSizes: [5, 10, 20, 50],
            refresh: true,
            buttonCount: 5
        },
        columns: [
        	{
                field: "claim",
                title: '<@spring.message "要求"/>',
                width: 160,
                template: function (dataItem) {
                    return dataItem.claim == "null" ? "" : dataItem.claim;
                },
            },
            {
                field: "potentialFailureMode",
                title: '<@spring.message "潜在失效模式"/>',
                width: 160,
                template: function (dataItem) {
                    return dataItem.potentialFailureMode == "null" ? "" : dataItem.potentialFailureMode;
                },
            },
        	{
            field: "branchName",
            title: ' ',
            width: 180,
            locked: true,
            headerAttributes: {
                style: "text-align: center"
            }
        },
        {
             field: "invalidConsequence",
            title: '<@spring.message "fmea.failure.effect"/>',
            width: 160,
            template: function (dataItem) {
                return dataItem.invalidConsequence == "null" ? "" : dataItem.invalidConsequence;
            },
        },
         {
            field: "severity",
            title: '<@spring.message "fmea.severity"/>',
            width: 80,
            template: function (dataItem) {
            	var severity = dataItem.severity +'';
            	var v= (severity == "null" ? "" : severity);
            	$.each(severityData, function (i, n) {
                    if ((n.value || '').toLowerCase() == (v || '').toLowerCase()) {
                        v = n.meaning;
                        return v;
                    }
                });
                return v;
               
            },
            editor: function (container, options) {
                //$('<input required name="<@spring.message "fmea.severity"/>"/>')
                $('<input required name="' + options.field + '"/>') 
                    .appendTo(container)
                    .kendoDropDownList({
                        dataTextField: "meaning",
                        dataValueField: "value",
                        valuePrimitive: true,
                        dataSource:severityData,
                        change:function(e){
                        	options.model.set('severity',this._old)
                        }
                    });
            },
        },
        {
            field: "specialCharacteristicType",
            title: '<@spring.message "fmea.class"/>',
            width: 80,
            template: function (dataItem) {
            	var v= (dataItem.specialCharacteristicType == "null" ? "" : dataItem.specialCharacteristicType);
            	$.each(specialCharacteristicTypeData, function (i, n) {
                    if ((n.value || '').toLowerCase() == (v || '').toLowerCase()) {
                        v = n.meaning;
                        return v;
                    }
                });
                return v;
               
            },
            editor: function (container, options) {
                $('<input name="' + options.field + '"/>')
                    .appendTo(container)
                    .kendoDropDownList({
                        dataTextField: "meaning",
                        dataValueField: "value",
                        valuePrimitive: true,
                        dataSource:specialCharacteristicTypeData
                    });
            },
        },
        {
            field: "failureReason",
            title: '<@spring.message "fmea.failure.cause"/>',
            width: 160,
            template: function (dataItem) {
                return dataItem.failureReason == "null" ? "" : dataItem.failureReason;
            },
        },
        
        
                {
            field: "occurrence",
            title: '<@spring.message "fmea.occurrence"/>',
            width: 70,
            template: function (dataItem) {
            	var occurrence = dataItem.occurrence +'';
            	var v= (occurrence == "null" ? "" : occurrence);
            	$.each(occurrenceData, function (i, n) {
                    if ((n.value || '').toLowerCase() == (v || '').toLowerCase()) {
                        v = n.meaning;
                        return v;
                    }
                });
                return v;
               
            },
            editor: function (container, options) {
                //$('<input required name="<@spring.message "fmea.occurrence"/>"/>')
                $('<input required name="' + options.field + '"/>')
                    .appendTo(container)
                    .kendoDropDownList({
                        dataTextField: "meaning",
                        dataValueField: "value",
                        valuePrimitive: true,
                        dataSource:occurrenceData,
                        change:function(e){
                        	options.model.set('occurrence',this._old)
                        }
                    });
            },
        },
        
        {
            field: "preventiveMeasure",
            title: '<@spring.message "fmea.current.preventive.measure"/>',
            width: 160,
            attributes: {
                style: "white-space:pre-wrap"
            },
            template: function (dataItem) {
                return dataItem.preventiveMeasure == "null" ? "" : dataItem.preventiveMeasure;
            },
        },
        {
            field: "detectionMeasure",
            title: '<@spring.message "fmea.current.testing.measure"/>',
            width: 160,
            template: function (dataItem) {
                return dataItem.detectionMeasure == "null" ? "" : dataItem.detectionMeasure;
            },
        },
                {
            field: "detection",
            title: '<@spring.message "fmea.detection"/>',
            width: 80,
            template: function (dataItem) {
            	var detection = dataItem.detection +'';
            	var v= (detection == "null" ? "" : detection);
            	$.each(detectionData, function (i, n) {
                    if ((n.value || '').toLowerCase() == (v || '').toLowerCase()) {
                        v = n.meaning;
                        return v;
                    }
                });
                return v;
               
            },
            editor: function (container, options) {
                //$('<input required name="<@spring.message "fmea.detection"/>"/>')
                $('<input required name="' + options.field + '"/>')    
                	.appendTo(container)
                    .kendoDropDownList({
                        dataTextField: "meaning",
                        dataValueField: "value",
                        valuePrimitive: true,
                        dataSource:detectionData,
                        change:function(e){
                        	options.model.set('detection',this._old)
                        }
                    });
            },
        },
                {
            field: "rpn",
            title: '<@spring.message "fmea.rpn"/>',
            width: 70,
            template: function (dataItem) {
                return dataItem.rpn == "null" ? "" : dataItem.rpn;
            },
        },
        
        {
            field: "apVal",
            title: '<@spring.message "AP"/>',
            width: 160,
            template: function (dataItem) {
                return dataItem.apVal == "null" ? "" : dataItem.apVal;
            },
        },
            {
                field: "suggestMeasure",
                title: '<@spring.message "fmea.recommended.measures"/>',
                width: 160,
                template: function (dataItem) {
                    return dataItem.suggestMeasure == "null" ? "" : dataItem.suggestMeasure;
                },        
        },  
           {
            field: "useName",
            title: '<@spring.message "fmea.principal"/>',
            width: 80,
            attributes: {style: "text-align:center"},
            headerAttributes: {style: "text-align:center"},
            template: function (Item) {
                return Item['useName'] || ''
            },
            editor: function (container, options) {
                $('<input name="' + options.field + '"/>')
                    .appendTo(container)
                    .kendoLov($.extend(<@lov "user_lov"/>,{
                        query: function (e) {
                        },
                    textField: 'userName',
                    model: options.model,
                    change:function() {
                        var v = this.value();
                        if (v == undefined  || v == ""){
                            options.model.set('useName', "");
                            options.model.set('chargeId','')
                        }else{
                            options.model.useName =  this._dataItem.userName;
                            options.model.chargeId = this._dataItem.userId;
                        }
                    }
                })); 
            }
         },
        {
            field: "estimatedFinishTime",
            title: '<@spring.message "fmea.estimated.finish.time"/>',
            width: 160,
            format:"{0:yyyy-MM-dd}",
            editor:function(c,o){
            	$("<input name='"+o.field+"'/>").appendTo(c)
            	.kendoDatePicker({
//             		format: "yyyy-MM-dd",
//             		 change: function()
//             		{
//             			o.model.estimatedFinishTime  = this.value().format( "yyyy-MM-dd")  			
//             		}  
            	})
            }
        },
        {
            field: "measureResult",
            title: '<@spring.message "fmea.measure.result"/>',
            width: 180,
            template: function (dataItem) {
                return dataItem.measureResult == "null" ? "" : dataItem.measureResult;
            },        
        },
            {
        	field: "postSeverity",
            title: '<@spring.message "fmea.result.severity"/>',
            width: 60,
            template: function (dataItem) {
            	var postSeverity = dataItem.postSeverity +'';
            	var v= (postSeverity == "null" ? "" : postSeverity);
            	$.each(severityData, function (i, n) {
                    if ((n.value || '').toLowerCase() == (v || '').toLowerCase()) {
                        v = n.meaning;
                        return v;
                    }
                });
                return v;
               
            },
            editor: function (container, options) {
                //$('<input required name="<@spring.message "fmea.detection"/>"/>')
                $('<input  name="' + options.field + '"/>')    
                	.appendTo(container)
                    .kendoDropDownList({
                        dataTextField: "meaning",
                        dataValueField: "value",
                        valuePrimitive: true,
                        dataSource:severityData,
                        change:function(e){
                        	options.model.set('postSeverity',this._old)
                        }
                    });
            },
        },
            
            {
        	field: "postOccurrence",
            title: '<@spring.message "fmea.result.occurrence"/>',
            width: 60,
            template: function (dataItem) {
            	var postOccurrence = dataItem.postOccurrence +'';
            	var v= (postOccurrence == "null" ? "" : postOccurrence);
            	$.each(occurrenceData, function (i, n) {
                    if ((n.value || '').toLowerCase() == (v || '').toLowerCase()) {
                        v = n.meaning;
                        return v;
                    }
                });
                return v;
               
            },
            editor: function (container, options) {
                //$('<input required name="<@spring.message "fmea.detection"/>"/>')
                $('<input  name="' + options.field + '"/>')    
                	.appendTo(container)
                    .kendoDropDownList({
                        dataTextField: "meaning",
                        dataValueField: "value",
                        valuePrimitive: true,
                        dataSource:occurrenceData,
                        change:function(e){
                        	options.model.set('postOccurrence',this._old)
                        }
                    });
            },
            },
             {
        	field: "postDetection",
            title: '<@spring.message "fmea.result.detection"/>',
            width: 60,
            template: function (dataItem) {
            	var postDetection = dataItem.postDetection +'';
            	var v= (postDetection == "null" ? "" : postDetection);
            	$.each(detectionData, function (i, n) {
                    if ((n.value || '').toLowerCase() == (v || '').toLowerCase()) {
                        v = n.meaning;
                        return v;
                    }
                });
                return v;
               
            },
            editor: function (container, options) {
                //$('<input required name="<@spring.message "fmea.detection"/>"/>')
                $('<input  name="' + options.field + '"/>')    
                	.appendTo(container)
                    .kendoDropDownList({
                        dataTextField: "meaning",
                        dataValueField: "value",
                        valuePrimitive: true,
                        dataSource:detectionData,
                        change:function(e){
                        	options.model.set('postDetection',this._old)
                        }
                    });
            },
            },
              {
                  
        	field: "postRpn",
            title: '<@spring.message "fmea.result.rpn"/>',
            width: 80,
            template: function (dataItem) {
                return dataItem.postRpn == "null" ? "" : dataItem.postRpn;
       }, 
              },
              {
                  field: "",
                  title: '<@spring.message "fmea.operating"/>',
                  width: 200,
                  template: function (dataItem) {
                	  if(!isNotEmpty(dataItem.branchId)){
                		  //add
                		  if(dataItem.ranks == '2'){
                			  return '<a href="#" onclick="submitLine('+ dataItem.branchId +',' + dataItem.parentId +')"><@spring.message "hap.save"/></a>'  
                		  }else{
                			  return '<a href="#" onclick="submit('+ dataItem.branchId +',' + dataItem.parentId +')"><@spring.message "hap.save"/></a>' 
                		  }
                	  }else{
                		  if(dataItem.ranks == '1'){
                			  return '<a href="#" onclick="addrow('+ dataItem.branchId+ ',' + dataItem.ranks +')"><@spring.message "fmea.addaction"/></a>&nbsp;&nbsp;' 
	                			   + '<a href="#" onclick="editrow('+ dataItem.branchId +')"><@spring.message "fmea.edit"/></a>&nbsp;&nbsp;' 
	                			   + '<a href="#" onclick="submit('+ dataItem.branchId +',' + dataItem.parentId +')"><@spring.message "hap.save"/></a>&nbsp;&nbsp;'  
	                			   + '<a href="#" onclick="removerow('+ dataItem.branchId +')"><@spring.message "fmea.delect"/></a>';
                		  }else if(dataItem.ranks == '2'){
                			  return '<a href="#" onclick="editrow('+ dataItem.branchId +')"><@spring.message "fmea.edit"/></a>&nbsp;&nbsp;' 
	                			   + '<a href="#" onclick="submitLine('+ dataItem.branchId +',' + dataItem.parentId +')"><@spring.message "hap.save"/></a>&nbsp;&nbsp;'  
	                			   + '<a href="#" onclick="removerow('+ dataItem.branchId +')"><@spring.message "fmea.delect"/></a>';
                		  }
                	  }
                  },
              },
        ],
        editable: false
    }).data('kendoTreeList');
    
    /**
     * 新增下级
     */
    function addSon(branchId,branchName,ranks) {
    	 viewModel.model.set('severity',''); 
         viewModel.model.set('specialCharacteristicType','');
         viewModel.model.set('occurrence',''); 
         viewModel.model.set('detection',''); 
    	 viewModel.model.set('postSeverity',''); 
         viewModel.model.set('postOccurrence','');
         viewModel.model.set('postDetection',''); 
         viewModel.model.set('postRpn','');
    	$("#branchName").attr("disabled",false);
		//$('#branchName').css('background-color','#fff8c5');
    	if(ranks==1){//新增工序
    		$('#row1').css('display','none')
            $('#row2').css('display','none')
            $('#row3').css('display','none')
            $('#row4').css('display','none')
            $('#row5').css('display','none')
            $('#row6').css('display','none')
            $('#row7').css('display','none')
            $('#row8').css('display','none')
            $('#row9').css('display','none') 
            $('#cjname1').text('<@spring.message "fmea.request"/>')
            $('#funFlag').val(true);
    		  editDialog1.title('<@spring.message "fmea.newrequest"/>');
      		editDialog1.center().open();
    	}
    	if(ranks==2){//新增动作
    		$('#row1').css('display','block')
            $('#row2').css('display','block')
            $('#row3').css('display','block')
            $('#row4').css('display','block')
            $('#row5').css('display','block')
            $('#row6').css('display','block')
            $('#row7').css('display','block')
            $('#row8').css('display','block')
            $('#row9').css('display','block') 
            $('#cjname').text('<@spring.message "fmea.potential.failure"/>')
            $('#invalidFlag').val(true);
    		editDialog.title('<@spring.message "fmea.newfailure"/>');
    		editDialog.center().open();
    	}
    	
        editDialog.title("");
        //父层级赋值
        $("#parentBranchId").val(branchId);
        //获取ranks
        $('#ranks').val('');
        $('#ranks').val(ranks);
        //父层级不可修改
        $("#parentBranchId").attr("disabled",true);
        /* editDialog.center().open(); */
    }

    /**
     * 编辑
     */
    function edit(branchId,claim,potentialFailureMode,branchName,invalidConsequence,severity,specialCharacteristicType,failureReason,preventiveMeasure,occurrence,detectionMeasure,detection,rpn,chargeId ,suggestMeasure , estimatedFinishTime, postSeverity,postOccurrence , postDetection,postRpn, parentbranchId,ranks) {
       /*  editDialog.title("编辑潜在失效模式"); */
        $('#ranks').val('');
        $('#ranks').val(ranks);
        viewModel.model.set('severity',''); 
        viewModel.model.set('specialCharacteristicType','');
        viewModel.model.set('occurrence',''); 
        viewModel.model.set('detection',''); 
        $('#branchName').css('background-color','#fff8c5');
        $('#severity').css('background-color','#fff8c5');
        $('#occurrence').css('background-color','#fff8c5');
        $('#detection').css('background-color','#fff8c5');
    	if(ranks==2){//编辑动作
    		$('#row1').css('display','block')
            $('#row2').css('display','block')
            $('#row3').css('display','block')
            $('#row4').css('display','block')
            $('#row5').css('display','block')
            $('#row6').css('display','block')
            $('#row7').css('display','block')
            $('#row8').css('display','block')
            $('#row9').css('display','block') 
            $('#row_a').css('display','block') 
            $("#branchName").attr("disabled",true);
    		//$('#branchName').css('background-color','#d4d3cf');
    		$('#editInvalidFlag').val(true);
            $('#cjname').text('<@spring.message "fmea.potential.failure"/>')
            editDialog.center().open();
    	}else{//编辑工序
    		$('#row1').css('display','none')
            $('#row2').css('display','none')
            $('#row3').css('display','none')
            $('#row4').css('display','none')
            $('#row5').css('display','none')
            $('#row6').css('display','none')
            $('#row7').css('display','none')
            $('#row8').css('display','none')
            $('#row9').css('display','none') 
            $("#branchName").attr("disabled",false);
    		//$('#branchName').css('background-color','#fff8c5');
            $('#cjname1').text('<@spring.message "fmea.process"/>')
            $('#stuFlag').val(true);
            editDialog1.title('<@spring.message "fmea.edit"/>');
    		editDialog1.center().open();
    	}
        //$('#invalidConsequence').attr('disabled',true);
        $('#branchId').val(branchId);
        $('#branchName').val(branchName);
        $('#processFunctionName').val(branchName);
        $('#invalidConsequence').val(invalidConsequence);
        $('#claim').val(claim);
        $('#potentialFailureMode').val(potentialFailureMode);
        $('#severity').val(severity);
        $('#specialCharacteristicType').val(specialCharacteristicType);
        $('#failureReason').val(failureReason);
        $('#preventiveMeasure').val(preventiveMeasure);
        $('#occurrence').val(occurrence);
        $('#detectionMeasure').val(detectionMeasure);
        $('#detection').val(detection);
        $('#rpn').val(rpn);
        
        viewModel.model.set('chargeId',chargeId); 
        viewModel.model.set('suggestMeasure',suggestMeasure); 
        viewModel.model.set('estimatedFinishTime',estimatedFinishTime); 
        viewModel.model.set('postSeverity',postSeverity); 
        viewModel.model.set('postOccurrence',postOccurrence); 
        viewModel.model.set('postDetection',postDetection); 
        viewModel.model.set('postRpn',postRpn); 
        viewModel.model.set('severity',severity); 
        viewModel.model.set('specialCharacteristicType',specialCharacteristicType);
        viewModel.model.set('occurrence',occurrence); 
        viewModel.model.set('detection',detection); 
        // $('#attachment').css('background-color','#F5F5F5');
        //有父层级再赋值
        if(parentbranchId != 'null'){
        	$("#parentBranchId").val(parentbranchId);
        }

        /* editDialog.center().open(); */
    }
    

    /**
     * 保存编辑
     */
    function saveAttachment() {
    	//第一层
    	if($('#stuFlag').val()){//工序层级
    		if($('#processFunctionName').val()==null||$('#processFunctionName').val()==""||$('#processFunctionName').val()==undefined){
        		alert("请维护层级数据")
        	}else{
        		var obj = {
        				'fmeaId': kid,
          	            'branchId':$('#branchId').val(),
          	            'branchName':$('#processFunctionName').val(),
          	            'parentBranchId':$("#parentBranchId").val(),
          	            'ranks':$("#ranks").val(),
          	            'tenantId':-1,
          	            'siteId':-1
          	        };
        		$.ajax({
      	            type: "POST",
      	            url: BaseUrl + "/hqm/pfmea/save/or/update",
      	            data:obj,//json序列化
      	            datatype:"json", //此处不能省略
      	            success:function(data){
      	                if(data.success){
      	                    Hap.showToast({
      	                        type:'success',  //1.success 2.error
      	                        message: '保存成功',
      	                        hideDuration:2000,
      	                        "positionClass": "toast-bottom-right",
      	                    });
      	                    editDialog1.close();
      	                    grid.dataSource.read();
      	                }else{
      	                    alert(data.message);
      	                }
      	            },
      	            error:function(data){
      	                alert(JSON.stringify(data));
      	            }
      	        });
        	}
      			
    	}else if($('#editInvalidFlag').val()){//编辑动作层级
    		if($('#severity').val()==null||$('#severity').val()==""||$('#severity').val()==undefined){
        		alert("请维护严重度")
        	}else if($('#occurrence').val()==null||$('#occurrence').val()==""||$('#occurrence').val()==undefined){
        		alert("请维护频度")
        	}else if($('#detection').val()==null||$('#detection').val()==""||$('#detection').val()==undefined){
        		alert("请维护检测度")
        	}else{
        		if($('#postOccurrence').val()==null)
 	             {$('#postOccurrence').val('&nbsp')}
 	             
       		 if($('#postSeverity').val()==null)
	             {$('#postSeverity').val('&nbsp')}
	             
       		 if($('#postDetection').val()==null)
 	             {$('#postDetection').val('&nbsp')}
 	             
        		var obj = {
        				//新加字段
        				'fmeaId':kid,
          	            'branchId':$('#branchId').val(),
          	            'invalidConsequence':$('#invalidConsequence').val(),
	          	        'claim' : $('#claim').val(),
	          	        'potentialFailureMode' : $('#potentialFailureMode').val(),
          	            'severity':$('#severity').val(),
          	            'specialCharacteristicType':$('#specialCharacteristicType').val(),
          	            'failureReason':$('#failureReason').val(),
          	            'preventiveMeasure':$('#preventiveMeasure').val(),
          	            'occurrence':$('#occurrence').val(),
          	            'detectionMeasure':$('#detectionMeasure').val(),
          	            'detection':$('#detection').val(),
          	            'rpn':$('#rpn').val(),
          	            'suggestMeasure':$('#suggestMeasure').val(),
          	            'chargeId': viewModel.model.chargeId,
          	            'estimatedFinishTime':$('#estimatedFinishTime').val(),
          	            'measureResult':$('#measureResult').val(),
          	            'postOccurrence':$('#postOccurrence').val(),
		        		'postSeverity':$('#postSeverity').val(),  
		        		'postDetection':$('#postDetection').val(),           	           
          	            'postRpn':$('#postRpn').val(),         	        
          	            'parentBranchId':$("#parentBranchId").val(),
          	            'ranks':$("#ranks").val(),
          	            'tenantId':-1,
          	            'siteId':-1
          	        };
        		console.log("111111111"+$('#postOccurrence').val());
        	

        		console.log(viewModel.model);
        		$.ajax({
      	            type: "POST",
      	            url: BaseUrl + "/hqm/pfmea/save/or/update",
      	            data:obj,//json序列化
      	            datatype:"json", //此处不能省略
      	            success:function(data){
      	                if(data.success){
      	                    Hap.showToast({
      	                        type:'success',  //1.success 2.error
      	                        message: '保存成功',
      	                        hideDuration:2000,
      	                        "positionClass": "toast-bottom-right",
      	                    });
      	                    editDialog.close();
      	                    grid.dataSource.read();
      	                }else{
      	                    alert(data.message);
      	                }
      	            },
      	            error:function(data){
      	                alert(JSON.stringify(data));
      	            }
      	        });
        	}
    	}else{//新增动作层级
    		if($('#branchName').val()==null||$('#branchName').val()==""||$('#branchName').val()==undefined){
        		alert("请维护层级数据")
        	}else if($('#severity').val()==null||$('#severity').val()==""||$('#severity').val()==undefined){
        		alert("请维护严重度")
        	}else if($('#occurrence').val()==null||$('#occurrence').val()==""||$('#occurrence').val()==undefined){
        		alert("请维护频度")
        	}else if($('#detection').val()==null||$('#detection').val()==""||$('#detection').val()==undefined){
        		alert("请维护检测度")
        	}else{
        		var obj = {
        				'fmeaId':kid,
          	            'branchId':$('#branchId').val(),
          	            'branchName':$('#branchName').val(),
          	            'invalidConsequence':$('#invalidConsequence').val(),
          	          	'claim' : $('#claim').val(),
	          	        'potentialFailureMode' : $('#potentialFailureMode').val(),
          	            'severity':$('#severity').val(),
          	            'specialCharacteristicType':$('#specialCharacteristicType').val(),
          	            'failureReason':$('#failureReason').val(),
          	            'preventiveMeasure':$('#preventiveMeasure').val(),
          	            'occurrence':$('#occurrence').val(),
          	            'detectionMeasure':$('#detectionMeasure').val(),
          	            'detection':$('#detection').val(),
          	            'rpn':$('#rpn').val(),
          	            'suggestMeasure':$('#suggestMeasure').val(),
        	            'chargeId':viewModel.model.chargeId,
        	            'estimatedFinishTime':$('#estimatedFinishTime').val(),
        	            'measureResult':$('#measureResult').val(),
        	            'postOccurrence':$('#postOccurrence').val(),
        	            'postSeverity':$('#postSeverity').val(), 
        	            'postRpn':$('#postRpn').val(), 
        	            'postDetection':$('#postDetection').val(), 
          	            'parentBranchId':$("#parentBranchId").val(),
          	            'ranks':$("#ranks").val(),
          	            'tenantId':-1,
          	            'siteId':-1
          	        };
        		
           		$.ajax({
      	            type: "POST",
      	            url: BaseUrl + "/hqm/pfmea/save/or/update",
      	            data:obj,//json序列化
      	            datatype:"json", //此处不能省略
      	            success:function(data){
      	                if(data.success){
      	                    Hap.showToast({
      	                        type:'success',  //1.success 2.error
      	                        message: '保存成功',
      	                        hideDuration:2000,
      	                        "positionClass": "toast-bottom-right",
      	                    });
      	                    editDialog.close();
      	                    grid.dataSource.read();
      	                }else{
      	                    alert(data.message);
      	                }
      	            },
      	            error:function(data){
      	                alert(JSON.stringify(data));
      	            }
      	        });
        	}
  			
  			
  		}
    	
    }

    /**
     * 根据值获得快码的含义
     */
    function getMeanByValue(code,value) {
        var m;
        $.each(code, function (i, n) {
            if (n.value == value) {
                m = n.meaning;
            }
        });
        return m || '';
    }

    /**
     * 关闭弹窗
     */
    function closeDialog(dialogId) {
        $('#'+dialogId).data('kendoWindow').close();
    }


    

    /**
     * 删除
     */
    function deleteRow(id,code) {
        var obj = {
            'branchId':id,
            'branchName':code
            
        };
        kendo.ui.showInfoDialog({
            title:"提示",
            message: "确定删除？",
            buttons:[{text: "确定",
                type: 'primary',
                click: function (e) {
                    e.dialog.destroy();
                    $.ajax({
                        type: "POST",
                        url: BaseUrl + "/hqm/pfmea/delete/row",
                        data:obj,//json序列化
                        datatype:"json", //此处不能省略
                        success:function(data){
                            if(data.success){
                                Hap.showToast({
                                    type:'success',  //1.success 2.error
                                    message: '删除成功',
                                    hideDuration:2000,
                                    "positionClass": "toast-bottom-right",
                                });
                                editDialog.close();
                                 grid.dataSource.read();
                                
                            }else{
                                Hap.showToast({
                                    type:'error',  //1.success 2.error
                                    message: data.message,
                                    hideDuration:2000,
                                    "positionClass": "toast-bottom-right",
                                });
                            }
                        },
                        error:function(data){
                            alert(JSON.stringify(data));
                        }
                    });

                }
            },{text: "取消",
                type: 'default',
                click: function (e) {
                    e.dialog.destroy();
                }
            }]
        })
    }
    /**
     * 展开
     */
    function expand() {
        var tree = grid.dataSource.data();
        for (var i = 0; i < tree.length; i++) {
            if (tree[i].hasChildren) {
                grid.expand(tree[i]);
            }
        }
    }
    /**
     * 合并
     */
    function collapse() {
        var tree = grid.dataSource.data();
        for (var i = 0; i < tree.length; i++) {
            if (tree[i].hasChildren) {
                grid.collapse(tree[i]);
            }
        }
    }
    
    function getMeaningByValue(meaning,datasource){
    	var v = meaning ? meaning : "";
        $.each(datasource, function (i, n) {
            if ((n.value || '').toLowerCase() == (v || '').toLowerCase()) {
                v = n.meaning;
                return v;
            }
        })
        return v;
    }
    
    
    function addhead(){
    	grid.addRow();
    }
    var addLineFlag = false;
    var addRanks = -1;
    var addBranchId = -1;
    function addrow(branchId,ranks){
    	addLineFlag = true;
    	addRanks = parseInt(ranks) + 1;
    	addBranchId = branchId;
    	$.each(grid.dataSource.data(),function(i,n){
			if(n.branchId == branchId){
				//n.ranks = parseInt(ranks) + 1;
				grid.addRow("#grid tbody>tr:eq("+ i +")");
// 				$.each(grid.dataSource.data(),function(j,m){
// 					if(m.parentId == branchId && !isNotEmpty(m.branchId)){
// 						m.ranks = parseInt(ranks) + 1;
// 					}
// 				})
			}
    	})
    }
    function editrow(branchId){
    	$.each(grid.dataSource.data(),function(i,n){
    		if(n.branchId == branchId){
    			$("#grid").data("kendoTreeList").editRow($("#grid tbody>tr:eq("+ i +")"));
			}
    	})
    	//grid.editRow("#grid tbody>tr:eq(0)");
    }
    function submit(branchId,parentId){
    	var validator = $("#grid").kendoValidator().data("kendoValidator");
		if (validator.validate()) {	
	    	$.each(grid.dataSource.data(),function(i,n){
	    		if(branchId == n.branchId &&　n.dirty){    
			    	var obj = {
							'fmeaId': kid,
			  	            'branchId':branchId,
			  	            'branchName':n.branchName,
			  	            'parentBranchId':parentId,
			  	            'ranks':n.ranks,
			  	            'tenantId':-1,
			  	            'siteId':-1
			  	        };
					$.ajax({
				            type: "POST",
				            url: BaseUrl + "/hqm/pfmea/save/or/update",
				            data:obj,//json序列化
				            datatype:"json", //此处不能省略
				            success:function(data){
				                if(data.success){
				                    Hap.showToast({
				                        type:'success',  //1.success 2.error
				                        message: '保存成功',
				                        hideDuration:2000,
				                        "positionClass": "toast-bottom-right",
				                    });
				                    editDialog1.close();
				                    grid.dataSource.read();
				                }else{
				                    alert(data.message);
				                }
				            },
				            error:function(data){
				                alert(JSON.stringify(data));
				            }
				        });
	    		}
	    	})
		}
    }
    function submitLine(branchId,parentId){
    	var validator = $("#grid").kendoValidator().data("kendoValidator");
		if (validator.validate()) {			
	    	$.each(grid.dataSource.data(),function(i,n){
	    		if(n.dirty && isNotEmpty(branchId)){
	    			if(branchId == n.branchId){    				
		    			//edie
	    				var postRpn = null;
	    				if(isNotEmpty(n.postOccurrence)&&isNotEmpty(n.postSeverity)&&isNotEmpty(n.postDetection)){
	    					postRpn = parseInt(n.postOccurrence)*parseInt(n.postSeverity)*parseInt(n.postDetection);
	    				}
		    			var obj = {
								//新加字段
								'fmeaId':kid,
				  	            'branchId':branchId,
				  	          	'branchName':n.branchName,
				  	            'invalidConsequence':n.invalidConsequence,
				  	          	'claim' : n.claim,
			          	        'potentialFailureMode' : n.potentialFailureMode,
				  	            'severity':n.severity,
				  	            'specialCharacteristicType':n.specialCharacteristicType,
				  	            'failureReason':n.failureReason,
				  	            'preventiveMeasure':n.preventiveMeasure,
				  	            'occurrence':n.occurrence,
				  	            'detectionMeasure':n.detectionMeasure,
				  	            'detection':n.detection,
				  	            'rpn': parseInt(n.severity)*parseInt(n.occurrence)*parseInt(n.detection),
				  	            'suggestMeasure':n.suggestMeasure,
				  	            'chargeId': n.chargeId,
				  	            'estimatedFinishTime':n.estimatedFinishTime?n.estimatedFinishTime + ' 00:00:00' : null,
				  	            'measureResult':n.measureResult,
				  	            'postOccurrence':n.postOccurrence,
				        		'postSeverity':n.postSeverity,  
				        		'postDetection':n.postDetection,           	           
				  	            'postRpn':postRpn,         	        
				  	            'parentBranchId':parentId,
				  	            'ranks':n.ranks,
				  	            'tenantId':-1,
				  	            'siteId':-1
				  	        };
		    			console.log(obj)
						$.ajax({
					            type: "POST",
					            url: BaseUrl + "/hqm/pfmea/save/or/update",
					            data:obj,//json序列化
					            datatype:"json", //此处不能省略
					            success:function(data){
					                if(data.success){
					                    Hap.showToast({
					                        type:'success',  //1.success 2.error
					                        message: '保存成功',
					                        hideDuration:2000,
					                        "positionClass": "toast-bottom-right",
					                    });
					                    editDialog.close();
					                    grid.dataSource.read();
					                }else{
					                    alert(data.message);
					                }
					            },
					            error:function(data){
					                alert(JSON.stringify(data));
					            }
					        });
	    			}
	    		}else if(n.dirty && !isNotEmpty(branchId)){
	    				var postRpn = null;
	    				if(isNotEmpty(n.postOccurrence)&&isNotEmpty(n.postSeverity)&&isNotEmpty(n.postDetection)){
	    					postRpn = parseInt(n.postOccurrence)*parseInt(n.postSeverity)*parseInt(n.postDetection);
	    				}
		    			//add
		    			var obj = {
		        				'fmeaId':kid,
		          	            'branchId':branchId,
		          	            'branchName':n.branchName,
		          	            'invalidConsequence':n.invalidConsequence,
		          	          	'claim' : n.claim,
			          	        'potentialFailureMode' : n.potentialFailureMode,
		          	            'severity':n.severity,
		          	            'specialCharacteristicType':n.specialCharacteristicType,
		          	            'failureReason':n.failureReason,
		          	            'preventiveMeasure':n.preventiveMeasure,
		          	            'occurrence':n.occurrence,
		          	            'detectionMeasure':n.detectionMeasure,
		          	            'detection':n.detection,
		          	            'rpn':parseInt(n.severity)*parseInt(n.occurrence)*parseInt(n.detection),
		          	            'suggestMeasure':n.suggestMeasure,
		        	            'chargeId':n.chargeId,
		        	            'estimatedFinishTime':n.estimatedFinishTime,
		        	            'measureResult':n.measureResult,
		        	            'postOccurrence':n.postOccurrence,
		        	            'postSeverity':n.postSeverity, 
		        	            'postRpn':postRpn, 
		        	            'postDetection':n.postDetection,
		          	            'parentBranchId':parentId,
		          	            'ranks':n.ranks,
		          	            'tenantId':-1,
		          	            'siteId':-1
		          	        };
		           		$.ajax({
		      	            type: "POST",
		      	            url: BaseUrl + "/hqm/pfmea/save/or/update",
		      	            data:obj,//json序列化
		      	            datatype:"json", //此处不能省略
		      	            success:function(data){
		      	                if(data.success){
		      	                    Hap.showToast({
		      	                        type:'success',  //1.success 2.error
		      	                        message: '保存成功',
		      	                        hideDuration:2000,
		      	                        "positionClass": "toast-bottom-right",
		      	                    });
		      	                    editDialog.close();
		      	                    grid.dataSource.read();
		      	                }else{
		      	                    alert(data.message);
		      	                }
		      	            },
		      	            error:function(data){
		      	                alert(JSON.stringify(data));
		      	            }
		      	        });
	    			
	    		}
	    	})
		}
    }
    function removerow(branchId){
    	$.each(grid.dataSource.data(),function(i,n){
    		if(branchId == n.branchId){
    			deleteRow(branchId,n.branchName);
    		}
    	})
    	
    }
    
</script>
</body>
</html>