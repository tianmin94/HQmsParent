<#include "../include/header.html">
<script src="${base.contextPath}/common/code?PSPC_CHART_TYPE=PSPC.CHART.TYPE"></script>
<script src="${base.contextPath}/common/code?PSPC_JUDGEMENT=PSPC.JUDGEMENT" type="text/javascript"></script>
<script type="text/javascript">
    var checkData;//选择的行数据
    var minDate = new Date(1000, 0, 1);
    var maxDate = new Date(9999, 11, 31);


    var grid;
    var oocViewModel = Hap.createGridViewModel("#oocGrid");
    var countOocViewModel = Hap.createGridViewModel("#countOocGrid");
    var viewModel = kendo.observable({
        model: {},
        query:function () {
            //必输校验
            if(!viewModel.model.startDate || !viewModel.model.endDate){
                kendo.ui.showInfoDialog({
                    message: '请选择样本开始时间和结束时间'
                });
                return;
            }

            console.log(viewModel.model);
            //赋值查询条件
            oocViewModel.model.ceGroupId = viewModel.model.ceGroupId;
            oocViewModel.model.ceParameterId = viewModel.model.ceParameterId;
            oocViewModel.model.attachmentGroupId = viewModel.model.attachmentGroupId;
            oocViewModel.model.entityId = viewModel.model.entityId;
            oocViewModel.model.startDate = viewModel.model.startDate;
            oocViewModel.model.endDate = viewModel.model.endDate;
            countOocViewModel.model.ceGroupId = viewModel.model.ceGroupId;
            countOocViewModel.model.ceParameterId = viewModel.model.ceParameterId;
            countOocViewModel.model.attachmentGroupId = viewModel.model.attachmentGroupId;
            countOocViewModel.model.entityId = viewModel.model.entityId;
            countOocViewModel.model.startDate = viewModel.model.startDate;
            countOocViewModel.model.endDate = viewModel.model.endDate;

            //查询
            $("#oocGrid").data('kendoGrid').dataSource.read();
            $("#oocGrid").data('kendoGrid').dataSource.page(1);
            $("#countOocGrid").data('kendoGrid').dataSource.read();
            $("#countOocGrid").data('kendoGrid').dataSource.page(1);
        },
        resetFunction: function (e) {
            var formData = viewModel.model.toJSON();
            for (var k in formData) {
                viewModel.model.set(k, null);
            }
        },
        exportExcel: function () {
            var oocData = oocDataSource.data();
            var countOocData = countOocDataSource.data();
            var sheets = [];

            //判空
            if((oocData == null || oocData.length === 0) && (countOocData == null || countOocData.length === 0)) {
                kendo.ui.showInfoDialog({
                    message: '无有效数据需要导出!'
                });
                return;
            }

            //判断计量型是否有数据
            if(oocData != null && oocData.length > 0){
                //获取grid信息，用于设置标题
                var grid = $("#oocGrid").data("kendoGrid");
                //获取sheet页
                var sheet = this.getExcelSheet(oocData, grid, '计量型');
                //添加到sheet页集合
                sheets.push(sheet);
            }

            //判断计数型是否有数据
            if(countOocData != null && countOocData.length > 0){
                //获取grid信息，用于设置标题
                var grid = $("#countOocGrid").data("kendoGrid");
                //获取sheet页
                var sheet = this.getExcelSheet(countOocData, grid, '计数型');
                //添加到sheet页集合
                sheets.push(sheet);
            }

            //创建工作册
            var workbook = new kendo.ooxml.Workbook({
                sheets: sheets
            });

            //保存为excel文件
            kendo.saveAs({ dataURI: workbook.toDataURL(), fileName: 'OOC报表导出.xlsx' });
        },
        getExcelSheet: function (data, grid, sheetName) {
            var rows = []; //excel中的所有的行
            var headCells = [];  //获取grid列表中的标题列
            var cellWidths = []; //设置每列的宽度

            //填充列头和列宽，跳过第一列序号和第二列id和最后一列操作
            for (var k = 2; k < grid.columns.length-1; k++) {
                cellWidths.push({width: grid.columns[k].width});
                headCells.push({ value: grid.columns[k].title, textAlign: "center", background: '#7A7A7A', color: '#FFF'});
            }
            rows.push({cells: headCells}); //将标题行添加到rows集合中

            //添加行数据
            $.each(data, function (i, v) {
                //获取快码值
                var fChartType = v.chartType;
                $.each(PSPC_CHART_TYPE, function (i, n) {
                    if ((n.value || '').toLowerCase() === (fChartType || '').toLowerCase()) {
                        fChartType = n.meaning;
                        return false;
                    }
                });
                var fJudgementCode = v.judgementCode;
                $.each(PSPC_JUDGEMENT, function (i, n) {
                    if ((n.value || '').toLowerCase() === (fJudgementCode || '').toLowerCase()) {
                        fJudgementCode = n.meaning;
                        return false;
                    }
                });

                //创建当前行的数组变量
                var currentRow = [
                    {textAlign: "center", value: v.entityCode},
                    {textAlign: "center", value: v.entityDesc},
                    {textAlign: "center", value: fChartType},
                    {textAlign: "center", value: v.entityVersion},
                    {textAlign: "center", value: v.ceGroup},
                    {textAlign: "center", value: v.ceGroupDesc},
                    {textAlign: "center", value: v.attachmentGroupDesc},
                    {textAlign: "center", value: v.ceParameter},
                    {textAlign: "center", value: v.ceParameterName},
                    {textAlign: "center", value: v.chartCode},
                    {textAlign: "center", value: v.chartDesc},
                    {textAlign: "center", value: v.judgementShortCode},
                    {textAlign: "center", value: fJudgementCode},
                    {textAlign: "center", value: v.messageTypeCode},
                    {textAlign: "center", value: v.oocStatus},
                    {textAlign: "center", value: v.classifyGroupDesc},
                    {textAlign: "center", value: v.classifyDesc},
                    {textAlign: "center", value: v.creationDateStr},
                    {textAlign: "center", value: v.remark}
                ];
                rows.push({ cells: currentRow }); //添加行元素
            });

            //sheet页
            var sheet = {
                name: sheetName,//sheet页名称
                //frozenRows: 9,//行冻结 索引从1开始
                frozenColumns: 9,//列冻结 索引从1开始
                //mergedCells: ["A1:G1","C15:E15"],//单元格合并
                filter: { from: 0, to: 18 },//筛选列 索引从0开始
                columns: cellWidths,
                rows: rows
            };

            return sheet;
        }

    });
</script>
<style>
    .button-action {
        color: #758697;
        cursor: pointer;
    }

    .grid-div {
        position: absolute;
        overflow: hidden;
        width: 99%;
    }

    .top-label{
        width: 120px;
        text-align: right;
    }
</style>
<body>
<div id="dialog"></div>
<div id="page-content">
    <!-- 按钮 -->
    <div class="pull-right" id="query-form" style="padding-bottom:10px;">
        <span class="btn btn-primary k-grid-add" style="float:left;margin-right:5px;" onclick="create8DReport()"><@spring.message "pspcooc.create8dreport"/></span>
        <span class="btn btn-default" style="float:left; margin-right:5px; width:70px;" onclick="viewModel.resetFunction()"><@spring.message "hap.reset"/></span>
        <span class="btn btn-primary" style="float:left; margin-right:5px; width:70px" data-bind="click:query" type="submit"><@spring.message "hap.query"/></span>
        <span class="btn btn-default" style="float:left; width:70px;" onclick="viewModel.exportExcel()"><@spring.message "hap.exportexcel"/></span>
        <div style="clear:both"></div>
    </div>
    <script>kendo.bind($('#query-form'), viewModel);</script>

    <!-- 查询条件 -->
    <div id="queryModel" style="clear:both">
        <!--第一行-->
        <div class="row">
            <div class="col-md-4">
                <label class="top-label" style="font-size: 14px;color:black"><@spring.message "pspcooc.cegroup"/>：</label>
                <input id="ceGroupId"  type="text" style="width:180px;margin-right:5px;"
                       data-bind="value:model.ceGroupId">
                <script>
                    $("#ceGroupId").kendoLov($.extend(${lovProvider.getLov(base.contextPath, base.locale, "PSPC_PSPC_CE_GROUP")}, {
                        select:function (e) {
                            viewModel.model.set('ceGroup', e.item.ceGroup);
                        }
                    }))
                </script>
            </div>

            <div class="col-md-4">
                <label class="top-label" style="font-size: 14px;color:black"><@spring.message "pspcooc.ceparameter"/>：</label>
                <input id="ceParameterId"  type="text" style="width:180px;margin-right:5px;"
                       data-bind="value:model.ceParameterId">
                <script>
                    $("#ceParameterId").kendoLov($.extend(${lovProvider.getLov(base.contextPath, base.locale, "PSPC_PSPC_CE_PARAMETER")}, {
                        query:function (e) {
                            e.param['ceGroupId']=viewModel.model.ceGroupId;
                        },
                        select:function (e) {
                            viewModel.model.set('ceParameter', e.item.ceParameter);
                        }
                    }))
                </script>
            </div>

            <div class="col-md-4">
                <label class="top-label" style="font-size: 14px;color:black"><@spring.message "pspcooc.attachmentgroup"/>：</label>
                <input id="attachmentGroupId" type="text" style="width:180px;margin-right:5px;"
                       data-bind="value:model.attachmentGroupId">
                <script>
                    $("#attachmentGroupId").kendoLov($.extend(${lovProvider.getLov(base.contextPath, base.locale, "PSPC_PSPC_ATTACHMENT_GROUP_PRO")}, {
                        select:function (e) {
                            viewModel.model.set('attachmentGroupDescription', e.item.attachmentGroupDescription);
                        },
                    }))
                </script>
            </div>
        </div>
        <br>

        <!--第二行-->
        <div class="row">
            <div class="col-md-4">
                <label class="top-label" style="font-size: 14px;color:black"><@spring.message "pspcooc.entitycode"/>：</label>
                <input type="text" id="eneityId" placeholder='<@spring.message "pspcooc.entitycode"/>' style="width:180px;margin-right:5px;" data-bind="value:model.entityId">
                <script>
                    $("#eneityId").kendoLov($.extend(<@lov "PSPC_PSPC_ENTITY"/>,{
                        textField: 'entityCode',
                        valueField:'entityId',
                        select:function (e) {
                            viewModel.model.set('entityCode', e.item.entityCode);
                            viewModel.model.set('entityVersion', e.item.entityVersion);
                        }
                    })).data("kendoLov");
                </script>
            </div>

            <div class="col-md-4">
                <label class="top-label" style="font-size: 14px;color:black"><span style='color:red'>*&nbsp;&nbsp;</span><@spring.message "pspcooc.datastarttime"/>：</label>
                <input id="startDate" required type="text" style="width:180px;margin-right:5px;"
                       data-bind="value:model.startDate">
                <script>
                    $("#startDate").kendoDateTimePicker({
                        format: "yyyy-MM-dd HH:mm:ss",
                        min: minDate,
                        max: maxDate,
                        close: function(e) {
                            var value = this.value();
                            if(value > maxDate) {
                                this.value(maxDate);
                            }
                            minDate = this.value();
                        }
                    }).data("kendoDateTimePicker");
                </script>
            </div>

            <div class="col-md-4">
                <label class="top-label" style="font-size: 14px;color:black"><span style='color:red'>*&nbsp;&nbsp;</span><@spring.message "pspcooc.dataendtime"/>：</label>
                <input id="endDate" required type="text" style="width:180px;margin-right:5px;"
                       data-bind="value:model.endDate">
                <script>
                    $("#endDate").kendoDateTimePicker({
                        format: "yyyy-MM-dd HH:mm:ss",
                        min: minDate,
                        max: maxDate,
                        close: function(e) {
                            var value = this.value();
                            if(value < minDate) {
                                this.value(minDate);
                            }
                            maxDate = this.value();
                        }
                    }).data("kendoDateTimePicker");
                </script>
            </div>
        </div>
        <br>
    </div>
    <script>kendo.bind($('#queryModel'), viewModel);</script>

    <!-- 分类项和控制要素 tab页切换 -->
    <div style="margin-top: 10px">
        <ul class="nav nav-tabs" id="mytab" style="height: 39px">
            <li class="active" data-gridid="oocGrid" >
                <a href="#showTreeUnit" data-toggle="tab"><@spring.message "pspcooc.meteringtype"/></a>
            </li>
            <li class="" data-gridid="countOocGrid">
                <a href="#showTreeUnit" data-toggle="tab" ><@spring.message "pspcooc.countingtype"/></a>
            </li>
        </ul>
        <div id="tabContent" class="tab-content" >
            <div class="tab-pane fade in active" style="margin-top: 10px; " id="maintain">
                <div id="page-content1">
                    <div id='grid-container' style="width: 100%;">
                        <div id="oocGridDiv" class="grid-div">
                            <div id="oocGrid" style="margin-top: 15px;float: left; width: 99%"></div>
                        </div>

                        <div id="countOocGridDiv" class="grid-div" style="height: 0px">
                            <div id="countOocGrid" style="margin-top: 15px;float: left; width: 99%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="showTreeUnit" class="tab-pane fade">
                <div id="treeList"></div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    Hap.initEnterQuery('#query-form', viewModel.query);
    var BaseUrl = _basePath;

    var oocDataSource = new kendo.data.DataSource({
        transport: {
            read: {
                url: BaseUrl + "/pspc/ooc/query/report",
                type: "POST",
                dataType: "json"
            },
            parameterMap: function (options, type) {
                if (type !== "read" && options.models) {
                    var datas = Hap.prepareSubmitParameter(options, type)
                    return kendo.stringify(datas);
                } else if (type === "read") {
                    return Hap.prepareQueryParameter(oocViewModel.model.toJSON(), options)
                }
            }
        },
        batch: true,
        serverPaging: false,
        pageSize: 10,
        schema: {
            data: 'rows',
            total: 'total',
            model: {
                id: "oocId",
                fields: {}
            }
        }
    });

    var oocColumns = [
        {
            field: "oocId",
            title: '<@spring.message "ooc.oocid"/>',
            width: 120,
            hidden: true,
            locked:true,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"}
        },
        {
            field: "entityCode",
            title: '<@spring.message "pspcooc.entitycode"/>',
            width: 120,
            locked:true,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            editor: function (container, options) {
                var val = options.model.entityCode == null ? '' : options.model.entityCode;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "entityDesc",
            title: '<@spring.message "pspcooc.entitydesc"/>',
            width: 120,
            locked:true,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            editor: function (container, options) {
                var val = options.model.entityDesc == null ? '' : options.model.entityDesc;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "chartType",
            title: '<@spring.message "pspcooc.charttype"/>',
            width: 120,
            locked:true,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            template: function (dataItem) {
                var v = dataItem.chartType ? dataItem.chartType : "";
                $.each(PSPC_CHART_TYPE, function (i, n) {
                    if ((n.value || '').toLowerCase() == (v || '').toLowerCase()) {
                        v = n.meaning;
                        return v;
                    }
                });
                return v;
            },
            editor: function (container, options) {
                var val = options.model.chartType == null ? '' : options.model.chartType;
                $.each(PSPC_CHART_TYPE, function (i, n) {
                    if ((n.value || '').toLowerCase() == (val || '').toLowerCase()) {
                        val = n.meaning;
                        return val;
                    }
                });
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "entityVersion",
            title: '<@spring.message "pspcooc.entityversion"/>',
            width: 120,
            locked:true,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            editor: function (container, options) {
                var val = options.model.entityVersion == null ? '' : options.model.entityVersion;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "ceGroup",
            title: '<@spring.message "pspcooc.cegroup"/>',
            width: 120,
            locked:true,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            editor: function (container, options) {
                var val = options.model.ceGroup == null ? '' : options.model.ceGroup;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "ceGroupDesc",
            title: '<@spring.message "pspcooc.cegroupdesc"/>',
            width: 120,
            locked:true,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            editor: function (container, options) {
                var val = options.model.ceGroupDesc == null ? '' : options.model.ceGroupDesc;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "attachmentGroupDesc",
            title: '<@spring.message "pspcooc.attachmentgroup"/>',
            width: 120,
            locked:true,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            editor: function (container, options) {
                var val = options.model.attachmentGroupDesc == null ? '' : options.model.attachmentGroupDesc;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "ceParameter",
            title: '<@spring.message "pspcooc.ceparameter"/>',
            width: 120,
            locked:true,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            editor: function (container, options) {
                var val = options.model.ceParameter == null ? '' : options.model.ceParameter;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "ceParameterName",
            title: '<@spring.message "pspcooc.ceparametername"/>',
            width: 120,
            locked:true,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            editor: function (container, options) {
                var val = options.model.ceParameterName == null ? '' : options.model.ceParameterName;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "chartCode",
            title: '<@spring.message "pspcooc.chartcode"/>',
            width: 120,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            editor: function (container, options) {
                var val = options.model.chartCode == null ? '' : options.model.chartCode;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "chartDesc",
            title: '<@spring.message "pspcooc.chartdesc"/>',
            width: 120,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            editor: function (container, options) {
                var val = options.model.chartDesc == null ? '' : options.model.chartDesc;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "judgementShortCode",
            title: '<@spring.message "pspcooc.judgementshortcode"/>',
            width: 120,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            editor: function (container, options) {
                var val = options.model.judgementShortCode == null ? '' : options.model.judgementShortCode;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "judgementCode",
            title: '<@spring.message "pspcooc.judgementcode1"/>',
            width: 200,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            template: function (dataItem) {
                var v = dataItem.judgementCode;
                $.each(PSPC_JUDGEMENT, function (i, n) {
                    if ((n.value || '').toLowerCase() == (v || '').toLowerCase()) {
                        v = n.meaning;
                        return false;
                    }
                });
                return v||"";
            },
            editor: function (container, options) {
                var val = options.model.judgementCode == null ? '' : options.model.judgementCode;
                $.each(PSPC_JUDGEMENT, function (i, n) {
                    if ((n.value || '').toLowerCase() == (val || '').toLowerCase()) {
                        val = n.meaning;
                        return false;
                    }
                });
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "messageTypeCode",
            title: '<@spring.message "pspcooc.messagetypecode"/>',
            width: 130,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            editor: function (container, options) {
                var val = options.model.messageTypeCode == null ? '' : options.model.messageTypeCode;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "oocStatus",
            title: '<@spring.message "pspcooc.oocstatus"/>',
            width: 120,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            editor: function (container, options) {
                var val = options.model.oocStatus == null ? '' : options.model.oocStatus;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "classifyGroupId",
            title: '<@spring.message "pspcooc.classifygroupid"/>',
            width: 120,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            template: function(item){
                return item['classifyGroupDesc']||''
            },
            editor: function (container, options) {
                var val = options.model.classifyGroupDesc == null ? '' : options.model.classifyGroupDesc;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "classifyId",
            title: '<@spring.message "pspcooc.classifyid"/>',
            width: 120,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            template: function(item){
                return item['classifyDesc']||''
            },
            editor: function (container, options) {
                var val = options.model.classifyDesc == null ? '' : options.model.classifyDesc;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "creationDateStr",
            title: '<@spring.message "pspcooc.creationdate"/>',
            width: 150,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            editor: function (container, options) {
                var val = options.model.creationDateStr == null ? '' : options.model.creationDateStr;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "remark",
            title: '<@spring.message "pspcooc.remark"/>',
            width: 120,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            editor: function (container, options) {
                var val = options.model.remark == null ? '' : options.model.remark;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "",
            title: '<@spring.message "pspcooc.operation"/>',
            width: 120,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            template:function (dataItem) {
                return '<label>' +
                    '<span class="button-action" onclick="editOoc(\'' + dataItem.oocId + '\', \'OOC\')">编辑</span>' +
                    '&nbsp;&nbsp;&nbsp;' +
                    '<span class="button-action" onclick="showChart(\'' + dataItem.entityId + '\', \'' + dataItem.entityCode + '\', \'' + dataItem.chartId + '\', \'OOC\')">展示图</span></label>';
            }
        }
    ];

    var countOocDataSource = new kendo.data.DataSource({
        transport: {
            read: {
                url: BaseUrl + "/pspc/count/ooc/query/report",
                type: "POST",
                dataType: "json"
            },
            parameterMap: function (options, type) {
                if (type !== "read" && options.models) {
                    var datas = Hap.prepareSubmitParameter(options, type)
                    return kendo.stringify(datas);
                } else if (type === "read") {
                    return Hap.prepareQueryParameter(countOocViewModel.model.toJSON(), options)
                }
            }
        },
        batch: true,
        serverPaging: false,
        pageSize: 10,
        schema: {
            data: 'rows',
            total: 'total',
            model: {
                id: "countOocId",
                fields: {}
            }
        }
    });

    var countOocColumns = [
        {
            field: "oocId",
            title: '<@spring.message "ooc.oocid"/>',
            width: 120,
            hidden: true,
            locked:true,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"}
        },
        {
            field: "entityCode",
            title: '<@spring.message "pspcooc.entitycode"/>',
            width: 120,
            locked:true,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            editor: function (container, options) {
                var val = options.model.entityCode == null ? '' : options.model.entityCode;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "entityDesc",
            title: '<@spring.message "pspcooc.entitydesc"/>',
            width: 120,
            locked:true,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            editor: function (container, options) {
                var val = options.model.entityDesc == null ? '' : options.model.entityDesc;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "chartType",
            title: '<@spring.message "pspcooc.charttype"/>',
            width: 120,
            locked:true,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            template: function (dataItem) {
                var v = dataItem.chartType ? dataItem.chartType : "";
                $.each(PSPC_CHART_TYPE, function (i, n) {
                    if ((n.value || '').toLowerCase() == (v || '').toLowerCase()) {
                        v = n.meaning;
                        return v;
                    }
                });
                return v;
            },
            editor: function (container, options) {
                var val = options.model.chartType == null ? '' : options.model.chartType;
                $.each(PSPC_CHART_TYPE, function (i, n) {
                    if ((n.value || '').toLowerCase() == (val || '').toLowerCase()) {
                        val = n.meaning;
                        return val;
                    }
                });
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "entityVersion",
            title: '<@spring.message "pspcooc.entityversion"/>',
            width: 120,
            locked:true,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            editor: function (container, options) {
                var val = options.model.entityVersion == null ? '' : options.model.entityVersion;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "ceGroup",
            title: '<@spring.message "pspcooc.cegroup"/>',
            width: 120,
            locked:true,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            editor: function (container, options) {
                var val = options.model.ceGroup == null ? '' : options.model.ceGroup;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "ceGroupDesc",
            title: '<@spring.message "pspcooc.cegroupdesc"/>',
            width: 120,
            locked:true,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            editor: function (container, options) {
                var val = options.model.ceGroupDesc == null ? '' : options.model.ceGroupDesc;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "attachmentGroupDesc",
            title: '<@spring.message "pspcooc.attachmentgroup"/>',
            width: 120,
            locked:true,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            editor: function (container, options) {
                var val = options.model.attachmentGroupDesc == null ? '' : options.model.attachmentGroupDesc;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "ceParameter",
            title: '<@spring.message "pspcooc.ceparameter"/>',
            width: 120,
            locked:true,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            editor: function (container, options) {
                var val = options.model.ceParameter == null ? '' : options.model.ceParameter;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "ceParameterName",
            title: '<@spring.message "pspcooc.ceparametername"/>',
            width: 120,
            locked:true,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            editor: function (container, options) {
                var val = options.model.ceParameterName == null ? '' : options.model.ceParameterName;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "chartCode",
            title: '<@spring.message "pspcooc.chartcode"/>',
            width: 120,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            editor: function (container, options) {
                var val = options.model.chartCode == null ? '' : options.model.chartCode;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "chartDesc",
            title: '<@spring.message "pspcooc.chartdesc"/>',
            width: 120,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            editor: function (container, options) {
                var val = options.model.chartDesc == null ? '' : options.model.chartDesc;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "judgementShortCode",
            title: '<@spring.message "pspcooc.judgementshortcode"/>',
            width: 120,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            editor: function (container, options) {
                var val = options.model.judgementShortCode == null ? '' : options.model.judgementShortCode;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "judgementCode",
            title: '<@spring.message "pspcooc.judgementcode1"/>',
            width: 200,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            template: function (dataItem) {
                var v = dataItem.judgementCode;
                $.each(PSPC_JUDGEMENT, function (i, n) {
                    if ((n.value || '').toLowerCase() == (v || '').toLowerCase()) {
                        v = n.meaning;
                        return false;
                    }
                });
                return v||"";
            },
            editor: function (container, options) {
                var val = options.model.judgementCode == null ? '' : options.model.judgementCode;
                $.each(PSPC_JUDGEMENT, function (i, n) {
                    if ((n.value || '').toLowerCase() == (val || '').toLowerCase()) {
                        val = n.meaning;
                        return false;
                    }
                });
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "messageTypeCode",
            title: '<@spring.message "pspcooc.messagetypecode"/>',
            width: 130,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            editor: function (container, options) {
                var val = options.model.messageTypeCode == null ? '' : options.model.messageTypeCode;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "oocStatus",
            title: '<@spring.message "pspcooc.oocstatus"/>',
            width: 120,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            editor: function (container, options) {
                var val = options.model.oocStatus == null ? '' : options.model.oocStatus;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "classifyGroupId",
            title: '<@spring.message "pspcooc.classifygroupid"/>',
            width: 120,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            template: function(item){
                return item['classifyGroupDesc']||''
            },
            editor: function (container, options) {
                var val = options.model.classifyGroupDesc == null ? '' : options.model.classifyGroupDesc;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "classifyId",
            title: '<@spring.message "pspcooc.classifyid"/>',
            width: 120,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            template: function(item){
                return item['classifyDesc']||''
            },
            editor: function (container, options) {
                var val = options.model.classifyDesc == null ? '' : options.model.classifyDesc;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "creationDateStr",
            title: '<@spring.message "pspcooc.creationdate"/>',
            width: 150,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            editor: function (container, options) {
                var val = options.model.creationDateStr == null ? '' : options.model.creationDateStr;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "remark",
            title: '<@spring.message "pspcooc.remark"/>',
            width: 120,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            editor: function (container, options) {
                var val = options.model.remark == null ? '' : options.model.remark;
                $('<span>' + val + '</span>').appendTo(container);
            }
        },
        {
            field: "",
            title: '<@spring.message "pspcooc.operation"/>',
            width: 120,
            attributes: {style: "text-align:center;"},
            headerAttributes: {style: "text-align:center"},
            template:function (dataItem) {
                return '<label>' +
                    '<span class="button-action" onclick="editOoc(\'' + dataItem.oocId + '\', \'COUNT_OOC\')">编辑</span>' +
                    '&nbsp;&nbsp;&nbsp;' +
                    '<span class="button-action" onclick="showChart(\'' + dataItem.entityId + '\', \'' + dataItem.entityCode + '\', \'' + dataItem.chartId + '\', \'COUNT_OOC\')">展示图</span></label>';
            }
        }
    ];

    //加载Grid
    initGrid('oocGrid', oocDataSource, oocColumns);
    initGrid('countOocGrid', countOocDataSource, countOocColumns);

    /**
     * @Description 编辑
     *              oocId:OOC ID
     *              oocType:OOC类型 OOC/COUNT_OOC
     * @author yuchao.wang
     * @date 2019/8/30 11:35
     */
    function editOoc(oocId, oocType){
        var dialog = $("#dialog").kendoWindow({
            actions: ["Close"],
            width: '90%',
            height: '90%',
            title: '<@spring.message "编辑"/>',
            visible: false,
            iframe: true,
            modal: false,
            content: 'ooc_edit.html?oocId='+oocId+'&oocType='+oocType,
            close: function () {
                //查询
                $("#oocGrid").data('kendoGrid').dataSource.read();
                $("#oocGrid").data('kendoGrid').dataSource.page(1);
                $("#countOocGrid").data('kendoGrid').dataSource.read();
                $("#countOocGrid").data('kendoGrid').dataSource.page(1);
            }
        }).data("kendoWindow");
        dialog.center().open();
    }

    /**
     * @Description 展示图
     *              entityId:实体控制图ID
     *              entityCode:实体控制图编码
     *              chartId:控制图ID
     *              oocType:OOC类型 OOC/COUNT_OOC
     * @author yuchao.wang
     * @date 2019/8/30 11:35
     */
    function showChart(entityId, entityCode, chartId, oocType){
        var dialog = $("#dialog").kendoWindow({
            actions: ["Close"],
            width: '90%',
            height: '90%',
            title: '<@spring.message "图形展示"/>',
            visible: false,
            iframe: true,
            modal: false,
            content: '../pspc_chart_show.html?entityId='+entityId+'&entityCode='+entityCode+'&chartId='+chartId,
            close: function () { }
        }).data("kendoWindow");
        dialog.center().open();
    }

    /**
     * tab页切换事件
     * id:tab页下标
     */
    $('#mytab>li').click(function () {
        //如果当前tab页激活的，则不进行操作
        if($(this).hasClass("active")){
            return;
        }

        //切换tab页
        $(this).addClass("active");
        $(this).siblings('li').removeClass("active");
        //获得当前点击li的下标
        var gridId = $(this).data('gridid');
        //切换表格的数据源和列
        $('#'+gridId+'Div').siblings('div').css('height','0px');
        $('#'+gridId+'Div').removeAttr("style");

        if(!$('#ceGroup').val()){
            return;
        }
        // $('#'+gridId).data('kendoGrid').dataSource.read();
    });
    /**
     * 初始化表格，重新赋值数据源和列
     */
    function initGrid(id,dataSource,columns){
        grid = $("#"+id).kendoGrid({
            dataSource: dataSource,
            resizable: true,
            scrollable: true,
            navigatable: false,
            rownumber: true,
            autoBind:false,
            // selectable: 'multiple, rowbox',
            dataBound: function () {
                if (parent.autoResizeIframe) {
                    parent.autoResizeIframe('${RequestParameters.functionCode!}')
                }
            },
            pageable: {
                pageSizes: [5, 10, 20, 50],
                refresh: true,
                buttonCount: 5
            },
            columns: columns,
            editable: true,
            selectable: 'multiple, rowbox'
        }).data('kendoGrid');
    }

    function create8DReport () {
        var gridId = $('li.active').data('gridid');
        var rows = $('#'+gridId).data('kendoGrid').selectedDataItems();
        if(rows.length == 0){
            Hap.showToast({
                type:'error',  //1.success 2.error
                message: '请勾选数据',
                // showDuration:3000,//3秒后显示成功框
                hideDuration:3000 ,//展示3秒成功框
                "positionClass": "toast-bottom-right"
            });
            return;
        }
        $.ajax({
            type: "POST",
            url: BaseUrl+"/pspc/ooc/create/eightd/report",
            data:JSON.stringify(rows),//json序列化
            datatype:"json", //此处不能省略
            contentType: "application/json; charset=utf-8",
            success:function(data){
                var type;
                if(data.success){
                    type = 'success';
                }else{
                    type = 'error';
                }
                Hap.showToast({
                    type:type,  //1.success 2.error
                    message: data.message,
                    // showDuration:3000,//3秒后显示成功框
                    hideDuration:3000 ,//展示3秒成功框
                    "positionClass": "toast-bottom-right"
                });
            },
            error:function(data){
                console.log(data);
            }
        });
    }
</script>
</body>
</html>